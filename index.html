<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VCF Manager Pro | ××¢×¨×›×ª × ×™×”×•×œ ×× ×©×™ ×§×©×¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Heebo', sans-serif; }
        body { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); min-height: 100vh; }
        
        .glass-card { 
            background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255,255,255,0.8);
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
        }
        
        .stat-card {
            background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.1); }
        
        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            transition: all 0.3s ease;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4); }
        
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        
        .file-card { transition: all 0.3s ease; }
        .file-card:hover { transform: scale(1.02); }
        .file-card.selected { ring: 3px solid #6366f1; background: #eef2ff; }
        
        .tab-btn { transition: all 0.2s; }
        .tab-btn.active { background: #6366f1; color: white; }
        
        .table-row:hover { background: #f8fafc; }
        
        .progress-ring { transition: stroke-dashoffset 0.5s ease; }
        
        .fade-in { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .pulse-dot { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="text-slate-800">
    <!-- Header -->
    <header class="glass-card sticky top-0 z-50 px-6 py-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center text-white font-black text-xl shadow-lg">V</div>
                <div>
                    <h1 class="text-xl font-black text-slate-800">VCF Manager <span class="text-indigo-600">Pro</span></h1>
                    <p class="text-xs text-slate-400">××¢×¨×›×ª × ×™×”×•×œ ×× ×©×™ ×§×©×¨ ××ª×§×“××ª</p>
                </div>
            </div>
            <nav class="flex items-center gap-2">
                <button onclick="showView('dashboard')" class="tab-btn px-4 py-2 rounded-xl font-semibold text-slate-600 hover:bg-slate-100" data-view="dashboard">×“×©×‘×•×¨×“</button>
                <button onclick="showView('groups')" class="tab-btn px-4 py-2 rounded-xl font-semibold text-slate-600 hover:bg-slate-100" data-view="groups">×¨×©×™××•×ª</button>
                <button onclick="showView('files')" class="tab-btn px-4 py-2 rounded-xl font-semibold text-slate-600 hover:bg-slate-100" data-view="files">×§×‘×¦×™×</button>
                <button onclick="openSettingsModal()" class="tab-btn px-4 py-2 rounded-xl font-semibold text-slate-600 hover:bg-slate-100">âš™ï¸ ×”×’×“×¨×•×ª</button>
                <button onclick="document.getElementById('fileInput').click()" class="btn-primary px-6 py-2.5 rounded-xl font-bold shadow-lg">
                    <span class="flex items-center gap-2">ğŸ“ ×”×¢×œ××ª ×§×‘×¦×™×</span>
                </button>
                <input type="file" id="fileInput" multiple accept=".vcf,.csv" class="hidden" onchange="handleUpload(event)">
                
                <!-- User Menu -->
                <div class="relative mr-2">
                    <button onclick="toggleUserMenu()" class="flex items-center gap-2 px-3 py-2 rounded-xl hover:bg-slate-100 transition">
                        <div id="userAvatar" class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center">
                            <span class="text-indigo-600 font-bold text-sm" id="userInitial">?</span>
                        </div>
                        <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div id="userMenu" class="hidden absolute left-0 mt-2 w-48 bg-white rounded-xl shadow-xl border border-slate-100 py-2 z-50">
                        <div class="px-4 py-2 border-b border-slate-100">
                            <p class="text-sm font-bold text-slate-700" id="userEmail">×˜×•×¢×Ÿ...</p>
                        </div>
                        <a href="/logout" class="flex items-center gap-2 px-4 py-2 text-red-600 hover:bg-red-50 transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                            </svg>
                            ×™×¦×™××” ××”××¢×¨×›×ª
                        </a>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <!-- Upload Overlay -->
    <div id="uploadOverlay" class="hidden fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="glass-card rounded-3xl p-8 w-full max-w-2xl max-h-[90vh] overflow-auto">
            <h3 class="text-2xl font-black text-slate-800 mb-6 flex items-center gap-3">
                <span class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center">ğŸ“¤</span>
                ××¢×œ×” ×§×‘×¦×™×...
            </h3>
            <div id="uploadFilesList" class="space-y-3 mb-6"></div>
            <div class="bg-slate-100 rounded-2xl p-4">
                <div class="flex justify-between text-sm font-semibold text-slate-600 mb-2">
                    <span id="uploadTotalText">0 / 0 ×§×‘×¦×™×</span>
                    <span id="uploadTotalPercent">0%</span>
                </div>
                <div class="h-3 bg-slate-200 rounded-full overflow-hidden">
                    <div id="globalProgress" class="h-full bg-indigo-500 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-6 space-y-6">
        
        <!-- Dashboard View -->
        <section id="dashboard-view" class="space-y-6 fade-in">
            <div class="flex justify-between items-center">
                <h2 class="text-3xl font-black text-slate-800">×“×©×‘×•×¨×“</h2>
                <button onclick="loadDashboard()" class="text-indigo-600 font-semibold hover:underline">ğŸ”„ ×¨×¢× ×Ÿ</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4" id="statsCards">
                <div class="stat-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-4xl">ğŸ“‹</span>
                        <span class="text-3xl font-black text-indigo-600" id="stat-groups">0</span>
                    </div>
                    <p class="text-slate-600 font-semibold">×¨×©×™××•×ª ×¤×¢×™×œ×•×ª</p>
                </div>
                <div class="stat-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-4xl">ğŸ‘¥</span>
                        <span class="text-3xl font-black text-green-600" id="stat-contacts">0</span>
                    </div>
                    <p class="text-slate-600 font-semibold">×× ×©×™ ×§×©×¨</p>
                </div>
                <div class="stat-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-4xl">ğŸ“</span>
                        <span class="text-3xl font-black text-amber-600" id="stat-files">0</span>
                    </div>
                    <p class="text-slate-600 font-semibold">×§×‘×¦×™× ×××ª×™× ×™×</p>
                </div>
                <div class="stat-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-4xl">âœï¸</span>
                        <span class="text-3xl font-black text-purple-600" id="stat-drafts">0</span>
                    </div>
                    <p class="text-slate-600 font-semibold">×˜×™×•×˜×•×ª</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass-card rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-slate-800 mb-4">×¨×©×™××•×ª ××—×¨×•× ×•×ª</h3>
                    <div id="recentGroups" class="space-y-3"></div>
                </div>
                <div class="glass-card rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-slate-800 mb-4">×§×‘×¦×™× ×××ª×™× ×™×</h3>
                    <div id="pendingFiles" class="space-y-3"></div>
                </div>
            </div>
        </section>

        <!-- Groups View -->
        <section id="groups-view" class="hidden space-y-6 fade-in">
            <div class="flex justify-between items-center">
                <h2 class="text-3xl font-black text-slate-800">×¨×©×™××•×ª ×× ×©×™ ×§×©×¨</h2>
            </div>
            <div id="groupsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <!-- Files View -->
        <section id="files-view" class="hidden space-y-6 fade-in">
            <div class="flex justify-between items-center">
                <h2 class="text-3xl font-black text-slate-800">×§×‘×¦×™× ×œ×”×¢×œ××”</h2>
                <button onclick="startProcessing()" id="processBtn" class="btn-primary px-6 py-3 rounded-xl font-bold shadow-lg hidden">
                    âš¡ ×¢×‘×“ ×§×‘×¦×™× × ×‘×—×¨×™× (<span id="selectedCount">0</span>)
                </button>
            </div>
            
            <div class="glass-card rounded-2xl p-6">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <input type="text" id="targetGroupName" placeholder="×©× ×”×¨×©×™××” ×”×—×“×©×”..." class="col-span-2 px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <input type="text" id="defaultName" placeholder="×©× ×‘×¨×™×¨×ª ××—×“×œ ×œ××™×© ×§×©×¨..." class="px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <input type="number" id="startSerial" value="1" placeholder="××¡×¤×¨ ×”×ª×—×œ×ª×™" class="px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div class="flex items-center gap-6 text-sm text-slate-600">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="allowShortPhones" class="w-4 h-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500">
                        <span>××¤×©×¨ ××¡×¤×¨×™× ×§×¦×¨×™×</span>
                        <span class="text-slate-400 text-xs">(××¨×’×•× ×™×, ×¡×™×¡×××•×ª ×•×›×•')</span>
                    </label>
                </div>
            </div>
            
            <div id="filesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </section>

        <!-- Analysis View -->
        <section id="analysis-view" class="hidden space-y-6 fade-in">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-3xl font-black text-slate-800" id="analysisTitle">× ×™×ª×•×— × ×ª×•× ×™×</h2>
                    <p class="text-slate-500" id="analysisSummary"></p>
                </div>
                <div class="flex gap-3">
                    <button onclick="openSettingsModal()" class="px-6 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-bold">
                        âš™ï¸ ×”×’×“×¨×•×ª
                    </button>
                    <button onclick="finalizeGroup()" class="btn-success px-8 py-3 rounded-xl font-bold shadow-lg">
                        âœ… ×©××•×¨ ×•×¡×™×™×
                    </button>
                </div>
            </div>
            
            <!-- Stats Summary -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4" id="analysisStats"></div>
            
            <!-- Tabs -->
            <div class="glass-card rounded-2xl overflow-hidden">
                <div class="flex border-b border-slate-200">
                    <button onclick="showAnalysisTab('accepted')" class="analysis-tab flex-1 px-6 py-4 font-semibold text-slate-600 hover:bg-slate-50 border-b-2 border-transparent" data-tab="accepted">
                        âœ… ××•×©×¨×• (<span id="acceptedCount">0</span>)
                    </button>
                    <button onclick="showAnalysisTab('rejected')" class="analysis-tab flex-1 px-6 py-4 font-semibold text-slate-600 hover:bg-slate-50 border-b-2 border-transparent" data-tab="rejected">
                        âŒ × ×“×—×• (<span id="rejectedCount">0</span>)
                    </button>
                    <button onclick="showAnalysisTab('conflicts')" class="analysis-tab flex-1 px-6 py-4 font-semibold text-slate-600 hover:bg-slate-50 border-b-2 border-transparent" data-tab="conflicts">
                        âš ï¸ ×§×•× ×¤×œ×™×§×˜×™× (<span id="conflictsCount">0</span>)
                    </button>
                    <button onclick="showAnalysisTab('duplicates')" class="analysis-tab flex-1 px-6 py-4 font-semibold text-slate-600 hover:bg-slate-50 border-b-2 border-transparent" data-tab="duplicates">
                        ğŸ”„ ×›×¤×™×œ×•×™×•×ª (<span id="duplicatesCount">0</span>)
                    </button>
                </div>
                
                <div id="analysisContent" class="p-6 max-h-[60vh] overflow-auto"></div>
            </div>
        </section>

        <!-- Group Detail View -->
        <section id="group-view" class="hidden space-y-6 fade-in">
            <div class="flex justify-between items-center">
                <div>
                    <button onclick="showView('groups')" class="text-indigo-600 font-semibold mb-2 hover:underline">â† ×—×–×¨×” ×œ×¨×©×™××•×ª</button>
                    <h2 class="text-3xl font-black text-slate-800" id="groupTitle"></h2>
                    <p class="text-slate-500" id="groupInfo"></p>
                </div>
                <div class="flex gap-3 flex-wrap">
                    <button onclick="revertToDraft()" class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-xl font-semibold">ğŸ“ ×—×–×•×¨ ×œ×¢×¨×™×›×”</button>
                    <button onclick="addFilesToGroup()" class="btn-primary px-4 py-2 rounded-xl font-semibold">â• ×”×•×¡×£ ×§×‘×¦×™×</button>
                    <button onclick="checkDuplicates()" class="btn-warning px-4 py-2 rounded-xl font-semibold">ğŸ” ×‘×“×•×§ ×›×¤×™×œ×•×™×•×ª</button>
                    <button onclick="shareGroup()" class="px-4 py-2 rounded-xl font-semibold bg-green-100 text-green-700 hover:bg-green-200">ğŸ”— ×©×ª×£</button>
                    <button onclick="saveVersion()" class="px-4 py-2 rounded-xl font-semibold bg-slate-100 hover:bg-slate-200">ğŸ’¾ ×©××•×¨ ×’×¨×¡×”</button>
                    <button onclick="exportGroup('csv')" class="px-4 py-2 rounded-xl font-semibold bg-slate-100 hover:bg-slate-200">ğŸ“Š CSV</button>
                    <button onclick="exportGroup('vcf')" class="px-4 py-2 rounded-xl font-semibold bg-slate-100 hover:bg-slate-200">ğŸ“‡ VCF</button>
                </div>
            </div>
            
            <!-- Versions -->
            <div class="glass-card rounded-2xl p-4">
                <div class="flex items-center gap-4 overflow-x-auto pb-2">
                    <span class="text-slate-500 font-semibold whitespace-nowrap">×’×¨×¡××•×ª:</span>
                    <div id="versionsList" class="flex gap-2"></div>
                </div>
            </div>
            
            <!-- Search & Contacts -->
            <div class="glass-card rounded-2xl p-6">
                <div class="flex flex-wrap gap-4 mb-6">
                    <input type="text" id="contactSearch" placeholder="ğŸ” ×—×™×¤×•×© ×œ×¤×™ ×©× ××• ×˜×œ×¤×•×Ÿ..." class="flex-1 px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none" oninput="searchContacts()">
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-slate-500">××™×•×Ÿ:</span>
                        <button onclick="setContactSort('name')" id="sortNameBtn" class="px-3 py-2 rounded-lg text-sm font-medium bg-indigo-600 text-white">×©×</button>
                        <button onclick="setContactSort('phone')" id="sortPhoneBtn" class="px-3 py-2 rounded-lg text-sm font-medium bg-slate-100 hover:bg-slate-200">×˜×œ×¤×•×Ÿ</button>
                        <button onclick="setContactSort('source')" id="sortSourceBtn" class="px-3 py-2 rounded-lg text-sm font-medium bg-slate-100 hover:bg-slate-200">××§×•×¨</button>
                        <button onclick="toggleSortDir()" id="sortDirBtn" class="px-3 py-2 rounded-lg text-sm font-medium bg-slate-100 hover:bg-slate-200" title="×”×¤×•×š ×›×™×•×•×Ÿ">â–²</button>
                    </div>
                </div>
                <div id="contactsTable" class="overflow-x-auto max-h-[60vh] overflow-y-auto">
                    <table class="w-full">
                        <thead class="bg-slate-50 text-slate-600 sticky top-0">
                            <tr>
                                <th class="px-4 py-3 text-right font-semibold rounded-tr-xl cursor-pointer hover:bg-slate-100" onclick="setContactSort('name')">×©×</th>
                                <th class="px-4 py-3 text-right font-semibold cursor-pointer hover:bg-slate-100" onclick="setContactSort('phone')">×˜×œ×¤×•×Ÿ</th>
                                <th class="px-4 py-3 text-right font-semibold">××™××™×™×œ</th>
                                <th class="px-4 py-3 text-right font-semibold cursor-pointer hover:bg-slate-100" onclick="setContactSort('source')">××§×•×¨</th>
                                <th class="px-4 py-3 text-center font-semibold rounded-tl-xl w-24">×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody id="contactsBody"></tbody>
                    </table>
                </div>
                <div id="pagination" class="flex justify-center gap-2 mt-4"></div>
            </div>
        </section>

    </main>
    
    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="glass-card rounded-3xl p-8 w-full max-w-4xl max-h-[90vh] overflow-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black text-slate-800">âš™ï¸ ×”×’×“×¨×•×ª ××¢×¨×›×ª</h2>
                <button onclick="closeSettingsModal()" class="text-3xl text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            
            <!-- ×›×œ×œ×™ ×‘×—×™×¨×ª ×©××•×ª -->
            <div class="mb-8">
                <h3 class="text-xl font-bold text-slate-700 mb-4">ğŸ¯ ×›×œ×œ×™ ×‘×—×™×¨×ª ×©××•×ª ××•×˜×•××˜×™×ª</h3>
                <p class="text-slate-500 mb-4">×”×’×“×¨ ×›×™×¦×“ ×”××¢×¨×›×ª ×ª×‘×—×¨ ××•×˜×•××˜×™×ª ××ª ×”×©× ×”×˜×•×‘ ×‘×™×•×ª×¨ ×›×©×™×© ×›×¤×™×œ×•×™×•×ª</p>
                
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4" id="nameRulesForm">
                    <label class="flex items-center gap-3 p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                        <input type="checkbox" id="rule-preferLonger" checked class="w-5 h-5 accent-indigo-600">
                        <span>×”×¢×“×£ ×©× ××¨×•×š ×™×•×ª×¨</span>
                    </label>
                    <label class="flex items-center gap-3 p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                        <input type="checkbox" id="rule-preferHebrew" checked class="w-5 h-5 accent-indigo-600">
                        <span>×”×¢×“×£ ×¢×‘×¨×™×ª</span>
                    </label>
                    <label class="flex items-center gap-3 p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                        <input type="checkbox" id="rule-avoidSpecialChars" checked class="w-5 h-5 accent-indigo-600">
                        <span>×”×™×× ×¢ ××¡×™×× ×™× ××™×•×—×“×™×</span>
                    </label>
                    <label class="flex items-center gap-3 p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                        <input type="checkbox" id="rule-preferNoNumbers" checked class="w-5 h-5 accent-indigo-600">
                        <span>×”×¢×“×£ ×©××•×ª ×‘×œ×™ ××¡×¤×¨×™×</span>
                    </label>
                    <div class="flex items-center gap-3 p-4 bg-slate-50 rounded-xl">
                        <span>××•×¨×š ××™× ×™××œ×™:</span>
                        <input type="number" id="rule-minLength" value="2" min="0" class="w-20 px-3 py-2 rounded-lg border border-slate-200">
                        <span class="text-xs text-slate-400">(××•×ª×™×•×ª ×‘×œ×‘×“)</span>
                    </div>
                    <div class="flex items-center gap-3 p-4 bg-slate-50 rounded-xl">
                        <span>××•×¨×š ××§×¡×™××œ×™:</span>
                        <input type="number" id="rule-maxLength" value="20" class="w-20 px-3 py-2 rounded-lg border border-slate-200">
                    </div>
                    <div class="flex items-center gap-3 p-4 bg-slate-50 rounded-xl col-span-2 md:col-span-3">
                        <span>×¤×•×¨××˜ ××¡×¤×•×¨ ×›×¤×™×œ×•×™×•×ª:</span>
                        <select id="rule-duplicateSuffix" class="px-3 py-2 rounded-lg border border-slate-200">
                            <option value="({n})">××™×œ×” (1), ××™×œ×” (2)</option>
                            <option value="- {n}">××™×œ×” - 1, ××™×œ×” - 2</option>
                            <option value="_{n}">××™×œ×”_1, ××™×œ×”_2</option>
                            <option value="{n}">××™×œ×” 1, ××™×œ×” 2</option>
                        </select>
                        <span class="text-xs text-slate-400">(×›××©×¨ ×™×© ×©××•×ª ×–×”×™×)</span>
                    </div>
                </div>
                
                <p class="text-sm text-slate-500 mt-2">ğŸ’¡ ××•×¨×š ××™× ×™××œ×™ ×¡×•×¤×¨ ×¨×§ ××•×ª×™×•×ª (×¢×‘×¨×™×ª/×× ×’×œ×™×ª), ×œ× × ×§×•×“×•×ª, ×’×¨×©×™×™× ××• ××™××•×’'×™×</p>
            </div>
            
            <!-- ×©××•×ª ×œ× ×ª×§×™× ×™× -->
            <div class="mb-8">
                <h3 class="text-xl font-bold text-slate-700 mb-4">ğŸš« ×©××•×ª ×œ× ×ª×§×™× ×™× (Blacklist)</h3>
                <p class="text-slate-500 mb-4">×©××•×ª ××œ×• ×™×•×—×œ×¤×• ××•×˜×•××˜×™×ª ×‘×©× ×‘×¨×™×¨×ª ××—×“×œ</p>
                
                <div class="flex gap-3 mb-4">
                    <input type="text" id="newInvalidName" placeholder="×”×–×Ÿ ×©× ×œ× ×ª×§×™×Ÿ..." class="flex-1 px-4 py-3 rounded-xl border border-slate-200">
                    <select id="newInvalidPattern" class="px-4 py-3 rounded-xl border border-slate-200">
                        <option value="exact">×”×ª×××” ××“×•×™×§×ª</option>
                        <option value="contains">××›×™×œ</option>
                        <option value="regex">×‘×™×˜×•×™ ×¨×’×•×œ×¨×™</option>
                    </select>
                    <button onclick="addInvalidName()" class="btn-primary px-6 py-3 rounded-xl font-bold">â• ×”×•×¡×£</button>
                </div>
                
                <div id="invalidNamesList" class="grid grid-cols-2 md:grid-cols-4 gap-2 max-h-40 overflow-auto"></div>
            </div>
            
            <!-- ×›×œ×œ×™ × ×™×§×•×™ ×©××•×ª -->
            <div class="mb-6">
                <h3 class="text-xl font-bold text-slate-700 mb-4">ğŸ§¹ ×›×œ×œ×™ × ×™×§×•×™ ×©××•×ª</h3>
                <p class="text-slate-500 mb-4">×›×œ×œ×™× ××•×˜×•××˜×™×™× ×œ× ×™×§×•×™ ×•×¡×™×“×•×¨ ×©××•×ª ×‘×¢×ª ×”×™×™×‘×•×</p>
                
                <div id="cleaningRulesList" class="space-y-2 mb-4 max-h-48 overflow-auto"></div>
                
                <div class="border-t border-slate-200 pt-4 mt-4">
                    <h4 class="font-semibold text-slate-600 mb-3">â• ×”×•×¡×£ ×›×œ×œ ×—×“×©</h4>
                    <div class="flex flex-wrap gap-3">
                        <select id="newRuleType" class="px-4 py-3 rounded-xl border border-slate-200" onchange="updateRuleInputs()">
                            <option value="trim_start">×”×¡×¨ ××ª×—×™×œ×ª ×”×©×</option>
                            <option value="trim_end">×”×¡×¨ ××¡×•×£ ×”×©×</option>
                            <option value="replace">×”×—×œ×£ ×˜×§×¡×˜</option>
                            <option value="regex">×‘×™×˜×•×™ ×¨×’×•×œ×¨×™</option>
                            <option value="remove_special">×”×¡×¨ ×ª×•×•×™× ××™×•×—×“×™×/××™××•×’'×™×</option>
                        </select>
                        <input type="text" id="newRulePattern" placeholder="×ª×•/×˜×§×¡×˜ ×œ×”×¡×¨×”..." class="px-4 py-3 rounded-xl border border-slate-200 flex-1">
                        <input type="text" id="newRuleReplacement" placeholder="×œ×”×—×œ×™×£ ×‘..." class="px-4 py-3 rounded-xl border border-slate-200 hidden">
                        <input type="text" id="newRuleDesc" placeholder="×ª×™××•×¨ ×”×›×œ×œ..." class="px-4 py-3 rounded-xl border border-slate-200 w-48">
                        <button onclick="addCleaningRule()" class="btn-primary px-6 py-3 rounded-xl font-bold">â• ×”×•×¡×£</button>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-between items-center pt-4 border-t border-slate-200">
                <p class="text-sm text-slate-500">ğŸ’¡ ×”×©×™× ×•×™×™× ×™×•×—×œ×• ××™×“ ×¢×œ ×”×˜×™×•×˜×” ×”×¤×ª×•×—×”</p>
                <div class="flex gap-3">
                    <button onclick="closeSettingsModal()" class="px-6 py-3 rounded-xl font-semibold bg-slate-100 hover:bg-slate-200">×¡×’×•×¨</button>
                    <button onclick="saveAllSettingsAndApply()" class="btn-primary px-6 py-3 rounded-xl font-bold">ğŸ’¾ ×©××•×¨ ×•×”×—×œ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Merge Contacts Modal -->
    <div id="mergeModal" class="hidden fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="glass-card rounded-3xl p-8 w-full max-w-4xl max-h-[90vh] overflow-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black text-slate-800">â• ××™×—×•×“ ×× ×©×™ ×§×©×¨</h3>
                <button onclick="closeMergeModal()" class="text-3xl text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            
            <!-- ××™×© ×”×§×©×¨ ×”× ×•×›×—×™ -->
            <div class="mb-6 p-4 bg-indigo-50 rounded-xl border-2 border-indigo-200">
                <p class="text-sm text-indigo-600 font-semibold mb-2">××™×© ×§×©×¨ × ×•×›×—×™:</p>
                <div class="flex items-center gap-4">
                    <span class="text-xl font-bold" id="mergeCurrentName"></span>
                    <span class="font-mono text-slate-600" id="mergeCurrentPhone"></span>
                </div>
            </div>
            
            <!-- ×× ×©×™ ×§×©×¨ ×©× ×‘×—×¨×• ×œ××™×—×•×“ -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-2">
                    <p class="text-sm text-slate-600 font-semibold">××¡×¤×¨×™ ×˜×œ×¤×•×Ÿ ×œ××™×—×•×“:</p>
                    <button onclick="manageCustomLabels()" class="text-xs text-slate-400 hover:text-slate-600">âš™ï¸ × ×™×”×•×œ ×ª×•×•×™×•×ª</button>
                </div>
                <div id="mergeSelectedContacts" class="space-y-2 max-h-40 overflow-auto"></div>
            </div>
            
            <!-- ×—×™×¤×•×© -->
            <div class="mb-4">
                <input type="text" id="mergeSearch" placeholder="×—×¤×© ×œ×¤×™ ×©× ××• ×˜×œ×¤×•×Ÿ..." 
                       class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none"
                       oninput="filterMergeContacts(this.value)">
            </div>
            
            <!-- ×¨×©×™××ª ×× ×©×™ ×§×©×¨ ×“×•××™× -->
            <div class="mb-6">
                <p class="text-sm text-slate-600 font-semibold mb-2">×× ×©×™ ×§×©×¨ ×“×•××™× (×œ×—×¥ ×œ×”×•×¡×¤×”):</p>
                <div id="mergeSimilarContacts" class="space-y-1 max-h-48 overflow-auto"></div>
            </div>
            
            <!-- ×‘×—×™×¨×ª ×©× ×¡×•×¤×™ -->
            <div class="mb-6 p-4 bg-slate-50 rounded-xl">
                <p class="text-sm text-slate-600 font-semibold mb-2">×©× ×¡×•×¤×™ ×œ××™×© ×”×§×©×¨ ×”×××•×—×“:</p>
                <div id="mergeNameOptions" class="flex flex-wrap gap-2 mb-3"></div>
                <input type="text" id="mergeFinalName" placeholder="××• ×”×§×œ×“ ×©× ×—×“×©..." 
                       class="w-full px-4 py-2 rounded-lg border border-slate-200">
            </div>
            
            <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
                <button onclick="closeMergeModal()" class="px-6 py-3 rounded-xl font-semibold bg-slate-100 hover:bg-slate-200">×‘×™×˜×•×œ</button>
                <button onclick="performMerge()" class="btn-primary px-6 py-3 rounded-xl font-bold">ğŸ”— ××—×“ ×× ×©×™ ×§×©×¨</button>
            </div>
        </div>
    </div>

    <!-- Mapping Modal -->
    <div id="mappingModal" class="hidden fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="glass-card rounded-3xl p-8 w-full max-w-4xl max-h-[90vh] overflow-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black text-slate-800" id="mappingTitle">×”×’×“×¨×ª ××™×¤×•×™</h3>
                <button onclick="closeMapping()" class="text-3xl text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            <div id="mappingContent"></div>
            <div class="flex justify-end gap-3 mt-6 pt-6 border-t">
                <button onclick="closeMapping()" class="px-6 py-3 rounded-xl font-semibold bg-slate-100 hover:bg-slate-200">×‘×™×˜×•×œ</button>
                <button onclick="saveMapping()" class="btn-primary px-6 py-3 rounded-xl font-bold">×©××•×¨ ××™×¤×•×™</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== STATE ====================
        let state = {
            files: [],
            groups: [],
            selectedFiles: [],
            mappings: {},
            fileSamples: {},
            currentGroupId: null,
            analysisData: null,
            currentPage: 1,
            analysisPage: 1,
            rejectedPage: 1,
            filterRejectedReason: '',
            addToGroupAfterUpload: null,
            // ××™×•×Ÿ ×•×¡×™× ×•×Ÿ - ×˜×™×•×˜×”
            sortBy: 'name', // index, name, phone
            sortDir: 'asc',  // asc, desc
            filterSource: '', // ×¡×™× ×•×Ÿ ×œ×¤×™ ××§×•×¨
            // ××™×•×Ÿ - ×¨×©×™××” ×¡×•×¤×™×ª
            contactSortBy: 'name',
            contactSortDir: 'asc',
            // ××™×—×•×“ ×× ×©×™ ×§×©×¨
            mergeSourceIndex: null,
            mergeSelectedIndexes: [],
            mergePhoneLabels: {}, // { phone: 'label' }
            customPhoneLabels: JSON.parse(localStorage.getItem('customPhoneLabels') || '[]') // ×ª×•×•×™×•×ª ××•×ª×××•×ª ××™×©×™×ª
        };
        
        // ×¤×•× ×§×¦×™×” ×œ×—×™×œ×•×¥ ×©× ×‘×¡×™×¡×™ (×‘×œ×™ (1), (2) ×•×›×•')
        function getBaseName(name) {
            if (!name) return '';
            let base = name.toString().replace(/\s?\(\d+\)$/g, '').trim();
            base = base.replace(/\s+\d+$/g, '').trim();
            return base;
        }
        
        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2500, timerProgressBar: true });

        // API helper with auth handling
        async function api(url, options = {}) {
            const res = await fetch(url, options);
            if (res.status === 401) {
                window.location.href = '/login';
                throw new Error('Session expired');
            }
            return res.json();
        }

        // ==================== VIEWS ====================
        function showView(view) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById(view + '-view').classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.tab-btn[data-view="${view}"]`)?.classList.add('active');
            
            if (view === 'dashboard') loadDashboard();
            else if (view === 'groups') loadGroups();
            else if (view === 'files') loadFiles();
        }
        
        // ==================== SETTINGS MODAL ====================
        async function openSettingsModal() {
            document.getElementById('settingsModal').classList.remove('hidden');
            await loadSettings();
        }
        
        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.add('hidden');
        }
        
        async function saveAllSettingsAndApply() {
            // ×× ×™×© ×˜×™×•×˜×” ×¤×ª×•×—×”, ×”×—×œ ××ª ×”×”×’×“×¨×•×ª ××™×™×“×™×ª
            if (state.analysisData && state.currentGroupId) {
                closeSettingsModal();
                
                const totalContacts = state.analysisData.allData?.length || 0;
                
                // ×”×¦×’ ×—×œ×•×Ÿ ×”×ª×§×“××•×ª
                Swal.fire({
                    title: 'â³ ××—×™×œ ×”×’×“×¨×•×ª...',
                    html: `
                        <div class="text-right">
                            <p id="settingsProgressText" class="mb-3 text-slate-600">×©×•××¨ ×”×’×“×¨×•×ª...</p>
                            <div class="w-full bg-slate-200 rounded-full h-4 mb-2">
                                <div id="settingsProgressBar" class="bg-indigo-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <p id="settingsProgressPercent" class="text-sm text-slate-500">0%</p>
                        </div>
                    `,
                    allowOutsideClick: false,
                    showConfirmButton: false
                });
                
                const updateProgress = (percent, text) => {
                    document.getElementById('settingsProgressBar').style.width = percent + '%';
                    document.getElementById('settingsProgressPercent').textContent = percent + '%';
                    if (text) document.getElementById('settingsProgressText').textContent = text;
                };
                
                try {
                    // ×©×œ×‘ 1: ×©××•×¨ ×”×’×“×¨×•×ª (20%)
                    updateProgress(10, '×©×•××¨ ×›×œ×œ×™ ×©××•×ª...');
                    await saveNameRules();
                    updateProgress(20, '×”×”×’×“×¨×•×ª × ×©××¨×•');
                    
                    // ×©×œ×‘ 2: ×˜×¢×™× ×” ××—×“×© (20-90%)
                    updateProgress(30, `××¢×‘×“ ${totalContacts.toLocaleString()} ×× ×©×™ ×§×©×¨...`);
                    
                    // ×˜×¢×Ÿ ××—×“×© ××ª ×”×˜×™×•×˜×” ×¢× ×”×”×’×“×¨×•×ª ×”×—×“×©×•×ª
                    await reloadDraftWithNewSettings();
                    
                    updateProgress(100, '×”×•×©×œ×!');
                    
                    await new Promise(r => setTimeout(r, 300));
                    Swal.fire({ icon: 'success', title: '×”×”×’×“×¨×•×ª ×”×•×—×œ×•!', timer: 1500 });
                } catch (err) {
                    Swal.fire({ icon: 'error', title: '×©×’×™××”', text: err.message });
                }
            } else {
                // ××™×Ÿ ×˜×™×•×˜×” ×¤×ª×•×—×” - ×¨×§ ×©××•×¨ ×”×’×“×¨×•×ª
                await saveNameRules();
                closeSettingsModal();
                Toast.fire({ icon: 'success', title: '×”×”×’×“×¨×•×ª × ×©××¨×•' });
            }
        }
        
        async function reloadDraftWithNewSettings() {
            if (!state.analysisData || !state.currentGroupId) return;
            
            try {
                // ×©×œ×— ×‘×§×©×” ×œ×˜×¢×™× ×” ××—×“×© ×©×œ ×”×˜×™×•×˜×” ×¢× ×”×”×’×“×¨×•×ª ×”×—×“×©×•×ª
                const data = await api('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        groupId: state.currentGroupId
                    })
                });
                
                state.analysisData = data;
                state.currentGroupId = data.groupId;
                renderStats();
                showAnalysisTab('accepted');
            } catch (err) {
                console.error('Error reloading draft:', err);
                Swal.fire({ icon: 'error', title: '×©×’×™××”', text: err.message });
            }
        }

        // ==================== DASHBOARD ====================
        async function loadDashboard() {
            try {
                const [stats, groups, files] = await Promise.all([
                    api('/api/dashboard-stats'),
                    api('/api/groups'),
                    api('/api/files')
                ]);
                
                if (!Array.isArray(groups)) throw new Error('Invalid groups data');
                if (!Array.isArray(files)) throw new Error('Invalid files data');
                
                document.getElementById('stat-groups').textContent = stats.groups?.ready || 0;
                document.getElementById('stat-contacts').textContent = Number(stats.contacts?.total || 0).toLocaleString();
                document.getElementById('stat-files').textContent = stats.files?.pending || 0;
                document.getElementById('stat-drafts').textContent = stats.groups?.draft || 0;
                
                // Recent groups
                document.getElementById('recentGroups').innerHTML = groups.slice(0, 5).map(g => `
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100" 
                         onclick="${g.status === 'draft' ? `resumeDraft(${g.id})` : `viewGroup(${g.id})`}">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${g.status === 'draft' ? 'ğŸ“' : 'ğŸ“‹'}</span>
                            <div>
                                <p class="font-semibold text-slate-800">${g.name}</p>
                                <p class="text-xs text-slate-500">${g.count || 0} ×× ×©×™ ×§×©×¨</p>
                            </div>
                        </div>
                        ${g.status === 'draft' ? '<span class="px-2 py-1 bg-amber-100 text-amber-700 text-xs rounded-lg font-semibold">×˜×™×•×˜×”</span>' : ''}
                    </div>
                `).join('') || '<p class="text-slate-400 text-center py-4">××™×Ÿ ×¨×©×™××•×ª ×¢×“×™×™×Ÿ</p>';
                
                // Pending files
                document.getElementById('pendingFiles').innerHTML = files.slice(0, 5).map(f => `
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">ğŸ“„</span>
                            <div>
                                <p class="font-semibold text-slate-800 truncate max-w-[200px]">${f.original_name}</p>
                                <p class="text-xs text-slate-500">${f.parsed_count || 0} × ×§×¨××• â€¢ ${f.valid_count || 0} ×ª×§×™× ×™×</p>
                            </div>
                        </div>
                    </div>
                `).join('') || '<p class="text-slate-400 text-center py-4">××™×Ÿ ×§×‘×¦×™× ×××ª×™× ×™×</p>';
                
            } catch (err) {
                console.error('Dashboard error:', err);
            }
        }

        // ==================== GROUPS ====================
        async function loadGroups() {
            try {
                const groups = await api('/api/groups');
                if (!Array.isArray(groups)) throw new Error('Invalid data');
                state.groups = groups;
                
                document.getElementById('groupsList').innerHTML = groups.map(g => `
                    <div class="glass-card rounded-2xl p-6 cursor-pointer file-card ${g.status === 'draft' ? 'border-2 border-dashed border-amber-400' : ''}" 
                         onclick="${g.status === 'draft' ? `resumeDraft(${g.id})` : `viewGroup(${g.id})`}">
                        <div class="flex justify-between items-start mb-4">
                            <span class="text-4xl">${g.status === 'draft' ? 'ğŸ“' : 'ğŸ“‹'}</span>
                            ${g.status === 'draft' ? '<span class="px-3 py-1 bg-amber-100 text-amber-700 text-sm rounded-lg font-semibold pulse-dot">×˜×™×•×˜×”</span>' : ''}
                        </div>
                        <h3 class="text-xl font-bold text-slate-800 mb-2">${g.name}</h3>
                        <p class="text-3xl font-black text-indigo-600 mb-1">${(g.count || 0).toLocaleString()}</p>
                        <p class="text-slate-500 text-sm">×× ×©×™ ×§×©×¨</p>
                        <div class="flex justify-between items-center mt-4 pt-4 border-t border-slate-100">
                            <span class="text-xs text-slate-400">${g.updated_at_formatted || g.created_at_formatted || ''}</span>
                            <button onclick="event.stopPropagation(); deleteGroup(${g.id})" class="text-red-400 hover:text-red-600 text-sm">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `).join('') || '<p class="text-slate-400 text-center py-8 col-span-3">××™×Ÿ ×¨×©×™××•×ª ×¢×“×™×™×Ÿ. ×”×¢×œ×” ×§×‘×¦×™× ×›×“×™ ×œ×”×ª×—×™×œ.</p>';
                
            } catch (err) {
                console.error('Groups error:', err);
            }
        }

        async function viewGroup(id) {
            try {
                state.currentGroupId = id;
                state.currentPage = 1;
                
                const [group, versions] = await Promise.all([
                    api(`/api/groups/${id}`),
                    api(`/api/groups/${id}/versions`)
                ]);
                
                document.getElementById('groupTitle').textContent = group.name;
                document.getElementById('groupInfo').textContent = `${group.contacts?.length || 0} ×× ×©×™ ×§×©×¨ â€¢ ×’×¨×¡×” ${group.version || 1}`;
                
                // Versions
                document.getElementById('versionsList').innerHTML = versions.map(v => `
                    <button onclick="restoreVersion(${v.id})" class="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm font-medium whitespace-nowrap">
                        v${v.version_number} - ${v.version_name || ''} (${v.contacts_count || 0})
                    </button>
                `).join('') || '<span class="text-slate-400 text-sm">××™×Ÿ ×’×¨×¡××•×ª ×§×•×“××•×ª</span>';
                
                loadContacts();
                showView('group');
            } catch (err) {
                console.error('View group error:', err);
                Toast.fire({ icon: 'error', title: '×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¨×©×™××”' });
            }
        }

        async function loadContacts() {
            const search = document.getElementById('contactSearch')?.value || '';
            try {
                const data = await api(`/api/groups/${state.currentGroupId}/contacts?search=${encodeURIComponent(search)}&page=${state.currentPage}&limit=50&sortBy=${state.contactSortBy}&sortDir=${state.contactSortDir}`);
                
                document.getElementById('contactsBody').innerHTML = data.contacts.map(c => `
                    <tr class="table-row border-b border-slate-100" id="contact-row-${c.id}">
                        <td class="px-4 py-2">
                            <input type="text" 
                                   value="${c.full_name.replace(/"/g, '&quot;')}" 
                                   class="w-full px-2 py-1 rounded border border-transparent hover:border-slate-300 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none font-medium bg-transparent"
                                   onchange="updateContactName(${c.id}, this.value)"
                                   onkeydown="if(event.key==='Enter') this.blur()">
                        </td>
                        <td class="px-4 py-3 text-slate-600 font-mono">${c.phone}</td>
                        <td class="px-4 py-3 text-slate-500">${c.email || '-'}</td>
                        <td class="px-4 py-3 text-slate-400 text-sm">${c.source_file_name || '-'}</td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="clearContactName(${c.id})" class="text-red-400 hover:text-red-600 text-sm" title="××—×§ ×©×">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="5" class="text-center py-8 text-slate-400">×œ× × ××¦××• ×× ×©×™ ×§×©×¨</td></tr>';
                
                // Pagination
                const totalPages = Math.ceil(data.total / data.limit);
                let paginationHtml = '';
                for (let i = 1; i <= totalPages && i <= 10; i++) {
                    paginationHtml += `<button onclick="goToPage(${i})" class="px-3 py-1 rounded-lg ${i === state.currentPage ? 'bg-indigo-600 text-white' : 'bg-slate-100 hover:bg-slate-200'}">${i}</button>`;
                }
                document.getElementById('pagination').innerHTML = paginationHtml;
                
            } catch (err) {
                console.error('Load contacts error:', err);
            }
        }

        function goToPage(page) {
            state.currentPage = page;
            loadContacts();
        }

        function searchContacts() {
            state.currentPage = 1;
            loadContacts();
        }

        function setContactSort(field) {
            if (state.contactSortBy === field) {
                state.contactSortDir = state.contactSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                state.contactSortBy = field;
                state.contactSortDir = 'asc';
            }
            updateContactSortButtons();
            state.currentPage = 1;
            loadContacts();
        }

        function toggleSortDir() {
            state.contactSortDir = state.contactSortDir === 'asc' ? 'desc' : 'asc';
            updateContactSortButtons();
            state.currentPage = 1;
            loadContacts();
        }

        function updateContactSortButtons() {
            ['name', 'phone', 'source'].forEach(field => {
                const btn = document.getElementById(`sort${field.charAt(0).toUpperCase() + field.slice(1)}Btn`);
                if (btn) {
                    btn.className = state.contactSortBy === field 
                        ? 'px-3 py-2 rounded-lg text-sm font-medium bg-indigo-600 text-white'
                        : 'px-3 py-2 rounded-lg text-sm font-medium bg-slate-100 hover:bg-slate-200';
                }
            });
            const dirBtn = document.getElementById('sortDirBtn');
            if (dirBtn) dirBtn.textContent = state.contactSortDir === 'asc' ? 'â–²' : 'â–¼';
        }

        async function updateContactName(id, newName) {
            if (!newName || !newName.trim()) {
                // ×©× ×¨×™×§ - ×§×¨× ×œ-clear ×©×’× ××•×¡×™×£ ×œ×¨×©×™××” ×©×—×•×¨×”
                await clearContactName(id);
                return;
            }
            
            try {
                await api(`/api/contacts/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ full_name: newName.trim() })
                });
                Toast.fire({ icon: 'success', title: '×”×©× ×¢×•×“×›×Ÿ' });
            } catch (err) {
                Toast.fire({ icon: 'error', title: '×©×’×™××” ×‘×¢×“×›×•×Ÿ' });
                loadContacts(); // reload to show original
            }
        }

        async function clearContactName(id) {
            try {
                const data = await api(`/api/contacts/${id}/clear`, { method: 'POST' });
                
                let msg = '×”×©× ×”×•×—×œ×£';
                if (data.updatedCount > 1) {
                    msg = `${data.updatedCount} ×× ×©×™ ×§×©×¨ ×¢×•×“×›× ×•`;
                }
                
                Toast.fire({ 
                    icon: 'success', 
                    title: msg,
                    text: data.addedToBlacklist ? `"${data.addedToBlacklist}" × ×•×¡×£ ×œ×¨×©×™××” ×©×—×•×¨×”` : ''
                });
                
                // ×ª××™×“ ×¢×“×›×Ÿ ××ª ×”×©×“×” ×”×¡×¤×¦×™×¤×™ ××™×“
                const row = document.getElementById(`contact-row-${id}`);
                const input = row?.querySelector('input[type="text"]');
                if (input) input.value = data.newName;
                
                // ×¨×¢× ×Ÿ ××ª ×”×¨×©×™××” ×× ×™×© ×™×•×ª×¨ ×××—×“ ×©×¢×•×“×›×Ÿ
                if (data.updatedCount > 1) {
                    loadContacts();
                }
            } catch (err) {
                Toast.fire({ icon: 'error', title: '×©×’×™××”' });
                loadContacts(); // ×¨×¢× ×Ÿ ×‘××§×¨×” ×©×œ ×©×’×™××”
            }
        }

        async function checkDuplicates() {
            const data = await api(`/api/groups/${state.currentGroupId}/duplicates`);
            
            if (data.duplicates.length === 0) {
                return Swal.fire({ icon: 'success', title: '××™×Ÿ ×›×¤×™×œ×•×™×•×ª!', text: '×›×œ ×”×©××•×ª ×™×™×—×•×“×™×™×' });
            }
            
            const result = await Swal.fire({
                title: `× ××¦××• ${data.totalDuplicateNames} ×©××•×ª ×›×¤×•×œ×™×`,
                html: `
                    <div class="text-right">
                        <p class="mb-4">×¡×”"×› <strong>${data.totalDuplicateContacts}</strong> ×× ×©×™ ×§×©×¨ ×¢× ×©××•×ª ×–×”×™×</p>
                        <div class="max-h-60 overflow-y-auto text-sm">
                            ${data.duplicates.slice(0, 20).map(d => `
                                <div class="flex justify-between items-center py-2 border-b">
                                    <span class="font-medium">${d.full_name}</span>
                                    <span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs">${d.count}x</span>
                                </div>
                            `).join('')}
                            ${data.duplicates.length > 20 ? `<p class="text-slate-400 mt-2">×•×¢×•×“ ${data.duplicates.length - 20} ×©××•×ª...</p>` : ''}
                        </div>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                showDenyButton: true,
                confirmButtonText: 'ğŸ”§ ×ª×§×Ÿ ××•×˜×•××˜×™×ª',
                denyButtonText: 'ğŸ“ ×¢×¨×•×š ×™×“× ×™×ª',
                cancelButtonText: '×‘×™×˜×•×œ',
                confirmButtonColor: '#10b981',
                denyButtonColor: '#6366f1'
            });
            
            if (result.isConfirmed) {
                // ×ª×™×§×•×Ÿ ××•×˜×•××˜×™
                Swal.fire({ title: '××ª×§×Ÿ ×›×¤×™×œ×•×™×•×ª...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                const fixResult = await api(`/api/groups/${state.currentGroupId}/fix-duplicates`, { method: 'POST' });
                Swal.fire({ 
                    icon: 'success', 
                    title: '×”×›×¤×™×œ×•×™×•×ª ×ª×•×§× ×•!', 
                    text: `${fixResult.fixed} ×©××•×ª ×¢×•×“×›× ×• ×¢× ××¡×¤×•×¨ ××•×˜×•××˜×™`
                });
                loadContacts();
            } else if (result.isDenied) {
                // ×¢×¨×™×›×” ×™×“× ×™×ª - ×”×¦×’ ××ª ×”×›×¤×™×œ×•×™×•×ª
                showDuplicatesEditor(data.duplicates);
            }
        }

        async function showDuplicatesEditor(duplicates) {
            let currentIndex = 0;
            
            async function showNext() {
                if (currentIndex >= duplicates.length) {
                    Swal.fire({ icon: 'success', title: '×¡×™×™××ª!', text: '×›×œ ×”×›×¤×™×œ×•×™×•×ª ×˜×•×¤×œ×•' });
                    loadContacts();
                    return;
                }
                
                const dup = duplicates[currentIndex];
                const contactsRes = await api(`/api/groups/${state.currentGroupId}/contacts?search=${encodeURIComponent(dup.full_name)}&limit=100`);
                const contacts = contactsRes.contacts.filter(c => c.full_name === dup.full_name);
                
                const { value: formValues, isDenied } = await Swal.fire({
                    title: `×›×¤×™×œ×•×ª ${currentIndex + 1}/${duplicates.length}: ${dup.full_name}`,
                    html: `
                        <div class="text-right">
                            <p class="mb-4">${contacts.length} ×× ×©×™ ×§×©×¨ ×¢× ×©× ×–×”×”</p>
                            <div class="space-y-3 max-h-60 overflow-y-auto">
                                ${contacts.map((c, i) => `
                                    <div class="flex items-center gap-3 p-2 bg-slate-50 rounded-lg">
                                        <span class="text-slate-400">${i + 1}.</span>
                                        <input type="text" id="dup-name-${c.id}" value="${c.full_name}${i > 0 ? ' (' + (i + 1) + ')' : ''}" class="flex-1 px-3 py-2 rounded border border-slate-200">
                                        <span class="text-xs text-slate-400 font-mono">${c.phone}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `,
                    showCancelButton: true,
                    showDenyButton: true,
                    confirmButtonText: '×©××•×¨ ×•×”××©×š',
                    denyButtonText: '×“×œ×’',
                    cancelButtonText: '×¡×™×™×',
                    preConfirm: () => {
                        return contacts.map(c => ({
                            id: c.id,
                            name: document.getElementById(`dup-name-${c.id}`).value
                        }));
                    }
                });
                
                if (formValues) {
                    // ×©××•×¨ ××ª ×”×©×™× ×•×™×™×
                    for (const item of formValues) {
                        const contact = contacts.find(c => c.id === item.id);
                        if (contact && contact.full_name !== item.name) {
                            await api(`/api/contacts/${item.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ full_name: item.name })
                            });
                        }
                    }
                    currentIndex++;
                    showNext();
                } else if (isDenied) {
                    currentIndex++;
                    showNext();
                } else {
                    loadContacts();
                }
            }
            
            showNext();
        }

        async function deleteGroup(id) {
            const result = await Swal.fire({ title: '×œ××—×•×§ ××ª ×”×¨×©×™××”?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444', confirmButtonText: '××—×§', cancelButtonText: '×‘×™×˜×•×œ' });
            if (result.isConfirmed) {
                await api(`/api/groups/${id}`, { method: 'DELETE' });
                loadGroups();
                Toast.fire({ icon: 'success', title: '×”×¨×©×™××” × ××—×§×”' });
            }
        }

        async function saveVersion() {
            const { value: name } = await Swal.fire({ title: '×©××™×¨×ª ×’×¨×¡×”', input: 'text', inputPlaceholder: '×©× ×”×’×¨×¡×”...', showCancelButton: true });
            if (name) {
                await api(`/api/groups/${state.currentGroupId}/save-version`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ versionName: name })
                });
                Toast.fire({ icon: 'success', title: '×”×’×¨×¡×” × ×©××¨×”' });
                viewGroup(state.currentGroupId);
            }
        }

        async function restoreVersion(versionId) {
            const result = await Swal.fire({ title: '×œ×©×—×–×¨ ×’×¨×¡×” ×–×•?', text: '×”×¤×¢×•×œ×” ×ª×—×œ×™×£ ××ª ×× ×©×™ ×”×§×©×¨ ×”× ×•×›×—×™×™×', icon: 'question', showCancelButton: true });
            if (result.isConfirmed) {
                await api(`/api/groups/${state.currentGroupId}/restore-version/${versionId}`, { method: 'POST' });
                Toast.fire({ icon: 'success', title: '×”×’×¨×¡×” ×©×•×—×–×¨×”' });
                viewGroup(state.currentGroupId);
            }
        }

        async function revertToDraft() {
            const result = await Swal.fire({ 
                title: '×—×–×•×¨ ×œ××¦×‘ ×¢×¨×™×›×”?', 
                text: '×”×¨×©×™××” ×ª×”×¤×•×š ×œ×˜×™×•×˜×” ×•×ª×•×›×œ ×œ×¢×¨×•×š, ×œ×©× ×•×ª ×©××•×ª ×•×œ×‘×¦×¢ ×©×™× ×•×™×™× × ×•×¡×¤×™×', 
                icon: 'question', 
                showCancelButton: true,
                confirmButtonText: 'âœ… ×›×Ÿ, ×—×–×•×¨ ×œ×¢×¨×™×›×”',
                cancelButtonText: '×‘×™×˜×•×œ'
            });
            
            if (result.isConfirmed) {
                Swal.fire({ title: '××—×–×™×¨ ×œ××¦×‘ ×¢×¨×™×›×”...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                try {
                    await api(`/api/groups/${state.currentGroupId}/revert-to-draft`, { method: 'POST' });
                    Swal.close();
                    Toast.fire({ icon: 'success', title: '×”×¨×©×™××” ×”×•×—×–×¨×” ×œ××¦×‘ ×˜×™×•×˜×”' });
                    resumeDraft(state.currentGroupId);
                } catch (err) {
                    Swal.fire({ icon: 'error', title: '×©×’×™××”', text: err.message });
                }
            }
        }

        async function exportGroup(type) {
            try {
                const response = await fetch(`/api/export/${type}/${state.currentGroupId}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('×©×’×™××” ×‘×”×•×¨×“×ª ×”×§×•×‘×¥');
                }
                
                const blob = await response.blob();
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = `contacts.${type}`;
                if (contentDisposition) {
                    const match = contentDisposition.match(/filename="(.+)"/);
                    if (match) filename = match[1];
                }
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                Toast.fire({ icon: 'success', title: '×”×§×•×‘×¥ ×”×•×¨×“ ×‘×”×¦×œ×—×”' });
            } catch (err) {
                console.error('Export error:', err);
                Swal.fire({ icon: 'error', title: '×©×’×™××”', text: err.message });
            }
        }

        async function shareGroup() {
            try {
                const data = await api(`/api/groups/${state.currentGroupId}/share`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const fullUrl = `${window.location.origin}${data.url}`;
                
                const result = await Swal.fire({
                    title: 'ğŸ”— ×œ×™× ×§ ×©×™×ª×•×£',
                    html: `
                        <div class="text-right space-y-4">
                            <p class="text-slate-600">×›×œ ××™ ×©×™×§×‘×œ ××ª ×”×œ×™× ×§ ×™×•×›×œ:</p>
                            <ul class="text-sm text-slate-500 space-y-1">
                                <li>âœ… ×œ×¦×¤×•×ª ×‘×›×œ ×”× ×ª×•× ×™× (××•×©×¨×•, × ×“×—×•, ×§×•× ×¤×œ×™×§×˜×™×)</li>
                                <li>âœ… ×œ×¢×¨×•×š ×©××•×ª ×•×œ×¤×ª×•×¨ ×§×•× ×¤×œ×™×§×˜×™×</li>
                                <li>âœ… ×œ×©× ×•×ª ×”×’×“×¨×•×ª × ×™×§×•×™ ×©××•×ª</li>
                                <li>âœ… ×œ×©××•×¨ ××ª ×”×¨×©×™××” ×”×¡×•×¤×™×ª</li>
                                <li>âœ… ×œ×”×•×¨×™×“ ×§×•×‘×¥ VCF</li>
                                <li>âŒ ×œ× ×™×•×›×œ ×œ×”×•×¡×™×£ ×§×‘×¦×™× ××• ×œ×™×¦×•×¨ ×¨×©×™××•×ª ×—×“×©×•×ª</li>
                            </ul>
                            <div class="bg-slate-100 rounded-xl p-3">
                                <input type="text" value="${fullUrl}" readonly 
                                       id="shareUrlInput"
                                       class="w-full bg-transparent text-center font-mono text-sm outline-none"
                                       onclick="this.select()">
                            </div>
                        </div>
                    `,
                    showCancelButton: true,
                    showDenyButton: true,
                    confirmButtonText: 'ğŸ“‹ ×”×¢×ª×§ ×œ×™× ×§',
                    denyButtonText: 'ğŸ—‘ï¸ ×‘×˜×œ ×©×™×ª×•×£',
                    cancelButtonText: '×¡×’×•×¨',
                    confirmButtonColor: '#6366f1',
                    denyButtonColor: '#ef4444'
                });
                
                if (result.isConfirmed) {
                    navigator.clipboard.writeText(fullUrl);
                    Toast.fire({ icon: 'success', title: '×”×œ×™× ×§ ×”×•×¢×ª×§!' });
                } else if (result.isDenied) {
                    await api(`/api/groups/${state.currentGroupId}/share`, { method: 'DELETE' });
                    Toast.fire({ icon: 'success', title: '×”×©×™×ª×•×£ ×‘×•×˜×œ' });
                }
            } catch (err) {
                Swal.fire({ icon: 'error', title: '×©×’×™××”', text: err.message });
            }
        }

        // ==================== FILES ====================
        async function loadFiles() {
            try {
                const files = await api('/api/files');
                if (!Array.isArray(files)) throw new Error('Invalid data');
                state.files = files;
                
                document.getElementById('filesList').innerHTML = files.map(f => {
                    const isSelected = state.selectedFiles.includes(f.id);
                    return `
                    <div class="glass-card rounded-2xl p-5 file-card cursor-pointer ${isSelected ? 'ring-2 ring-indigo-500 bg-indigo-50' : ''}" onclick="toggleFile(${f.id})">
                        <div class="flex justify-between items-start mb-3">
                            <span class="text-3xl">ğŸ“„</span>
                            <input type="checkbox" ${isSelected ? 'checked' : ''} class="w-5 h-5 accent-indigo-600" onclick="event.stopPropagation(); toggleFile(${f.id})">
                        </div>
                        <h4 class="font-bold text-slate-800 truncate mb-2" title="${f.original_name}">${f.original_name}</h4>
                        <div class="grid grid-cols-3 gap-2 text-center mb-3">
                            <div class="bg-slate-100 rounded-lg p-2">
                                <p class="text-lg font-bold text-slate-700">${(f.parsed_count || 0).toLocaleString()}</p>
                                <p class="text-xs text-slate-500">× ×§×¨××•</p>
                            </div>
                            <div class="bg-green-50 rounded-lg p-2">
                                <p class="text-lg font-bold text-green-600">${(f.valid_count || 0).toLocaleString()}</p>
                                <p class="text-xs text-slate-500">×ª×§×™× ×™×</p>
                            </div>
                            <div class="bg-red-50 rounded-lg p-2">
                                <p class="text-lg font-bold text-red-500">${(f.rejected_count || 0).toLocaleString()}</p>
                                <p class="text-xs text-slate-500">× ×“×—×•</p>
                            </div>
                        </div>
                        <div class="flex justify-between items-center pt-3 border-t border-slate-100">
                            <button onclick="event.stopPropagation(); openMapping(${f.id})" class="text-indigo-600 font-semibold text-sm hover:underline">âš™ï¸ ××™×¤×•×™</button>
                            <button onclick="event.stopPropagation(); deleteFile(${f.id})" class="text-red-400 hover:text-red-600 text-sm">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `}).join('') || '<p class="text-slate-400 text-center py-8 col-span-3">××™×Ÿ ×§×‘×¦×™× ×××ª×™× ×™×. ×”×¢×œ×” ×§×‘×¦×™× ×—×“×©×™×.</p>';
                
                updateProcessButton();
            } catch (err) {
                console.error('Files error:', err);
            }
        }

        function toggleFile(id) {
            const idx = state.selectedFiles.indexOf(id);
            if (idx > -1) state.selectedFiles.splice(idx, 1);
            else state.selectedFiles.push(id);
            loadFiles();
        }

        function updateProcessButton() {
            const btn = document.getElementById('processBtn');
            const count = state.selectedFiles.length;
            document.getElementById('selectedCount').textContent = count;
            btn.classList.toggle('hidden', count === 0);
        }

        async function deleteFile(id) {
            await api(`/api/files/${id}`, { method: 'DELETE' });
            state.selectedFiles = state.selectedFiles.filter(fid => fid !== id);
            loadFiles();
            Toast.fire({ icon: 'success', title: '×”×§×•×‘×¥ × ××—×§' });
        }

        // ==================== UPLOAD ====================
        async function handleUpload(e) {
            const files = e.target.files;
            if (!files.length) return;
            
            document.getElementById('uploadOverlay').classList.remove('hidden');
            const filesList = document.getElementById('uploadFilesList');
            const globalProgress = document.getElementById('globalProgress');
            const totalText = document.getElementById('uploadTotalText');
            const totalPercent = document.getElementById('uploadTotalPercent');
            
            filesList.innerHTML = Array.from(files).map((f, i) => `
                <div id="upload-${i}" class="bg-slate-50 rounded-xl p-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold text-slate-700 truncate max-w-[300px]">${f.name}</span>
                        <span id="status-${i}" class="text-sm font-medium text-slate-400">×××ª×™×Ÿ...</span>
                    </div>
                    <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                        <div id="progress-${i}" class="h-full bg-indigo-500 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-slate-400 mt-1">
                        <span>${formatSize(f.size)}</span>
                        <span id="percent-${i}">0%</span>
                    </div>
                </div>
            `).join('');
            
            let completed = 0;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                document.getElementById(`status-${i}`).textContent = '××¢×œ×”...';
                document.getElementById(`status-${i}`).className = 'text-sm font-medium text-indigo-600';
                
                try {
                    const result = await uploadFile(file, (percent) => {
                        document.getElementById(`progress-${i}`).style.width = percent + '%';
                        document.getElementById(`percent-${i}`).textContent = percent + '%';
                        if (percent === 100) {
                            document.getElementById(`status-${i}`).textContent = 'â³ ××¢×‘×“...';
                            document.getElementById(`status-${i}`).className = 'text-sm font-medium text-amber-600';
                            document.getElementById(`progress-${i}`).classList.remove('bg-indigo-500');
                            document.getElementById(`progress-${i}`).classList.add('bg-amber-400');
                        }
                    });
                    
                    // Success
                    document.getElementById(`status-${i}`).textContent = `âœ… ${result.stats?.valid?.toLocaleString() || 0} ×ª×§×™× ×™×`;
                    document.getElementById(`status-${i}`).className = 'text-sm font-medium text-green-600';
                    document.getElementById(`progress-${i}`).classList.remove('bg-amber-400');
                    document.getElementById(`progress-${i}`).classList.add('bg-green-500');
                    
                    // Setup auto mapping
                    const headers = Array.isArray(result.headers) ? result.headers : JSON.parse(result.headers || '[]');
                    state.fileSamples[result.id] = result.sample;
                    const phoneField = headers.find(h => /phone|tel|×˜×œ×¤×•×Ÿ/i.test(h)) || headers[0];
                    const nameField = headers.find(h => /name|×©×/i.test(h)) || headers[0];
                    state.mappings[result.id] = { phoneField, nameFields: [nameField] };
                    if (headers.length <= 3) state.selectedFiles.push(result.id);
                    
                } catch (err) {
                    document.getElementById(`status-${i}`).textContent = 'âŒ ×©×’×™××”';
                    document.getElementById(`status-${i}`).className = 'text-sm font-medium text-red-600';
                    document.getElementById(`progress-${i}`).classList.add('bg-red-500');
                }
                
                completed++;
                totalText.textContent = `${completed} / ${files.length} ×§×‘×¦×™×`;
                totalPercent.textContent = Math.round((completed / files.length) * 100) + '%';
                globalProgress.style.width = (completed / files.length * 100) + '%';
            }
            
            globalProgress.classList.add('bg-green-500');
            setTimeout(async () => {
                document.getElementById('uploadOverlay').classList.add('hidden');
                globalProgress.classList.remove('bg-green-500');
                globalProgress.style.width = '0%';
                
                // ×× ×”×™×™× ×• ×‘×××¦×¢ ×”×•×¡×¤×” ×œ×§×‘×•×¦×” ×§×™×™××ª
                if (state.addToGroupAfterUpload) {
                    const groupId = state.addToGroupAfterUpload;
                    state.addToGroupAfterUpload = null;
                    state.currentGroupId = groupId;
                    
                    // ×§×— ××ª ×”×§×‘×¦×™× ×©×–×” ×¢×ª×” ×”×•×¢×œ×•
                    const newFiles = await api('/api/files');
                    const newFileIds = newFiles.slice(0, files.length).map(f => f.id);
                    
                    if (newFileIds.length) {
                        await processAddFiles(newFileIds);
                    }
                } else {
                    loadFiles();
                    showView('files');
                }
            }, 1500);
            
            e.target.value = '';
        }

        function uploadFile(file, onProgress) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                const fd = new FormData();
                fd.append('file', file);
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) onProgress(Math.round(e.loaded / e.total * 100));
                });
                
                xhr.addEventListener('load', () => {
                    if (xhr.status === 401) {
                        window.location.href = '/login';
                        reject(new Error('Session expired'));
                    } else if (xhr.status >= 200 && xhr.status < 300) {
                        resolve(JSON.parse(xhr.responseText));
                    } else {
                        reject(new Error('Upload failed'));
                    }
                });
                
                xhr.addEventListener('error', () => reject(new Error('Network error')));
                xhr.open('POST', '/api/upload');
                xhr.send(fd);
            });
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024, sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // ==================== MAPPING ====================
        function openMapping(id) {
            const file = state.files.find(f => f.id === id);
            if (!file) return;
            
            const headers = Array.isArray(file.headers) ? file.headers : JSON.parse(file.headers || '[]');
            const mapping = state.mappings[id] || { phoneField: headers[0], nameFields: [headers[0]] };
            const sample = state.fileSamples[id] || [];
            
            document.getElementById('mappingTitle').textContent = file.original_name;
            document.getElementById('mappingContent').innerHTML = `
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block font-semibold text-slate-700 mb-2">×©×“×” ×˜×œ×¤×•×Ÿ</label>
                        <select id="mappingPhone" class="w-full px-4 py-3 rounded-xl border border-slate-200">
                            ${headers.map(h => `<option value="${h}" ${mapping.phoneField === h ? 'selected' : ''}>${h}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block font-semibold text-slate-700 mb-2">×©×“×•×ª ×©×</label>
                        <div class="flex flex-wrap gap-2">
                            ${headers.map(h => `
                                <label class="flex items-center gap-2 px-3 py-2 bg-slate-100 rounded-lg cursor-pointer hover:bg-slate-200">
                                    <input type="checkbox" class="mapping-name-field" value="${h}" ${mapping.nameFields?.includes(h) ? 'checked' : ''}>
                                    ${h}
                                </label>
                            `).join('')}
                        </div>
                    </div>
                </div>
                <div class="bg-slate-50 rounded-xl p-4">
                    <h4 class="font-semibold text-slate-700 mb-3">×“×•×’××ª × ×ª×•× ×™×</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead><tr>${headers.map(h => `<th class="px-3 py-2 text-right bg-slate-100 font-semibold">${h}</th>`).join('')}</tr></thead>
                            <tbody>${sample.slice(0, 5).map(row => `<tr>${headers.map(h => `<td class="px-3 py-2 border-t border-slate-200">${row[h] || ''}</td>`).join('')}</tr>`).join('')}</tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('mappingModal').classList.remove('hidden');
            document.getElementById('mappingModal').dataset.fileId = id;
        }

        function saveMapping() {
            const id = parseInt(document.getElementById('mappingModal').dataset.fileId);
            const phoneField = document.getElementById('mappingPhone').value;
            const nameFields = Array.from(document.querySelectorAll('.mapping-name-field:checked')).map(el => el.value);
            
            state.mappings[id] = { phoneField, nameFields: nameFields.length ? nameFields : [phoneField] };
            if (!state.selectedFiles.includes(id)) state.selectedFiles.push(id);
            
            closeMapping();
            loadFiles();
            Toast.fire({ icon: 'success', title: '×”××™×¤×•×™ × ×©××¨' });
        }

        function closeMapping() {
            document.getElementById('mappingModal').classList.add('hidden');
        }

        // ==================== PROCESSING ====================
        async function startProcessing() {
            if (!state.selectedFiles.length) return;
            
            const targetGroupName = document.getElementById('targetGroupName').value || '×¨×©×™××” ×—×“×©×”';
            const defaultName = document.getElementById('defaultName').value;
            const startSerial = document.getElementById('startSerial').value;
            const allowShortPhones = document.getElementById('allowShortPhones')?.checked || false;
            
            const fileNames = state.selectedFiles.map(id => {
                const f = state.files.find(f => f.id === id);
                return f?.original_name || `×§×•×‘×¥ ${id}`;
            });
            
            let progressHtml = `
                <div class="text-right" dir="rtl">
                    <p class="mb-4 text-slate-600">××¢×‘×“ ${fileNames.length} ×§×‘×¦×™×...</p>
                    <div class="space-y-2 mb-4">
                        ${fileNames.map((name, i) => `
                            <div class="flex items-center gap-2" id="file-progress-${i}">
                                <span class="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center text-xs" id="file-icon-${i}">â³</span>
                                <span class="text-sm truncate flex-1">${name}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="h-3 bg-slate-200 rounded-full overflow-hidden">
                        <div id="process-progress-bar" class="h-full bg-indigo-500 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <p class="text-xs text-slate-400 mt-2" id="process-status">××ª×—×™×œ ×¢×™×‘×•×“...</p>
                </div>
            `;
            
            Swal.fire({ 
                title: '××¢×‘×“ ×§×‘×¦×™×', 
                html: progressHtml,
                allowOutsideClick: false, 
                showConfirmButton: false
            });
            
            // ×¡×™××•×œ×¦×™×™×ª ×”×ª×§×“××•×ª
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress = Math.min(progress + Math.random() * 15, 90);
                const bar = document.getElementById('process-progress-bar');
                const status = document.getElementById('process-status');
                if (bar) bar.style.width = `${progress}%`;
                if (status) {
                    const steps = ['×§×•×¨× ×§×‘×¦×™×...', '×× ×ª×— ×× ×©×™ ×§×©×¨...', '××–×”×” ×›×¤×™×œ×•×™×•×ª...', '××—×™×œ ×›×œ×œ×™ × ×™×§×•×™...', '××¡×™×™× ×¢×™×‘×•×“...'];
                    status.textContent = steps[Math.min(Math.floor(progress / 20), steps.length - 1)];
                }
                
                // ×¢×“×›×•×Ÿ ××™×™×§×•× ×™×
                const filesDone = Math.floor((progress / 100) * fileNames.length);
                for (let i = 0; i < fileNames.length; i++) {
                    const icon = document.getElementById(`file-icon-${i}`);
                    if (icon) {
                        if (i < filesDone) icon.textContent = 'âœ…';
                        else if (i === filesDone) icon.textContent = 'â³';
                    }
                }
            }, 300);
            
            try {
                const processingData = state.selectedFiles.map(id => ({
                    fileId: id,
                    mapping: state.mappings[id] || { phoneField: 'Phone', nameFields: ['Name'] }
                }));
                
                const result = await api('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ processingData, targetGroupName, defaultName, startSerial, allowShortPhones })
                });
                
                clearInterval(progressInterval);
                
                // ×”×©×œ× ××ª ×”×¤×¨×•×’×¨×¡
                const bar = document.getElementById('process-progress-bar');
                const status = document.getElementById('process-status');
                if (bar) bar.style.width = '100%';
                if (status) status.textContent = '×”×•×©×œ×!';
                fileNames.forEach((_, i) => {
                    const icon = document.getElementById(`file-icon-${i}`);
                    if (icon) icon.textContent = 'âœ…';
                });
                
                await new Promise(r => setTimeout(r, 500));
                Swal.close();
                state.analysisData = result;
                showAnalysis(result);
                
            } catch (err) {
                clearInterval(progressInterval);
                Swal.fire({ icon: 'error', title: '×©×’×™××”', text: err.message });
            }
        }

        async function resumeDraft(groupId) {
            let progressHtml = `
                <div class="text-right" dir="rtl">
                    <p class="mb-4 text-slate-600">×˜×•×¢×Ÿ ×˜×™×•×˜×” ×•××—×™×œ ×›×œ×œ×™×...</p>
                    <div class="h-3 bg-slate-200 rounded-full overflow-hidden">
                        <div id="draft-progress-bar" class="h-full bg-indigo-500 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <p class="text-xs text-slate-400 mt-2" id="draft-status">×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
                </div>
            `;
            
            Swal.fire({ 
                title: '×˜×•×¢×Ÿ ×˜×™×•×˜×”', 
                html: progressHtml,
                allowOutsideClick: false, 
                showConfirmButton: false
            });
            
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress = Math.min(progress + Math.random() * 10, 90);
                const bar = document.getElementById('draft-progress-bar');
                const status = document.getElementById('draft-status');
                if (bar) bar.style.width = `${progress}%`;
                if (status) {
                    const steps = ['×˜×•×¢×Ÿ × ×ª×•× ×™×...', '××—×™×œ ×›×œ×œ×™ × ×™×§×•×™...', '××¢×“×›×Ÿ ×©××•×ª...', '×‘×•×“×§ ×›×¤×™×œ×•×™×•×ª...', '××¡×™×™×...'];
                    status.textContent = steps[Math.min(Math.floor(progress / 20), steps.length - 1)];
                }
            }, 200);
            
            try {
                const result = await api('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ groupId })
                });
                
                clearInterval(progressInterval);
                
                // ×”×©×œ× ××ª ×”×¤×¨×•×’×¨×¡
                const bar = document.getElementById('draft-progress-bar');
                const status = document.getElementById('draft-status');
                if (bar) bar.style.width = '100%';
                if (status) status.textContent = '×”×•×©×œ×!';
                
                await new Promise(r => setTimeout(r, 400));
                Swal.close();
                state.analysisData = result;
                showAnalysis(result);
            } catch (err) {
                clearInterval(progressInterval);
                Swal.fire({ icon: 'error', title: '×©×’×™××”', text: err.message });
            }
        }

        function showAnalysis(data) {
            document.getElementById('analysisTitle').textContent = data.targetGroupName;
            
            const stats = data.stats || {};
            document.getElementById('analysisSummary').textContent = `${stats.totalParsed?.toLocaleString() || 0} × ×§×¨××• ×-${stats.byFile?.length || 0} ×§×‘×¦×™×`;
            
            // Stats cards
            const conflictCount = data.conflicts?.length || 0;
            const approvedCount = data.allData?.length || 0;
            const approvedWithoutConflict = approvedCount - conflictCount;
            
            document.getElementById('analysisStats').innerHTML = `
                <div class="bg-slate-100 rounded-xl p-4 text-center">
                    <p class="text-2xl font-black text-slate-700">${(stats.totalParsed || 0).toLocaleString()}</p>
                    <p class="text-sm text-slate-500">× ×§×¨××•</p>
                </div>
                <div class="bg-green-100 rounded-xl p-4 text-center cursor-help" title="×›×œ ×× ×©×™ ×”×§×©×¨ ×”×™×™×—×•×“×™×™× - ×›×•×œ×œ ×§×•× ×¤×œ×™×§×˜×™× ×©× ×¤×ª×¨×•">
                    <p class="text-2xl font-black text-green-600">${approvedCount.toLocaleString()}</p>
                    <p class="text-sm text-slate-500">×¡×”"×› ×× ×©×™ ×§×©×¨</p>
                    <p class="text-xs text-green-500 mt-1">${approvedWithoutConflict.toLocaleString()} ×œ×œ× ×§×•× ×¤×œ×™×§×˜</p>
                </div>
                <div class="bg-red-100 rounded-xl p-4 text-center">
                    <p class="text-2xl font-black text-red-600">${(data.rejectedContacts?.length || 0).toLocaleString()}</p>
                    <p class="text-sm text-slate-500">× ×“×—×•</p>
                </div>
                <div class="bg-amber-100 rounded-xl p-4 text-center cursor-help" title="×× ×©×™ ×§×©×¨ ×¢× ×›××” ×©××•×ª - × ×‘×—×¨ ×©× ××•×˜×•××˜×™">
                    <p class="text-2xl font-black text-amber-600">${conflictCount.toLocaleString()}</p>
                    <p class="text-sm text-slate-500">×§×•× ×¤×œ×™×§×˜×™×</p>
                    <p class="text-xs text-amber-500 mt-1">×›×œ×•×œ×™× ×‘×¡×”"×›</p>
                </div>
                <div class="bg-blue-100 rounded-xl p-4 text-center cursor-help" title="××•×ª×• ×˜×œ×¤×•×Ÿ ×¢× ×©× ×“×•××” - × ×‘×—×¨ ×”×˜×•×‘ ×™×•×ª×¨">
                    <p class="text-2xl font-black text-blue-600">${(data.autoResolved?.length || 0).toLocaleString()}</p>
                    <p class="text-sm text-slate-500">×›×¤×™×œ×•×™×•×ª</p>
                </div>
            `;
            
            document.getElementById('acceptedCount').textContent = data.allData?.length || 0;
            document.getElementById('rejectedCount').textContent = data.rejectedContacts?.length || 0;
            document.getElementById('conflictsCount').textContent = data.conflicts?.length || 0;
            document.getElementById('duplicatesCount').textContent = data.autoResolved?.length || 0;
            
            state.analysisPage = 1;
            showAnalysisTab('accepted');
            showView('analysis');
        }

        function analysisPageChange(page) {
            state.analysisPage = page;
            showAnalysisTab('accepted');
        }

        function rejectedPageChange(page) {
            state.rejectedPage = page;
            showAnalysisTab('rejected');
        }
        
        function setFilterRejectedReason(reason) {
            state.filterRejectedReason = reason;
            state.rejectedPage = 1;
            showAnalysisTab('rejected');
        }
        
        function showRejectedData(idx) {
            const filterReason = state.filterRejectedReason || '';
            const filtered = filterReason 
                ? (state.analysisData.rejectedContacts || []).filter(c => c.reason === filterReason)
                : (state.analysisData.rejectedContacts || []);
            const contact = filtered[idx];
            if (!contact) return;
            
            // ×”×¦×’ ××ª ×›×œ ×”× ×ª×•× ×™× ×”××§×•×¨×™×™×
            const originalData = contact.originalData || {};
            const dataHtml = Object.entries(originalData)
                .filter(([k, v]) => v && v.toString().trim())
                .map(([k, v]) => `<div class="flex gap-2 p-2 bg-slate-50 rounded"><span class="font-semibold text-slate-600 min-w-[100px]">${k}:</span><span class="text-slate-800 break-all">${v}</span></div>`)
                .join('');
            
            Swal.fire({
                title: '× ×ª×•× ×™× ××§×•×¨×™×™×',
                html: `
                    <div class="text-right max-h-96 overflow-auto space-y-1">
                        <p class="text-sm text-slate-500 mb-3">××œ×• ×”× ×ª×•× ×™× ×›×¤×™ ×©× ×§×¨××• ××”×§×•×‘×¥. ×—×¤×© ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×•×”×¢×ª×§ ××•×ª×• ×œ×©×“×” ×”×˜×œ×¤×•×Ÿ.</p>
                        ${dataHtml || '<p class="text-slate-400">××™×Ÿ × ×ª×•× ×™× × ×•×¡×¤×™×</p>'}
                    </div>
                `,
                width: 600,
                confirmButtonText: '×¡×’×•×¨'
            });
        }
        
        function restoreRejected(idx) {
            const filterReason = state.filterRejectedReason || '';
            const filtered = filterReason 
                ? (state.analysisData.rejectedContacts || []).filter(c => c.reason === filterReason)
                : (state.analysisData.rejectedContacts || []);
            const contact = filtered[idx];
            if (!contact) return;
            
            // ×§×‘×œ ××ª ×”×˜×œ×¤×•×Ÿ ××”×©×“×”
            const phoneInput = document.getElementById(`rejected-phone-${idx}`);
            let phone = phoneInput?.value?.replace(/[^\d+]/g, '').trim() || contact.phone || '';
            
            if (!phone || phone.length < 3) {
                Toast.fire({ icon: 'error', title: '×”×–×Ÿ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×ª×§×™×Ÿ' });
                phoneInput?.focus();
                return;
            }
            
            // ×‘×“×•×§ ×›×¤×™×œ×•×™×•×ª
            const duplicate = state.analysisData.allData.find(c => c.phone === phone);
            if (duplicate) {
                Swal.fire({
                    icon: 'warning',
                    title: '××¡×¤×¨ ×§×™×™×',
                    text: `×”××¡×¤×¨ ${phone} ×›×‘×¨ ×©×™×™×š ×œ: ${duplicate.name}. ×”×× ×œ×“×¨×•×¡?`,
                    showCancelButton: true,
                    confirmButtonText: '×›×Ÿ, ×¢×“×›×Ÿ',
                    cancelButtonText: '×‘×™×˜×•×œ'
                }).then(result => {
                    if (result.isConfirmed) {
                        // ×¢×“×›×Ÿ ××ª ×”×§×™×™×
                        duplicate.name = contact.name || duplicate.name;
                        removeFromRejected(contact);
                    }
                });
                return;
            }
            
            // ×”×•×¡×£ ×œ×¨×©×™××” ×”×××•×©×¨×ª
            state.analysisData.allData.push({
                name: contact.name || `××™×© ×§×©×¨ ${phone.slice(-4)}`,
                phone: phone,
                email: contact.email || '',
                sourceFile: contact.sourceFile || '',
                sourceFileId: contact.sourceFileId,
                originalData: contact.originalData || {}
            });
            
            removeFromRejected(contact);
            Toast.fire({ icon: 'success', title: '××™×© ×”×§×©×¨ ×©×•×—×–×¨!' });
        }
        
        function removeFromRejected(contact) {
            const idx = state.analysisData.rejectedContacts.indexOf(contact);
            if (idx > -1) {
                state.analysisData.rejectedContacts.splice(idx, 1);
            }
            scheduleDraftSave();
            showAnalysisTab('rejected');
        }
        
        // ××™×•×Ÿ
        function setSort(field) {
            if (state.sortBy === field) {
                // ××•×ª×• ×©×“×” - ×”×—×œ×£ ×›×™×•×•×Ÿ
                state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                state.sortBy = field;
                state.sortDir = 'asc';
            }
            state.analysisPage = 1;
            showAnalysisTab('accepted');
        }
        
        // ×¡×™× ×•×Ÿ ×œ×¤×™ ××§×•×¨
        function setFilterSource(source) {
            state.filterSource = source;
            state.analysisPage = 1;
            showAnalysisTab('accepted');
        }

        // ==================== ××™×—×•×“ ×× ×©×™ ×§×©×¨ ====================
        function openMergeModal(index) {
            const contact = state.analysisData?.allData?.[index];
            if (!contact) return;
            
            state.mergeSourceIndex = index;
            state.mergeSelectedIndexes = [index];
            state.mergePhoneLabels = { [contact.phone]: contact.originalData?.PhoneType || '× ×™×™×“' };
            
            // ×× ×™×© ×›×‘×¨ ××¡×¤×¨×™× ×××•×—×“×™× - ×˜×¢×Ÿ ××•×ª×
            if (contact.mergedPhones && contact.mergedPhones.length > 1) {
                // ×˜×¢×Ÿ ××ª ×”××¡×¤×¨×™× ×”×§×™×™××™× ×›"××¡×¤×¨×™× ×•×™×¨×˜×•××œ×™×™×" ×œ×¢×¨×™×›×”
                state.mergedPhonesEdit = contact.mergedPhones.map(p => ({ ...p }));
                state.mergePhoneLabels = {};
                contact.mergedPhones.forEach(p => {
                    state.mergePhoneLabels[p.phone] = p.label || '× ×™×™×“';
                });
            } else {
                state.mergedPhonesEdit = null;
            }
            
            // ×”×¦×’ ×¤×¨×˜×™ ××™×© ×”×§×©×¨ ×”× ×•×›×—×™
            document.getElementById('mergeCurrentName').textContent = contact.name || '(×œ×œ× ×©×)';
            document.getElementById('mergeCurrentPhone').textContent = contact.mergedPhones?.length > 1 
                ? `${contact.mergedPhones.length} ××¡×¤×¨×™× ×××•×—×“×™×` 
                : contact.phone;
            
            // ×”×¦×’ ××¡×¤×¨×™× ×©× ×‘×—×¨×•
            renderMergeSelected();
            
            // ××¦× ×× ×©×™ ×§×©×¨ ×“×•××™×
            findSimilarContacts(contact.name);
            
            // ××ª×—×œ ×©×“×” ×©× ×¡×•×¤×™ - ×”×©×ª××© ×‘×©× ×‘×¡×™×¡×™ (×‘×œ×™ ×¡×™×•××•×ª)
            document.getElementById('mergeFinalName').value = getBaseName(contact.name) || contact.name || '';
            
            document.getElementById('mergeModal').classList.remove('hidden');
            document.getElementById('mergeSearch').value = '';
            document.getElementById('mergeSearch').focus();
        }
        
        function closeMergeModal() {
            document.getElementById('mergeModal').classList.add('hidden');
            state.mergeSourceIndex = null;
            state.mergeSelectedIndexes = [];
            state.mergePhoneLabels = {};
            state.mergedPhonesEdit = null;
        }
        
        function renderMergeSelected() {
            const container = document.getElementById('mergeSelectedContacts');
            const nameOptions = document.getElementById('mergeNameOptions');
            
            // ×ª×•×•×™×•×ª ×‘×¨×™×¨×ª ××—×“×œ + ××•×ª×××•×ª ××™×©×™×ª
            const defaultLabels = ['× ×™×™×“', '×¢×‘×•×“×”', '×‘×™×ª'];
            const allLabels = [...defaultLabels, ...state.customPhoneLabels.filter(l => !defaultLabels.includes(l)), '××—×¨'];
            
            // ×× ×™×© ××¡×¤×¨×™× ×××•×—×“×™× ×§×™×™××™× - ×”×¦×’ ××•×ª×
            if (state.mergedPhonesEdit && state.mergedPhonesEdit.length > 0) {
                container.innerHTML = state.mergedPhonesEdit.map((p, idx) => {
                    const currentLabel = p.label || '× ×™×™×“';
                    const isCustomLabel = !allLabels.includes(currentLabel) && currentLabel !== '××—×¨';
                    
                    return `
                    <div class="flex items-center gap-2 p-3 bg-white rounded-lg border ${idx === 0 ? 'border-indigo-300 bg-indigo-50' : 'border-slate-200'}">
                        <div class="flex-1">
                            <span class="text-sm font-medium text-slate-500">××¡×¤×¨ ×××•×—×“</span>
                        </div>
                        <span class="font-mono text-slate-600 text-sm">${p.phone}</span>
                        <select class="px-2 py-1 rounded border border-slate-200 text-sm" 
                                onchange="handleMergedLabelChange(${idx}, this.value)">
                            ${allLabels.map(label => `<option value="${label}" ${currentLabel === label || (isCustomLabel && label === '××—×¨') ? 'selected' : ''}>${label}</option>`).join('')}
                            ${isCustomLabel ? `<option value="${currentLabel}" selected>${currentLabel}</option>` : ''}
                        </select>
                        <button onclick="removeMergedPhone(${idx})" 
                                class="text-red-400 hover:text-red-600 px-2 ${state.mergedPhonesEdit.length === 1 ? 'opacity-30 cursor-not-allowed' : ''}"
                                ${state.mergedPhonesEdit.length === 1 ? 'disabled' : ''}
                                title="×”×¡×¨ ××¡×¤×¨">âœ•</button>
                    </div>
                `}).join('');
                
                // ×”×¦×’ ××ª ×”×©× ×”× ×•×›×—×™ ×›××¤×©×¨×•×ª
                const contact = state.analysisData?.allData?.[state.mergeSourceIndex];
                const currentName = getBaseName(contact?.name) || contact?.name || '';
                nameOptions.innerHTML = currentName ? `
                    <button onclick="document.getElementById('mergeFinalName').value = '${currentName.replace(/'/g, "\\'")}'"
                            class="px-3 py-1 bg-white border rounded-lg hover:bg-indigo-50 hover:border-indigo-300 text-sm">
                        ${currentName}
                    </button>
                ` : '';
                return;
            }
            
            // ××¦×‘ ×¨×’×™×œ - ×”×¦×’ ×× ×©×™ ×§×©×¨ ×©× ×‘×—×¨×•
            const contacts = state.mergeSelectedIndexes.map(i => state.analysisData.allData[i]).filter(Boolean);
            
            // ×”×¦×’ ××¡×¤×¨×™× ×©× ×‘×—×¨×• ×¢× ×ª×•×•×™×•×ª ×•××¤×©×¨×•×™×•×ª ×¢×¨×™×›×”/×”×¡×¨×”
            container.innerHTML = contacts.map((c, idx) => {
                const currentLabel = state.mergePhoneLabels[c.phone] || '× ×™×™×“';
                const isCustomLabel = !allLabels.includes(currentLabel) && currentLabel !== '××—×¨';
                
                return `
                <div class="flex items-center gap-2 p-3 bg-white rounded-lg border ${idx === 0 ? 'border-indigo-300 bg-indigo-50' : 'border-slate-200'}">
                    <div class="flex-1">
                        <input type="text" 
                               value="${(c.name || '').replace(/"/g, '&quot;')}" 
                               onchange="editMergeContactName(${state.mergeSelectedIndexes[idx]}, this.value)"
                               class="w-full px-2 py-1 rounded border border-slate-200 text-sm font-medium"
                               placeholder="×©× ××™×© ×”×§×©×¨">
                    </div>
                    <span class="font-mono text-slate-600 text-sm">${c.phone}</span>
                    <select class="px-2 py-1 rounded border border-slate-200 text-sm" 
                            onchange="handleLabelChange('${c.phone}', this.value)">
                        ${allLabels.map(label => `<option value="${label}" ${currentLabel === label || (isCustomLabel && label === '××—×¨') ? 'selected' : ''}>${label}</option>`).join('')}
                        ${isCustomLabel ? `<option value="${currentLabel}" selected>${currentLabel}</option>` : ''}
                    </select>
                    <button onclick="removeMergeContact(${state.mergeSelectedIndexes[idx]})" 
                            class="text-red-400 hover:text-red-600 px-2 ${idx === 0 && contacts.length === 1 ? 'opacity-30 cursor-not-allowed' : ''}"
                            ${idx === 0 && contacts.length === 1 ? 'disabled' : ''}
                            title="${idx === 0 ? '××™×© ×§×©×¨ ×¨××©×™' : '×”×¡×¨ ××”××™×—×•×“'}">âœ•</button>
                </div>
            `}).join('');
            
            // ×”×¦×’ ××¤×©×¨×•×™×•×ª ×©××•×ª - ×©××•×ª ×‘×¡×™×¡×™×™× ×‘×œ×™ ×¡×™×•××•×ª
            const baseNames = contacts.map(c => getBaseName(c.name)).filter(Boolean);
            const uniqueNames = [...new Set(baseNames)];
            nameOptions.innerHTML = uniqueNames.map(name => `
                <button onclick="document.getElementById('mergeFinalName').value = '${name.replace(/'/g, "\\'")}'"
                        class="px-3 py-1 bg-white border rounded-lg hover:bg-indigo-50 hover:border-indigo-300 text-sm">
                    ${name}
                </button>
            `).join('');
        }
        
        function editMergeContactName(index, newName) {
            if (state.analysisData?.allData?.[index]) {
                state.analysisData.allData[index].name = newName;
                // ×¢×“×›×Ÿ ×’× ××ª ×”×©× ×”××•×¦×¢ - ×©××•×ª ×‘×¡×™×¡×™×™× ×‘×œ×™ ×¡×™×•××•×ª
                const baseNames = state.mergeSelectedIndexes.map(i => getBaseName(state.analysisData.allData[i]?.name)).filter(Boolean);
                const uniqueNames = [...new Set(baseNames)];
                const nameOptions = document.getElementById('mergeNameOptions');
                nameOptions.innerHTML = uniqueNames.map(name => `
                    <button onclick="document.getElementById('mergeFinalName').value = '${name.replace(/'/g, "\\'")}'"
                            class="px-3 py-1 bg-white border rounded-lg hover:bg-indigo-50 hover:border-indigo-300 text-sm">
                        ${name}
                    </button>
                `).join('');
            }
        }
        
        // ×¤×•× ×§×¦×™×•×ª ×œ×¢×¨×™×›×ª ××¡×¤×¨×™× ×××•×—×“×™× ×§×™×™××™×
        function handleMergedLabelChange(idx, value) {
            if (!state.mergedPhonesEdit || !state.mergedPhonesEdit[idx]) return;
            
            if (value === '××—×¨') {
                setTimeout(() => {
                    Swal.fire({
                        title: '×”×–×Ÿ ×ª×•×•×™×ª ××•×ª×××ª',
                        input: 'text',
                        inputPlaceholder: '×œ××©×œ: ×¤×§×¡, ××©×¨×“, ×•×›×•...',
                        showCancelButton: true,
                        confirmButtonText: '×©××•×¨',
                        cancelButtonText: '×‘×™×˜×•×œ',
                        inputValidator: (val) => !val && '×”×–×Ÿ ×©× ×œ×ª×•×•×™×ª'
                    }).then((result) => {
                        if (result.isConfirmed && result.value) {
                            state.mergedPhonesEdit[idx].label = result.value;
                            if (!state.customPhoneLabels.includes(result.value)) {
                                state.customPhoneLabels.push(result.value);
                                localStorage.setItem('customPhoneLabels', JSON.stringify(state.customPhoneLabels));
                            }
                            renderMergeSelected();
                        } else {
                            renderMergeSelected();
                        }
                    });
                }, 50);
            } else {
                state.mergedPhonesEdit[idx].label = value;
            }
        }
        
        function removeMergedPhone(idx) {
            if (!state.mergedPhonesEdit || state.mergedPhonesEdit.length <= 1) {
                Toast.fire({ icon: 'warning', title: '×—×™×™×‘ ×œ×”×™×©××¨ ×œ×¤×—×•×ª ××¡×¤×¨ ××—×“' });
                return;
            }
            
            state.mergedPhonesEdit.splice(idx, 1);
            renderMergeSelected();
        }
        
        async function manageCustomLabels() {
            if (state.customPhoneLabels.length === 0) {
                return Toast.fire({ icon: 'info', title: '××™×Ÿ ×ª×•×•×™×•×ª ××•×ª×××•×ª' });
            }
            
            const { value: selectedLabels } = await Swal.fire({
                title: '× ×™×”×•×œ ×ª×•×•×™×•×ª ××•×ª×××•×ª',
                html: `
                    <p class="text-sm text-slate-500 mb-4">×‘×—×¨ ×ª×•×•×™×•×ª ×œ××—×™×§×”:</p>
                    <div class="flex flex-wrap gap-2 justify-center">
                        ${state.customPhoneLabels.map((label, i) => `
                            <label class="flex items-center gap-2 px-3 py-2 bg-slate-100 rounded-lg cursor-pointer hover:bg-red-100">
                                <input type="checkbox" value="${i}" class="custom-label-checkbox">
                                <span>${label}</span>
                            </label>
                        `).join('')}
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: '××—×§ × ×‘×—×¨×™×',
                confirmButtonColor: '#ef4444',
                cancelButtonText: '×‘×™×˜×•×œ',
                preConfirm: () => {
                    const checkboxes = document.querySelectorAll('.custom-label-checkbox:checked');
                    return Array.from(checkboxes).map(cb => parseInt(cb.value));
                }
            });
            
            if (selectedLabels && selectedLabels.length > 0) {
                // ××—×§ ××”×¡×•×£ ×œ×”×ª×—×œ×” ×›×“×™ ×œ× ×œ×©×‘×© ××™× ×“×§×¡×™×
                selectedLabels.sort((a, b) => b - a).forEach(idx => {
                    state.customPhoneLabels.splice(idx, 1);
                });
                localStorage.setItem('customPhoneLabels', JSON.stringify(state.customPhoneLabels));
                Toast.fire({ icon: 'success', title: `${selectedLabels.length} ×ª×•×•×™×•×ª × ××—×§×•` });
                renderMergeSelected();
            }
        }
        
        function handleLabelChange(phone, value) {
            if (value === '××—×¨') {
                // ×‘×§×© ×ª×•×•×™×ª ××•×ª×××ª ××™×©×™×ª
                setTimeout(() => {
                    Swal.fire({
                        title: '×”×–×Ÿ ×ª×•×•×™×ª ××•×ª×××ª',
                        input: 'text',
                        inputPlaceholder: '×œ××©×œ: ×¤×§×¡, ××©×¨×“, ×•×›×•...',
                        showCancelButton: true,
                        confirmButtonText: '×©××•×¨',
                        cancelButtonText: '×‘×™×˜×•×œ',
                        inputValidator: (val) => !val && '×”×–×Ÿ ×©× ×œ×ª×•×•×™×ª'
                    }).then((result) => {
                        if (result.isConfirmed && result.value) {
                            const customLabel = result.value;
                            state.mergePhoneLabels[phone] = customLabel;
                            
                            // ×©××•×¨ ×œ×ª×•×•×™×•×ª ××•×ª×××•×ª ×× ×œ× ×§×™×™×
                            if (!state.customPhoneLabels.includes(customLabel)) {
                                state.customPhoneLabels.push(customLabel);
                                localStorage.setItem('customPhoneLabels', JSON.stringify(state.customPhoneLabels));
                            }
                            
                            renderMergeSelected();
                        } else {
                            // ×—×–×•×¨ ×œ×ª×•×•×™×ª ×”×§×•×“××ª
                            renderMergeSelected();
                        }
                    });
                }, 50);
            } else {
                state.mergePhoneLabels[phone] = value;
            }
        }
        
        function findSimilarContacts(searchName) {
            const container = document.getElementById('mergeSimilarContacts');
            const allData = state.analysisData?.allData || [];
            
            // ×§×‘×œ ××ª ××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ ×©×œ ××™×© ×”×§×©×¨ ×”× ×•×›×—×™
            const sourceContact = state.analysisData?.allData?.[state.mergeSourceIndex];
            const sourcePhone = sourceContact?.phone || '';
            const sourcePhonePrefix = sourcePhone.slice(0, 6); // ×§×™×“×•××ª 6 ×¡×¤×¨×•×ª
            
            // ×—×¤×© ×œ×¤×™ ×©× ×‘×¡×™×¡×™ (×‘×œ×™ ×¡×™×•××•×ª ××¡×¤×¨×™×•×ª)
            const baseName = getBaseName(searchName || '');
            const searchLower = baseName.toLowerCase().trim();
            const searchWords = searchLower.split(/\s+/).filter(w => w.length > 1);
            
            const similar = allData
                .map((c, idx) => ({ ...c, idx }))
                .filter(c => !state.mergeSelectedIndexes.includes(c.idx))
                .map(c => {
                    // ×”×©×•×•×” ×œ×¤×™ ×©× ×‘×¡×™×¡×™ (×‘×œ×™ ×¡×™×•××•×ª)
                    const contactBaseName = getBaseName(c.name || '');
                    const nameLower = contactBaseName.toLowerCase();
                    const phone = c.phone || '';
                    let score = 0;
                    let matchType = [];
                    
                    // === ×”×ª×××ª ×©× ===
                    // ×”×ª×××” ××“×•×™×§×ª ×©×œ ×”×©× ×”×‘×¡×™×¡×™
                    if (nameLower === searchLower) {
                        score += 100;
                        matchType.push('×©× ×–×”×”');
                    }
                    // ×”×ª×—×œ×” ×–×”×”
                    else if (nameLower.startsWith(searchLower) || searchLower.startsWith(nameLower)) {
                        score += 50;
                        matchType.push('×©× ×“×•××”');
                    }
                    // ××™×œ×™× ××©×•×ª×¤×•×ª
                    else {
                        let wordScore = 0;
                        searchWords.forEach(word => {
                            if (nameLower.includes(word)) wordScore += 20;
                        });
                        if (wordScore > 0) {
                            score += wordScore;
                            matchType.push('××™×œ×” ××©×•×ª×¤×ª');
                        }
                    }
                    
                    // === ×”×ª×××ª ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ===
                    if (phone && sourcePhone) {
                        // ××•×ª×” ×§×™×“×•××ª (6 ×¡×¤×¨×•×ª ×¨××©×•× ×•×ª)
                        if (phone.slice(0, 6) === sourcePhonePrefix && phone !== sourcePhone) {
                            score += 30;
                            matchType.push('×§×™×“×•××ª ×“×•××”');
                        }
                        // ×”×‘×“×œ ×©×œ ×¡×¤×¨×” ××—×ª ×‘×¡×•×£
                        else if (phone.slice(0, -1) === sourcePhone.slice(0, -1) && phone !== sourcePhone) {
                            score += 40;
                            matchType.push('××¡×¤×¨ ×§×¨×•×‘');
                        }
                        // ×”×‘×“×œ ×©×œ 2 ×¡×¤×¨×•×ª ×‘×¡×•×£
                        else if (phone.slice(0, -2) === sourcePhone.slice(0, -2) && phone !== sourcePhone) {
                            score += 25;
                            matchType.push('××¡×¤×¨ ×§×¨×•×‘');
                        }
                    }
                    
                    return { ...c, score, matchType };
                })
                .filter(c => c.score > 0)
                .sort((a, b) => {
                    // ×¡×“×¨ ×¢×“×™×¤×•×™×•×ª ×œ×¤×™ ×¡×•×’ ×”×ª×××”
                    const typePriority = {
                        '×©× ×–×”×”': 1,
                        '×©× ×“×•××”': 2,
                        '××™×œ×” ××©×•×ª×¤×ª': 3,
                        '×§×™×“×•××ª ×“×•××”': 4,
                        '××¡×¤×¨ ×§×¨×•×‘': 5
                    };
                    
                    // ×§×‘×œ ××ª ×”×¢×“×™×¤×•×ª ×”×’×‘×•×”×” ×‘×™×•×ª×¨ ××›×œ ×”×”×ª×××•×ª
                    const getPriority = (types) => Math.min(...types.map(t => typePriority[t] || 99));
                    const aPriority = getPriority(a.matchType);
                    const bPriority = getPriority(b.matchType);
                    
                    // ××™×™×Ÿ ×§×•×“× ×œ×¤×™ ×¢×“×™×¤×•×ª ×¡×•×’, ××—"×› ×œ×¤×™ × ×™×§×•×“
                    if (aPriority !== bPriority) return aPriority - bPriority;
                    return b.score - a.score;
                })
                .slice(0, 40);
            
            container.innerHTML = similar.length ? similar.map(c => `
                <div onclick="addMergeContact(${c.idx})" 
                     class="flex items-center gap-3 p-2 bg-white rounded-lg border border-slate-200 cursor-pointer hover:bg-indigo-50 hover:border-indigo-300">
                    <span class="font-medium flex-1">${c.name || '(×œ×œ× ×©×)'}</span>
                    <span class="font-mono text-slate-500 text-sm">${c.phone}</span>
                    <span class="text-xs text-indigo-400 bg-indigo-50 px-1 rounded">${c.matchType?.[0] || ''}</span>
                    <span class="text-indigo-500 font-bold">+</span>
                </div>
            `).join('') : '<p class="text-slate-400 text-center py-4">×œ× × ××¦××• ×× ×©×™ ×§×©×¨ ×“×•××™×</p>';
        }
        
        function filterMergeContacts(query) {
            const container = document.getElementById('mergeSimilarContacts');
            const allData = state.analysisData?.allData || [];
            const queryLower = query.toLowerCase().trim();
            
            if (!queryLower) {
                // ×× ××™×Ÿ ×—×™×¤×•×©, ×—×–×•×¨ ×œ×“×•××™×
                const sourceContact = state.analysisData?.allData?.[state.mergeSourceIndex];
                findSimilarContacts(sourceContact?.name);
                return;
            }
            
            const filtered = allData
                .map((c, idx) => ({ ...c, idx }))
                .filter(c => !state.mergeSelectedIndexes.includes(c.idx))
                .filter(c => {
                    const nameLower = (c.name || '').toLowerCase();
                    const phone = c.phone || '';
                    return nameLower.includes(queryLower) || phone.includes(queryLower);
                })
                .slice(0, 50);
            
            container.innerHTML = filtered.length ? filtered.map(c => `
                <div onclick="addMergeContact(${c.idx})" 
                     class="flex items-center gap-3 p-2 bg-white rounded-lg border border-slate-200 cursor-pointer hover:bg-indigo-50 hover:border-indigo-300">
                    <span class="font-medium flex-1">${c.name || '(×œ×œ× ×©×)'}</span>
                    <span class="font-mono text-slate-500 text-sm">${c.phone}</span>
                    <span class="text-indigo-400">+</span>
                </div>
            `).join('') : '<p class="text-slate-400 text-center py-4">×œ× × ××¦××• ×ª×•×¦××•×ª</p>';
        }
        
        function addMergeContact(index) {
            if (state.mergeSelectedIndexes.includes(index)) return;
            
            const contact = state.analysisData?.allData?.[index];
            if (!contact) return;
            
            state.mergeSelectedIndexes.push(index);
            state.mergePhoneLabels[contact.phone] = contact.originalData?.PhoneType || '× ×™×™×“';
            
            renderMergeSelected();
            
            // ×¨×¢× ×Ÿ ××ª ×”×¨×©×™××” ×”×“×•××”
            const query = document.getElementById('mergeSearch').value;
            if (query) {
                filterMergeContacts(query);
            } else {
                const sourceContact = state.analysisData?.allData?.[state.mergeSourceIndex];
                findSimilarContacts(sourceContact?.name);
            }
            
            Toast.fire({ icon: 'success', title: '× ×•×¡×£ ×œ××™×—×•×“' });
        }
        
        function removeMergeContact(index) {
            // ×× ×™×© ×¨×§ ××™×© ×§×©×¨ ××—×“, ×œ× × ×™×ª×Ÿ ×œ×”×¡×™×¨
            if (state.mergeSelectedIndexes.length <= 1) {
                Toast.fire({ icon: 'warning', title: '×—×™×™×‘ ×œ×”×™×©××¨ ×œ×¤×—×•×ª ××™×© ×§×©×¨ ××—×“' });
                return;
            }
            
            const contact = state.analysisData?.allData?.[index];
            if (contact) delete state.mergePhoneLabels[contact.phone];
            
            state.mergeSelectedIndexes = state.mergeSelectedIndexes.filter(i => i !== index);
            
            // ×× ×”×¡×¨× ×• ××ª ×”×¨××©×™, ×¢×“×›×Ÿ ××ª ×”×¨××©×™ ×”×—×“×©
            if (index === state.mergeSourceIndex && state.mergeSelectedIndexes.length > 0) {
                state.mergeSourceIndex = state.mergeSelectedIndexes[0];
                const newSource = state.analysisData?.allData?.[state.mergeSourceIndex];
                if (newSource) {
                    document.getElementById('mergeCurrentName').textContent = newSource.name || '(×œ×œ× ×©×)';
                    document.getElementById('mergeCurrentPhone').textContent = newSource.phone;
                }
            }
            
            renderMergeSelected();
            
            // ×¨×¢× ×Ÿ ××ª ×”×¨×©×™××” ×”×“×•××”
            const query = document.getElementById('mergeSearch').value;
            if (query) {
                filterMergeContacts(query);
            } else {
                const sourceContact = state.analysisData?.allData?.[state.mergeSourceIndex];
                findSimilarContacts(sourceContact?.name);
            }
            
            Toast.fire({ icon: 'info', title: '×”×•×¡×¨ ××”××™×—×•×“' });
        }
        
        function performMerge() {
            const finalName = document.getElementById('mergeFinalName').value.trim();
            if (!finalName) {
                return Toast.fire({ icon: 'error', title: '×”×–×Ÿ ×©× ×œ××™×© ×”×§×©×¨ ×”×××•×—×“' });
            }
            
            // ××¦×‘ ×¢×¨×™×›×” ×©×œ ××¡×¤×¨×™× ×××•×—×“×™× ×§×™×™××™×
            if (state.mergedPhonesEdit && state.mergedPhonesEdit.length > 0) {
                const contact = state.analysisData.allData[state.mergeSourceIndex];
                contact.name = finalName;
                contact.mergedPhones = state.mergedPhonesEdit;
                
                // ×× × ×©××¨ ×¨×§ ××¡×¤×¨ ××—×“ - ×”×¡×¨ ××ª ×”-mergedPhones
                if (state.mergedPhonesEdit.length === 1) {
                    contact.phone = state.mergedPhonesEdit[0].phone;
                    contact.mergedPhones = null;
                }
                
                closeMergeModal();
                scheduleDraftSave();
                showAnalysisTab('accepted');
                Toast.fire({ icon: 'success', title: '×”××¡×¤×¨×™× ×¢×•×“×›× ×•' });
                return;
            }
            
            // ××¦×‘ ××™×—×•×“ ×—×“×© - ×¦×¨×™×š ×œ×¤×—×•×ª 2 ×× ×©×™ ×§×©×¨
            if (state.mergeSelectedIndexes.length < 2) {
                return Toast.fire({ icon: 'warning', title: '×‘×—×¨ ×œ×¤×—×•×ª 2 ×× ×©×™ ×§×©×¨ ×œ××™×—×•×“' });
            }
            
            // ××¡×•×£ ××ª ×›×œ ×”××¡×¤×¨×™×
            const phones = state.mergeSelectedIndexes.map(idx => {
                const contact = state.analysisData.allData[idx];
                return {
                    phone: contact.phone,
                    label: state.mergePhoneLabels[contact.phone] || '× ×™×™×“'
                };
            });
            
            // ×¢×“×›×Ÿ ××ª ××™×© ×”×§×©×¨ ×”×¨××©×•×Ÿ ×¢× ×›×œ ×”××¡×¤×¨×™×
            const primaryIndex = state.mergeSelectedIndexes[0];
            const primaryContact = state.analysisData.allData[primaryIndex];
            primaryContact.name = finalName;
            primaryContact.mergedPhones = phones;
            primaryContact.originalData = primaryContact.originalData || {};
            primaryContact.originalData.mergedFrom = state.mergeSelectedIndexes.map(idx => ({
                name: state.analysisData.allData[idx].name,
                phone: state.analysisData.allData[idx].phone
            }));
            
            // ×”×¡×¨ ××ª ×©××¨ ×× ×©×™ ×”×§×©×¨ (××¡××Ÿ ××•×ª× ×œ××—×™×§×”)
            const indexesToRemove = state.mergeSelectedIndexes.slice(1).sort((a, b) => b - a);
            indexesToRemove.forEach(idx => {
                state.analysisData.allData.splice(idx, 1);
            });
            
            // ×¢×“×›×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª
            document.getElementById('acceptedCount').textContent = state.analysisData.allData.length;
            
            closeMergeModal();
            scheduleDraftSave();
            showAnalysisTab('accepted');
            
            Toast.fire({ 
                icon: 'success', 
                title: `××•×—×“×• ${phones.length} ××¡×¤×¨×™× ×ª×—×ª "${finalName}"` 
            });
        }

        // ×©××™×¨×ª ×˜×™×•×˜×” ×œ×©×¨×ª
        let saveDraftTimeout = null;
        async function saveDraft() {
            if (!state.analysisData?.groupId) return;
            
            try {
                await api(`/api/draft/${state.analysisData.groupId}/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        allData: state.analysisData.allData,
                        conflicts: state.analysisData.conflicts,
                        autoResolved: state.analysisData.autoResolved,
                        rejectedContacts: state.analysisData.rejectedContacts,
                        stats: state.analysisData.stats
                    })
                });
                console.log('[DRAFT] Saved to server');
            } catch (err) {
                console.error('[DRAFT] Save error:', err);
            }
        }
        
        // ×©××™×¨×” ××•×©×”×™×ª (debounced)
        function scheduleDraftSave() {
            if (saveDraftTimeout) clearTimeout(saveDraftTimeout);
            saveDraftTimeout = setTimeout(saveDraft, 1000); // ×©××•×¨ ××—×¨×™ ×©× ×™×™×” ×©×œ ×—×•×¡×¨ ×¤×¢×™×œ×•×ª
        }

        async function updateAnalysisName(index, newName) {
            if (!state.analysisData?.allData?.[index]) return;
            
            // ×©××•×¨ ××ª ××™×§×•× ×”×’×œ×™×œ×”
            const scrollContainer = document.querySelector('#analysisContent .overflow-y-auto');
            const scrollTop = scrollContainer ? scrollContainer.scrollTop : 0;
            
            const contact = state.analysisData.allData[index];
            const oldName = contact.name;
            
            // ×× ×”×©× ×¨×™×§ - ×”×•×¡×£ ×œ×¨×©×™××” ×©×—×•×¨×” ×•×ª×Ÿ ×©× ×‘×¨×™×¨×ª ××—×“×œ
            if (!newName || !newName.trim()) {
                const phone = contact.phone || '';
                const defaultName = `××™×© ×§×©×¨ ${phone.slice(-4)}`;
                
                // ×”×•×¡×£ ×œ×¨×©×™××” ×©×—×•×¨×”
                if (oldName && oldName.trim() && !oldName.startsWith('××™×© ×§×©×¨')) {
                    const baseName = oldName.replace(/\s?\(\d+\)$/g, '').trim();
                    if (baseName) {
                        try {
                            await api('/api/invalid-names', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ name: baseName, patternType: 'exact' })
                            });
                            
                            // ×¢×“×›×Ÿ ××ª ×›×œ ×× ×©×™ ×”×§×©×¨ ×¢× ×©× ×“×•××” ×‘-allData
                            let updatedCount = 0;
                            state.analysisData.allData.forEach((c, i) => {
                                const cBaseName = (c.name || '').replace(/\s?\(\d+\)$/g, '').trim();
                                if (cBaseName === baseName) {
                                    const cDefaultName = `××™×© ×§×©×¨ ${c.phone?.slice(-4) || Math.random().toString().slice(2, 6)}`;
                                    state.analysisData.allData[i].name = cDefaultName;
                                    updatedCount++;
                                }
                            });
                            
                            Toast.fire({ 
                                icon: 'success', 
                                title: updatedCount > 1 ? `${updatedCount} ×× ×©×™ ×§×©×¨ ×¢×•×“×›× ×•` : '×”×©× ×¢×•×“×›×Ÿ',
                                text: `"${baseName}" × ×•×¡×£ ×œ×¨×©×™××” ×©×—×•×¨×”`
                            });
                            
                            // ×©××•×¨ ×•×¨×¢× ×Ÿ ×¢× ×©××™×¨×ª ××™×§×•× ×’×œ×™×œ×”
                            scheduleDraftSave();
                            showAnalysisTab('accepted');
                            
                            // ×©×—×–×¨ ××™×§×•× ×’×œ×™×œ×”
                            setTimeout(() => {
                                const newScrollContainer = document.querySelector('#analysisContent .overflow-y-auto');
                                if (newScrollContainer) newScrollContainer.scrollTop = scrollTop;
                            }, 50);
                            return;
                        } catch (err) {
                            console.error('Error adding to blacklist:', err);
                        }
                    }
                }
                
                contact.name = defaultName;
                // ×¢×“×›×Ÿ ××ª ×”-input ×™×©×™×¨×•×ª
                const inputs = document.querySelectorAll('#analysisContent input[type="text"]');
                if (inputs[index - ((state.analysisPage - 1) * 500)]) {
                    inputs[index - ((state.analysisPage - 1) * 500)].value = defaultName;
                }
                Toast.fire({ icon: 'success', title: '×”×©× ×¢×•×“×›×Ÿ ×œ×‘×¨×™×¨×ª ××—×“×œ' });
            } else {
                contact.name = newName.trim();
                Toast.fire({ icon: 'success', title: '×”×©× ×¢×•×“×›×Ÿ' });
            }
            
            // ×©××•×¨ ××ª ×”×˜×™×•×˜×”
            scheduleDraftSave();
        }

        async function clearAnalysisName(index) {
            // ×§×¨× ×œ×¤×•× ×§×¦×™×” ×”×›×œ×œ×™×ª ×¢× ×©× ×¨×™×§
            await updateAnalysisName(index, '');
        }
        
        function updateAnalysisPhone(index, newPhone) {
            if (!state.analysisData?.allData?.[index]) return;
            
            const contact = state.analysisData.allData[index];
            const oldPhone = contact.phone;
            
            // × ×¨××œ ××ª ×”××¡×¤×¨
            newPhone = newPhone.replace(/[^\d+]/g, '').trim();
            
            if (!newPhone && !contact.email) {
                Toast.fire({ icon: 'error', title: '××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×™×›×•×œ ×œ×”×™×•×ª ×¨×™×§ (××œ× ×× ×™×© ××™×™×œ)' });
                return;
            }
            
            // ×‘×“×•×§ ×›×¤×™×œ×•×™×•×ª
            if (newPhone) {
                const duplicate = state.analysisData.allData.find((c, i) => i !== index && c.phone === newPhone);
                if (duplicate) {
                    Toast.fire({ icon: 'warning', title: '××¡×¤×¨ ×–×” ×›×‘×¨ ×§×™×™×', text: `×©×™×™×š ×œ: ${duplicate.name}` });
                    return;
                }
            }
            
            contact.phone = newPhone;
            contact.hasEmailOnly = !newPhone && contact.email;
            Toast.fire({ icon: 'success', title: newPhone ? '××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ ×¢×•×“×›×Ÿ' : '×”×˜×œ×¤×•×Ÿ ×”×•×¡×¨' });
            scheduleDraftSave();
        }

        function updateAnalysisEmail(index, newEmail) {
            if (!state.analysisData?.allData?.[index]) return;
            
            const contact = state.analysisData.allData[index];
            newEmail = newEmail.trim();
            
            // ×•×™×“×•× ×¤×•×¨××˜ ××™×™×œ
            if (newEmail && !newEmail.includes('@')) {
                Toast.fire({ icon: 'error', title: '×›×ª×•×‘×ª ××™×™×œ ×œ× ×ª×§×™× ×”' });
                return;
            }
            
            contact.email = newEmail;
            contact.hasEmailOnly = !contact.phone && newEmail;
            Toast.fire({ icon: 'success', title: newEmail ? '×”××™×™×œ ×¢×•×“×›×Ÿ' : '×”××™×™×œ ×”×•×¡×¨' });
            scheduleDraftSave();
        }

        function showAnalysisTab(tab) {
            document.querySelectorAll('.analysis-tab').forEach(t => {
                t.classList.remove('border-indigo-500', 'text-indigo-600');
                t.classList.add('border-transparent');
            });
            document.querySelector(`.analysis-tab[data-tab="${tab}"]`).classList.add('border-indigo-500', 'text-indigo-600');
            
            const content = document.getElementById('analysisContent');
            const data = state.analysisData;
            
            if (tab === 'accepted') {
                // ×§×‘×œ ×¨×©×™××ª ××§×•×¨×•×ª ×™×™×—×•×“×™×™×
                const sources = [...new Set((data.allData || []).map(c => c.sourceFile).filter(Boolean))];
                
                // ×¡× ×Ÿ ×œ×¤×™ ××§×•×¨
                let filtered = data.allData || [];
                if (state.filterSource) {
                    filtered = filtered.filter(c => c.sourceFile === state.filterSource);
                }
                
                // ××™×™×Ÿ
                const sorted = [...filtered].map((c, idx) => ({ ...c, originalIndex: (data.allData || []).indexOf(c) }));
                if (state.sortBy === 'name') {
                    sorted.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'he'));
                } else if (state.sortBy === 'phone') {
                    sorted.sort((a, b) => (a.phone || '').localeCompare(b.phone || ''));
                }
                if (state.sortDir === 'desc') sorted.reverse();
                
                const page = state.analysisPage || 1;
                const perPage = 500;
                const start = (page - 1) * perPage;
                const end = start + perPage;
                const totalPages = Math.ceil(sorted.length / perPage);
                
                const sortIcon = (field) => state.sortBy === field ? (state.sortDir === 'asc' ? 'â–²' : 'â–¼') : 'â‡…';
                
                content.innerHTML = `
                    <!-- ×¡×¨×’×œ ××™×•×Ÿ ×•×¡×™× ×•×Ÿ -->
                    <div class="flex flex-wrap gap-3 mb-4 p-3 bg-slate-50 rounded-xl">
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-slate-500">××™×•×Ÿ:</span>
                            <button onclick="setSort('index')" class="px-3 py-1.5 rounded-lg text-sm font-medium ${state.sortBy === 'index' ? 'bg-indigo-600 text-white' : 'bg-white border hover:bg-slate-100'}">
                                ××§×•×¨×™ ${state.sortBy === 'index' ? sortIcon('index') : ''}
                            </button>
                            <button onclick="setSort('name')" class="px-3 py-1.5 rounded-lg text-sm font-medium ${state.sortBy === 'name' ? 'bg-indigo-600 text-white' : 'bg-white border hover:bg-slate-100'}">
                                ×©× ${sortIcon('name')}
                            </button>
                            <button onclick="setSort('phone')" class="px-3 py-1.5 rounded-lg text-sm font-medium ${state.sortBy === 'phone' ? 'bg-indigo-600 text-white' : 'bg-white border hover:bg-slate-100'}">
                                ×˜×œ×¤×•×Ÿ ${sortIcon('phone')}
                            </button>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-slate-500">×¡×™× ×•×Ÿ ×œ×¤×™ ××§×•×¨:</span>
                            <select onchange="setFilterSource(this.value)" class="px-3 py-1.5 rounded-lg border bg-white text-sm">
                                <option value="">×”×›×œ (${(data.allData || []).length.toLocaleString()})</option>
                                ${sources.map(s => `<option value="${s}" ${state.filterSource === s ? 'selected' : ''}>${s} (${(data.allData || []).filter(c => c.sourceFile === s).length.toLocaleString()})</option>`).join('')}
                            </select>
                        </div>
                        ${state.filterSource ? `<button onclick="setFilterSource('')" class="px-3 py-1.5 bg-red-100 text-red-700 rounded-lg text-sm hover:bg-red-200">âœ• × ×§×” ×¡×™× ×•×Ÿ</button>` : ''}
                    </div>
                    
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-slate-600">××¦×™×’ ${start + 1}-${Math.min(end, sorted.length)} ××ª×•×š <strong>${sorted.length.toLocaleString()}</strong> ×× ×©×™ ×§×©×¨</p>
                        <div class="flex gap-2">
                            ${page > 1 ? `<button onclick="analysisPageChange(${page - 1})" class="px-4 py-2 bg-slate-100 rounded-lg hover:bg-slate-200">â—€ ×”×§×•×“×</button>` : ''}
                            <span class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg font-bold">×¢××•×“ ${page} / ${totalPages || 1}</span>
                            ${page < totalPages ? `<button onclick="analysisPageChange(${page + 1})" class="px-4 py-2 bg-slate-100 rounded-lg hover:bg-slate-200">×”×‘× â–¶</button>` : ''}
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-[60vh] overflow-y-auto">
                        <table class="w-full">
                            <thead class="bg-slate-50 sticky top-0"><tr>
                                <th class="px-4 py-3 text-right font-semibold">#</th>
                                <th class="px-4 py-3 text-right font-semibold cursor-pointer hover:bg-slate-100" onclick="setSort('name')">×©× ${sortIcon('name')}</th>
                                <th class="px-4 py-3 text-right font-semibold cursor-pointer hover:bg-slate-100" onclick="setSort('phone')">×˜×œ×¤×•×Ÿ ${sortIcon('phone')}</th>
                                <th class="px-4 py-3 text-right font-semibold">××™×™×œ</th>
                                <th class="px-4 py-3 text-right font-semibold">××§×•×¨</th>
                                <th class="px-4 py-3 text-center font-semibold w-16"></th>
                            </tr></thead>
                            <tbody>${sorted.slice(start, end).map((c, i) => `
                                <tr class="border-b border-slate-100 ${c.hasEmailOnly ? 'bg-purple-50' : ''}">
                                    <td class="px-4 py-2 text-slate-400">${start + i + 1}</td>
                                    <td class="px-4 py-1">
                                        <input type="text" value="${(c.name || '').replace(/"/g, '&quot;')}" 
                                               class="w-full px-2 py-1 rounded border border-transparent hover:border-slate-300 focus:border-indigo-500 outline-none bg-transparent"
                                               onchange="updateAnalysisName(${c.originalIndex}, this.value)"
                                               onkeydown="if(event.key==='Enter') this.blur()">
                                    </td>
                                    <td class="px-4 py-1 font-mono text-slate-600">
                                        ${c.hasEmailOnly ? '<span class="text-xs text-purple-500">(×¨×§ ××™×™×œ)</span>' : `
                                        <input type="text" value="${(c.phone || '').replace(/"/g, '&quot;')}" 
                                               class="w-full px-2 py-1 rounded border border-transparent hover:border-slate-300 focus:border-indigo-500 outline-none bg-transparent text-sm"
                                               onchange="updateAnalysisPhone(${c.originalIndex}, this.value)"
                                               onkeydown="if(event.key==='Enter') this.blur()">
                                        ${c.mergedPhones?.length > 1 ? `<span class="text-xs bg-indigo-100 text-indigo-600 px-1.5 py-0.5 rounded-full mr-1" title="${c.mergedPhones.map(p => p.phone + ' (' + p.label + ')').join(', ')}">${c.mergedPhones.length} ××¡×¤×¨×™×</span>` : ''}
                                        ${c.originalData?.totalPhones > 1 ? `<span class="text-xs text-slate-400" title="×™×© ${c.originalData.totalPhones} ××¡×¤×¨×™× ×‘×§×•×‘×¥ ×”××§×•×¨">ğŸ“±${c.originalData.totalPhones}</span>` : ''}`}
                                    </td>
                                    <td class="px-4 py-1 text-sm">
                                        <input type="email" value="${(c.email || '').replace(/"/g, '&quot;')}" 
                                               placeholder="×”×•×¡×£ ××™×™×œ..."
                                               class="w-full px-2 py-1 rounded border border-transparent hover:border-slate-300 focus:border-purple-500 outline-none bg-transparent text-purple-600 text-sm"
                                               onchange="updateAnalysisEmail(${c.originalIndex}, this.value)"
                                               onkeydown="if(event.key==='Enter') this.blur()">
                                    </td>
                                    <td class="px-4 py-2 text-slate-400 text-sm">${c.sourceFile || ''}</td>
                                    <td class="px-4 py-2 text-center flex gap-1 justify-center">
                                        <button onclick="openMergeModal(${c.originalIndex})" class="text-indigo-400 hover:text-indigo-600 text-lg" title="××—×“ ×¢× ××™×© ×§×©×¨ ××—×¨">â•</button>
                                        <button onclick="clearAnalysisName(${c.originalIndex})" class="text-red-400 hover:text-red-600 text-lg" title="××—×§ ×©× ×•×”×•×¡×£ ×œ×¨×©×™××” ×©×—×•×¨×”">ğŸ—‘ï¸</button>
                                    </td>
                                </tr>
                            `).join('')}</tbody>
                        </table>
                    </div>
                `;
            } else if (tab === 'rejected') {
                const reasons = {};
                (data.rejectedContacts || []).forEach(c => { reasons[c.reason] = (reasons[c.reason] || 0) + 1; });
                
                // ×¡× ×Ÿ ×œ×¤×™ ×¡×™×‘×”
                const filterReason = state.filterRejectedReason || '';
                const filtered = filterReason 
                    ? (data.rejectedContacts || []).filter(c => c.reason === filterReason)
                    : (data.rejectedContacts || []);
                
                const page = state.rejectedPage || 1;
                const perPage = 500;
                const start = (page - 1) * perPage;
                const end = start + perPage;
                const totalPages = Math.ceil(filtered.length / perPage);
                
                content.innerHTML = `
                    <div class="grid grid-cols-4 gap-3 mb-6">
                        ${Object.entries(reasons).map(([reason, count]) => `
                            <div class="bg-red-50 rounded-xl p-3 text-center cursor-pointer hover:bg-red-100 ${filterReason === reason ? 'ring-2 ring-red-400' : ''}" 
                                 onclick="setFilterRejectedReason('${filterReason === reason ? '' : reason}')">
                                <p class="text-xl font-bold text-red-600">${count.toLocaleString()}</p>
                                <p class="text-xs text-slate-500">${getReasonText(reason)}</p>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="bg-amber-50 rounded-xl p-4 mb-4">
                        <p class="text-amber-800 font-semibold">ğŸ’¡ ×˜×™×¤: ××¤×©×¨ ×œ×”×–×™×Ÿ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×™×“× ×™×ª ×•×œ×©×—×–×¨ ××™×© ×§×©×¨ ×œ×¨×©×™××”</p>
                    </div>
                    
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-slate-600">××¦×™×’ ${start + 1}-${Math.min(end, filtered.length)} ××ª×•×š <strong>${filtered.length.toLocaleString()}</strong> ${filterReason ? `(${getReasonText(filterReason)})` : ''}</p>
                        <div class="flex gap-2">
                            ${filterReason ? `<button onclick="setFilterRejectedReason('')" class="px-3 py-2 bg-red-100 text-red-700 rounded-lg text-sm hover:bg-red-200">âœ• ×”×¦×’ ×”×›×œ</button>` : ''}
                            ${page > 1 ? `<button onclick="rejectedPageChange(${page - 1})" class="px-4 py-2 bg-slate-100 rounded-lg hover:bg-slate-200">â—€ ×”×§×•×“×</button>` : ''}
                            <span class="px-4 py-2 bg-red-100 text-red-700 rounded-lg font-bold">×¢××•×“ ${page} / ${totalPages || 1}</span>
                            ${page < totalPages ? `<button onclick="rejectedPageChange(${page + 1})" class="px-4 py-2 bg-slate-100 rounded-lg hover:bg-slate-200">×”×‘× â–¶</button>` : ''}
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-[60vh] overflow-y-auto">
                        <table class="w-full">
                            <thead class="bg-slate-50 sticky top-0"><tr>
                                <th class="px-4 py-3 text-right font-semibold">×©×</th>
                                <th class="px-4 py-3 text-right font-semibold">×˜×œ×¤×•×Ÿ</th>
                                <th class="px-4 py-3 text-right font-semibold">×¡×™×‘×ª ×“×—×™×™×”</th>
                                <th class="px-4 py-3 text-right font-semibold">× ×ª×•× ×™× × ×•×¡×¤×™×</th>
                                <th class="px-4 py-3 text-center font-semibold">×¤×¢×•×œ×•×ª</th>
                            </tr></thead>
                            <tbody>${filtered.slice(start, end).map((c, i) => `
                                <tr class="border-b border-slate-100" id="rejected-row-${start + i}">
                                    <td class="px-4 py-2">${c.name || '(×œ×œ× ×©×)'}</td>
                                    <td class="px-4 py-1">
                                        <input type="text" value="${(c.phone || '').replace(/"/g, '&quot;')}" 
                                               placeholder="×”×–×Ÿ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ..."
                                               class="w-full px-2 py-1 rounded border border-slate-300 focus:border-indigo-500 outline-none text-sm font-mono"
                                               id="rejected-phone-${start + i}">
                                    </td>
                                    <td class="px-4 py-2"><span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs">${getReasonText(c.reason)}</span></td>
                                    <td class="px-4 py-2 text-xs text-slate-400 max-w-xs">
                                        <button onclick="showRejectedData(${start + i})" class="text-indigo-500 hover:underline">ğŸ“‹ ×”×¦×’ × ×ª×•× ×™×</button>
                                    </td>
                                    <td class="px-4 py-2 text-center">
                                        <button onclick="restoreRejected(${start + i})" class="px-3 py-1 bg-green-100 text-green-700 rounded-lg text-sm hover:bg-green-200">âœ… ×©×—×–×¨</button>
                                    </td>
                                </tr>
                            `).join('')}</tbody>
                        </table>
                    </div>
                `;
            } else if (tab === 'conflicts') {
                content.innerHTML = (data.conflicts || []).length ? `
                    <div class="bg-green-50 rounded-xl p-4 mb-4 flex items-center gap-3">
                        <span class="text-2xl">âœ¨</span>
                        <div>
                            <p class="font-bold text-green-700">×‘×—×™×¨×” ××•×˜×•××˜×™×ª ×¤×¢×™×œ×”</p>
                            <p class="text-sm text-green-600">×”××¢×¨×›×ª ×‘×—×¨×” ××ª ×”×©× ×”×˜×•×‘ ×‘×™×•×ª×¨ ×œ×¤×™ ×”×›×œ×œ×™× ×©×”×’×“×¨×ª. ×ª×•×›×œ ×œ×©× ×•×ª ××ª ×”×‘×—×™×¨×” ×™×“× ×™×ª.</p>
                        </div>
                    </div>
                    <div class="space-y-4">
                        ${(data.conflicts || []).map((c, i) => {
                            const isPhoneEmailConflict = c.conflictType === 'same_name_phone_email';
                            return `
                            <div class="bg-amber-50 rounded-xl p-4 ${isPhoneEmailConflict ? 'border-2 border-purple-300' : ''}">
                                <div class="flex justify-between items-center mb-3">
                                    ${isPhoneEmailConflict ? `
                                        <div>
                                            <p class="font-bold text-purple-700 mb-1">ğŸ“§ğŸ“± ××•×ª×• ×©× - ×˜×œ×¤×•×Ÿ ×•××™×™×œ</p>
                                            <p class="font-mono text-sm text-slate-600">×˜×œ×¤×•×Ÿ: ${c.phone} | ××™×™×œ: ${c.email}</p>
                                        </div>
                                        <span class="text-sm text-purple-600 bg-purple-100 px-2 py-1 rounded-full">× ×™×ª×Ÿ ×œ××—×“</span>
                                    ` : `
                                        <p class="font-mono text-lg font-bold text-slate-700">${c.phone || c.email || '(×œ×œ× ××–×”×”)'}</p>
                                        <span class="text-sm text-amber-600">${c.names.length} ×©××•×ª ×©×•× ×™×</span>
                                    `}
                                </div>
                                <div class="flex flex-wrap gap-2 mb-3">
                                    ${c.names.map((name, idx) => {
                                        const isSelected = c.autoSelected === name;
                                        const score = c.scores ? c.scores[idx] : 0;
                                        return `
                                        <button onclick="resolveConflict('${c.conflictKey || c.phone || c.email}', '${name.replace(/'/g, "\\'")}', this)" 
                                                class="px-4 py-2 bg-white rounded-lg border-2 ${isSelected ? 'border-green-500 bg-green-50 ring-2 ring-green-200' : 'border-slate-200'} font-medium hover:border-indigo-500 hover:bg-indigo-50 transition-all relative">
                                            ${name}
                                            ${isSelected ? '<span class="absolute -top-2 -right-2 bg-green-500 text-white text-xs px-1.5 py-0.5 rounded-full">âœ“ × ×‘×—×¨</span>' : ''}
                                            ${score ? '<span class="block text-xs text-slate-400 mt-1">× ×™×§×•×“: ' + Math.round(score) + '</span>' : ''}
                                        </button>
                                    `}).join('')}
                                    <button onclick="resolveConflictCustom('${c.conflictKey || c.phone || c.email}')" 
                                            class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg border-2 border-indigo-200 font-medium hover:bg-indigo-200 transition-all">
                                        âœï¸ ××—×¨...
                                    </button>
                                </div>
                                ${isPhoneEmailConflict ? `
                                    <div class="flex gap-2 pt-2 border-t border-purple-200">
                                        <button onclick="mergePhoneEmail('${c.conflictKey}', '${c.phone}', '${c.email}')" 
                                                class="px-4 py-2 bg-purple-500 text-white rounded-lg font-medium hover:bg-purple-600 transition-all">
                                            ğŸ”— ××—×“ ×œ××™×© ×§×©×¨ ××—×“
                                        </button>
                                        <button onclick="keepSeparatePhoneEmail('${c.conflictKey}', '${c.phone}', '${c.email}')" 
                                                class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium hover:bg-slate-300 transition-all">
                                            ğŸ“‹ ×©××•×¨ ×›×©× ×™ ×× ×©×™ ×§×©×¨ × ×¤×¨×“×™×
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        `}).join('')}
                    </div>
                ` : '<p class="text-center text-slate-400 py-8">××™×Ÿ ×§×•× ×¤×œ×™×§×˜×™× ğŸ‰</p>';
            } else if (tab === 'duplicates') {
                content.innerHTML = (data.autoResolved || []).length ? `
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-50"><tr>
                                <th class="px-4 py-3 text-right font-semibold">×˜×œ×¤×•×Ÿ</th>
                                <th class="px-4 py-3 text-right font-semibold">×©× ×©× ×‘×—×¨</th>
                                <th class="px-4 py-3 text-right font-semibold">××•×¤×¢×™×</th>
                            </tr></thead>
                            <tbody>${(data.autoResolved || []).map(c => `
                                <tr class="border-b border-slate-100">
                                    <td class="px-4 py-2 font-mono">${c.phone}</td>
                                    <td class="px-4 py-2">${c.name}</td>
                                    <td class="px-4 py-2 text-slate-500">${c.count || 2} ×¤×¢××™×</td>
                                </tr>
                            `).join('')}</tbody>
                        </table>
                    </div>
                ` : '<p class="text-center text-slate-400 py-8">×œ× × ××¦××• ×›×¤×™×œ×•×™×•×ª</p>';
            }
        }

        function getReasonText(reason) {
            const reasons = {
                'empty_phone': '×˜×œ×¤×•×Ÿ ×¨×™×§',
                'too_short': '×§×¦×¨ ××“×™',
                'too_long': '××¨×•×š ××“×™',
                'invalid_phone': '×œ× ×ª×§×™×Ÿ'
            };
            return reasons[reason] || reason;
        }

        async function resolveConflict(identifier, name, btn) {
            // ×¢×“×›×•×Ÿ ×”×¡×˜×™×™×˜ ×”××§×•××™ - ×ª×•××š ×’× ×‘×˜×œ×¤×•×Ÿ ×•×’× ×‘××™×™×œ
            if (state.analysisData?.conflicts) {
                const conflict = state.analysisData.conflicts.find(c => c.phone === identifier || c.email === identifier);
                if (conflict) {
                    conflict.autoSelected = name;
                }
            }
            
            // ×¢×“×›×•×Ÿ ×”×©× ×‘-allData
            if (state.analysisData?.allData) {
                const contact = state.analysisData.allData.find(c => c.phone === identifier || c.email === identifier);
                if (contact) {
                    contact.name = name;
                }
            }
            
            // ×¢×“×›×•×Ÿ ×‘×©×¨×ª
            await api('/api/resolve', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phone: identifier, name })
            });
            
            // ×©××•×¨ ××ª ×”×˜×™×•×˜×”
            scheduleDraftSave();
            
            // ×¨×™× ×“×•×¨ ××—×“×© ×©×œ ×”×§×•× ×¤×œ×™×§×˜×™×
            showAnalysisTab('conflicts');
            
            Toast.fire({ icon: 'success', title: `× ×‘×—×¨: ${name}` });
        }

        async function resolveConflictCustom(identifier) {
            const { value: customName } = await Swal.fire({
                title: '×”×–×Ÿ ×©× ××•×ª×× ××™×©×™×ª',
                input: 'text',
                inputPlaceholder: '×©× ××™×© ×”×§×©×¨',
                showCancelButton: true,
                confirmButtonText: '××©×¨',
                cancelButtonText: '×‘×™×˜×•×œ',
                inputValidator: (value) => {
                    if (!value || !value.trim()) {
                        return '×™×© ×œ×”×–×™×Ÿ ×©×';
                    }
                }
            });
            
            if (customName) {
                resolveConflict(identifier, customName.trim(), null);
            }
        }

        async function mergePhoneEmail(conflictKey, phone, email) {
            // ××¦× ××ª ××™×© ×”×§×©×¨ ×¢× ×”×˜×œ×¤×•×Ÿ ×•××ª ×–×” ×¢× ×”××™×™×œ
            const phoneContact = state.analysisData?.allData?.find(c => c.phone === phone);
            const emailContact = state.analysisData?.allData?.find(c => c.email === email && c.hasEmailOnly);
            
            if (!phoneContact || !emailContact) {
                Toast.fire({ icon: 'error', title: '×œ× × ××¦××• ×× ×©×™ ×”×§×©×¨' });
                return;
            }
            
            // ×”×•×¡×£ ××ª ×”××™×™×œ ×œ××™×© ×”×§×©×¨ ×¢× ×”×˜×œ×¤×•×Ÿ
            phoneContact.email = email;
            if (!phoneContact.originalData) phoneContact.originalData = {};
            phoneContact.originalData.mergedFromEmail = true;
            
            // ×”×¡×¨ ××ª ××™×© ×”×§×©×¨ ×¢× ×”××™×™×œ ×‘×œ×‘×“
            const emailIdx = state.analysisData.allData.indexOf(emailContact);
            if (emailIdx > -1) {
                state.analysisData.allData.splice(emailIdx, 1);
            }
            
            // ×”×¡×¨ ××ª ×”×§×•× ×¤×œ×™×§×˜
            const confIdx = state.analysisData.conflicts.findIndex(c => c.conflictKey === conflictKey);
            if (confIdx > -1) {
                state.analysisData.conflicts.splice(confIdx, 1);
            }
            
            scheduleDraftSave();
            showAnalysisTab('conflicts');
            Toast.fire({ icon: 'success', title: '×× ×©×™ ×”×§×©×¨ ××•×—×“×•!' });
        }

        async function keepSeparatePhoneEmail(conflictKey, phone, email) {
            // ×¤×©×•×˜ ×”×¡×¨ ××ª ×”×§×•× ×¤×œ×™×§×˜ - ×©× ×™ ×× ×©×™ ×”×§×©×¨ × ×©××¨×™× × ×¤×¨×“×™×
            const confIdx = state.analysisData.conflicts.findIndex(c => c.conflictKey === conflictKey);
            if (confIdx > -1) {
                state.analysisData.conflicts.splice(confIdx, 1);
            }
            
            scheduleDraftSave();
            showAnalysisTab('conflicts');
            Toast.fire({ icon: 'success', title: '×× ×©×™ ×”×§×©×¨ ×™×™×©××¨×• × ×¤×¨×“×™×' });
        }

        async function finalizeGroup() {
            const data = state.analysisData;
            if (!data) return;
            
            const totalContacts = data.allData?.length || 0;
            const stages = [
                { name: '××›×™×Ÿ × ×ª×•× ×™×...', percent: 5 },
                { name: '×× ×§×” ×©××•×ª...', percent: 15 },
                { name: '×‘×•×“×§ ×›×¤×™×œ×•×™×•×ª...', percent: 25 },
                { name: '×©×•××¨ ×œ×“××˜××‘×™×™×¡...', percent: 40 },
                { name: '××¢×‘×“ ×× ×©×™ ×§×©×¨...', percent: 70 },
                { name: '××¡×™×™×...', percent: 95 }
            ];
            let currentStage = 0;
            
            // ×”×¦×’ ×—×œ×•×Ÿ ×¢× ×¤×¨×•×’×¨×¡ ×‘×¨
            Swal.fire({
                title: '×©×•××¨ ×¨×©×™××”...',
                html: `
                    <div class="text-right space-y-4">
                        <p class="text-slate-600">${totalContacts.toLocaleString()} ×× ×©×™ ×§×©×¨</p>
                        <div class="w-full bg-slate-200 rounded-full h-4 overflow-hidden">
                            <div id="saveProgress" class="bg-gradient-to-r from-indigo-500 to-purple-600 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <p id="saveStage" class="text-sm text-slate-500">××ª×—×™×œ...</p>
                        <p id="savePercent" class="text-2xl font-bold text-indigo-600">0%</p>
                    </div>
                `,
                allowOutsideClick: false,
                showConfirmButton: false
            });
            
            // ×× ×™××¦×™×™×ª ×¤×¨×•×’×¨×¡
            const progressInterval = setInterval(() => {
                if (currentStage < stages.length) {
                    const stage = stages[currentStage];
                    document.getElementById('saveProgress').style.width = stage.percent + '%';
                    document.getElementById('saveStage').textContent = stage.name;
                    document.getElementById('savePercent').textContent = stage.percent + '%';
                    currentStage++;
                }
            }, totalContacts > 10000 ? 3000 : 1000);
            
            try {
                const result = await api('/api/finalize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        groupId: data.groupId,
                        groupName: data.targetGroupName,
                        contacts: data.allData,
                        fileIds: data.fileIds,
                        stats: data.stats,
                        analysisData: {
                            conflicts: data.conflicts,
                            autoResolved: data.autoResolved,
                            rejectedContacts: data.rejectedContacts
                        }
                    })
                });
                
                clearInterval(progressInterval);
                
                // ×”×©×œ× ×œ-100%
                document.getElementById('saveProgress').style.width = '100%';
                document.getElementById('saveStage').textContent = '×”×•×©×œ×!';
                document.getElementById('savePercent').textContent = '100%';
                
                setTimeout(() => {
                    Swal.fire({ 
                        icon: 'success', 
                        title: '×”×¨×©×™××” × ×©××¨×”!', 
                        text: `${result.contactsCount?.toLocaleString() || 0} ×× ×©×™ ×§×©×¨ × ×©××¨×•`,
                        confirmButtonText: '×¦×¤×” ×‘×¨×©×™××”'
                    }).then(() => {
                        state.selectedFiles = [];
                        state.analysisData = null;
                        viewGroup(data.groupId);
                    });
                }, 500);
                
            } catch (err) {
                clearInterval(progressInterval);
                Swal.fire({ icon: 'error', title: '×©×’×™××”', text: err.message });
            }
        }

        // ==================== ADD TO GROUP ====================
        async function addFilesToGroup() {
            const pendingFiles = await api('/api/files');
            
            const { value: action } = await Swal.fire({
                title: '×”×•×¡×¤×ª ×§×‘×¦×™× ×œ×¨×©×™××”',
                html: `
                    <div class="text-right space-y-4">
                        <button id="uploadNewBtn" class="w-full p-4 bg-indigo-50 hover:bg-indigo-100 rounded-xl text-right border-2 border-indigo-200">
                            <p class="font-bold text-indigo-700">ğŸ“ ×”×¢×œ×” ×§×‘×¦×™× ×—×“×©×™×</p>
                            <p class="text-sm text-slate-500">×‘×—×¨ ×§×‘×¦×™ VCF ××• CSV ××”××—×©×‘</p>
                        </button>
                        ${pendingFiles.length ? `
                            <button id="selectExistingBtn" class="w-full p-4 bg-slate-50 hover:bg-slate-100 rounded-xl text-right border-2 border-slate-200">
                                <p class="font-bold text-slate-700">ğŸ“‹ ×‘×—×¨ ××§×‘×¦×™× ×§×™×™××™×</p>
                                <p class="text-sm text-slate-500">${pendingFiles.length} ×§×‘×¦×™× ×××ª×™× ×™×</p>
                            </button>
                        ` : ''}
                    </div>
                `,
                showConfirmButton: false,
                showCancelButton: true,
                cancelButtonText: '×‘×™×˜×•×œ',
                didOpen: () => {
                    document.getElementById('uploadNewBtn')?.addEventListener('click', () => Swal.close({ value: 'upload' }));
                    document.getElementById('selectExistingBtn')?.addEventListener('click', () => Swal.close({ value: 'select' }));
                }
            });
            
            if (action === 'upload') {
                // ×”×¢×œ×” ×§×‘×¦×™× ×—×“×©×™× - × ×–×›×•×¨ ××ª ×”×§×‘×•×¦×” ×”× ×•×›×—×™×ª
                state.addToGroupAfterUpload = state.currentGroupId;
                document.getElementById('fileInput').click();
                return;
            }
            
            if (action !== 'select' || !pendingFiles.length) return;
            
            // ×‘×—×¨ ××§×‘×¦×™× ×§×™×™××™×
            const { value: selectedIds, isConfirmed } = await Swal.fire({
                title: '×‘×—×¨ ×§×‘×¦×™× ×œ×”×•×¡×¤×”',
                html: `
                    <div class="text-right max-h-60 overflow-y-auto">
                        ${pendingFiles.map(f => `
                            <label class="flex items-center gap-3 p-3 hover:bg-slate-50 rounded-lg cursor-pointer">
                                <input type="checkbox" value="${f.id}" class="add-file-checkbox w-5 h-5 accent-indigo-600">
                                <div class="flex-1">
                                    <p class="font-medium">${f.original_name}</p>
                                    <p class="text-xs text-slate-400">${f.parsed_count?.toLocaleString() || 0} ×× ×©×™ ×§×©×¨</p>
                                </div>
                            </label>
                        `).join('')}
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: '×”×•×¡×£ ×œ×¨×©×™××”',
                cancelButtonText: '×‘×™×˜×•×œ',
                preConfirm: () => {
                    const checked = document.querySelectorAll('.add-file-checkbox:checked');
                    if (!checked.length) {
                        Swal.showValidationMessage('×‘×—×¨ ×œ×¤×—×•×ª ×§×•×‘×¥ ××—×“');
                        return false;
                    }
                    return Array.from(checked).map(c => parseInt(c.value));
                }
            });
            
            if (!isConfirmed || !selectedIds) return;
            await processAddFiles(selectedIds);
        }
        
        async function processAddFiles(fileIds) {
            Swal.fire({ title: '××•×¡×™×£ ×§×‘×¦×™×...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            
            try {
                const processingData = fileIds.map(id => ({
                    fileId: id,
                    mapping: state.mappings[id] || { phoneField: 'Phone', nameFields: ['Name'] }
                }));
                
                const result = await api(`/api/groups/${state.currentGroupId}/add-files`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ processingData })
                });
                
                Swal.fire({
                    icon: 'success',
                    title: '×”×§×‘×¦×™× × ×•×¡×¤×•!',
                    html: `
                        <div class="text-right">
                            <p>âœ… × ×•×¡×¤×•: <strong>${result.added?.toLocaleString() || 0}</strong></p>
                            <p>â­ï¸ ×›×¤×™×œ×•×™×•×ª (×“×•×œ×’×•): <strong>${result.duplicates?.toLocaleString() || 0}</strong></p>
                            <p>âŒ × ×“×—×•: <strong>${result.skipped?.toLocaleString() || 0}</strong></p>
                        </div>
                    `
                });
                
                viewGroup(state.currentGroupId);
                
            } catch (err) {
                Swal.fire({ icon: 'error', title: '×©×’×™××”', text: err.message });
            }
        }

        // ==================== SETTINGS ====================
        async function loadSettings() {
            try {
                // ×˜×¢×Ÿ ×›×œ×œ×™ ×©××•×ª
                const rules = await api('/api/settings/name-rules');
                document.getElementById('rule-preferLonger').checked = rules.preferLonger !== false;
                document.getElementById('rule-preferHebrew').checked = rules.preferHebrew !== false;
                document.getElementById('rule-avoidSpecialChars').checked = rules.avoidSpecialChars !== false;
                document.getElementById('rule-preferNoNumbers').checked = rules.preferNoNumbers !== false;
                document.getElementById('rule-minLength').value = rules.minLength || 2;
                document.getElementById('rule-maxLength').value = rules.maxLength || 20;
                document.getElementById('rule-duplicateSuffix').value = rules.duplicateSuffix || '({n})';
                
                // ×˜×¢×Ÿ ×©××•×ª ×œ× ×ª×§×™× ×™×
                await loadInvalidNames();
                
                // ×˜×¢×Ÿ ×›×œ×œ×™ × ×™×§×•×™
                await loadCleaningRules();
            } catch (err) {
                console.error('Settings error:', err);
            }
        }

        async function saveNameRules(showToast = false) {
            const rules = {
                preferLonger: document.getElementById('rule-preferLonger').checked,
                preferHebrew: document.getElementById('rule-preferHebrew').checked,
                avoidSpecialChars: document.getElementById('rule-avoidSpecialChars').checked,
                preferNoNumbers: document.getElementById('rule-preferNoNumbers').checked,
                minLength: parseInt(document.getElementById('rule-minLength').value) || 2,
                maxLength: parseInt(document.getElementById('rule-maxLength').value) || 20,
                duplicateSuffix: document.getElementById('rule-duplicateSuffix').value || '({n})',
                allowedChars: ["'", '"', "-", " "]
            };
            
            await api('/api/settings/name-rules', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(rules)
            });
            
            if (showToast) {
                Toast.fire({ icon: 'success', title: '×”×›×œ×œ×™× × ×©××¨×•' });
            }
        }

        async function addInvalidName() {
            const name = document.getElementById('newInvalidName').value.trim();
            const patternType = document.getElementById('newInvalidPattern').value;
            
            if (!name) return Toast.fire({ icon: 'error', title: '×”×–×Ÿ ×©×' });
            
            await api('/api/invalid-names', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, patternType })
            });
            
            document.getElementById('newInvalidName').value = '';
            Toast.fire({ icon: 'success', title: '×”×©× × ×•×¡×£ - ×œ×—×¥ "×©××•×¨ ×•×”×—×œ" ×œ×”×—×œ×” ×¢×œ ×”×˜×™×•×˜×”' });
            await loadInvalidNames();
        }

        async function deleteInvalidName(id) {
            await api(`/api/invalid-names/${id}`, { method: 'DELETE' });
            Toast.fire({ icon: 'success', title: '×”×©× ×”×•×¡×¨' });
            await loadInvalidNames();
        }
        
        async function loadInvalidNames() {
            const names = await api('/api/invalid-names');
            document.getElementById('invalidNamesList').innerHTML = names.map(n => `
                <div class="flex items-center gap-2 p-2 bg-red-50 rounded-lg">
                    <span class="text-xs px-1 py-0.5 bg-red-100 text-red-600 rounded">${
                        n.pattern_type === 'exact' ? '××“×•×™×§' : 
                        n.pattern_type === 'contains' ? '××›×™×œ' : '×¨×’×§×¡'
                    }</span>
                    <span class="flex-1 text-red-700 truncate" title="${n.name}">${n.name}</span>
                    <button onclick="deleteInvalidName(${n.id})" class="text-red-400 hover:text-red-600 text-sm">âœ•</button>
                </div>
            `).join('') || '<p class="text-slate-400 col-span-4 text-center">××™×Ÿ ×©××•×ª ××¡×•×¨×™× ××•×’×“×¨×™×</p>';
        }

        // ==================== CLEANING RULES ====================
        let cleaningRules = [];

        async function loadCleaningRules() {
            cleaningRules = await api('/api/settings/cleaning-rules');
            renderCleaningRules();
        }

        function renderCleaningRules() {
            const ruleTypeLabels = {
                'trim_start': '×”×¡×¨ ××ª×—×™×œ×ª ×”×©×',
                'trim_end': '×”×¡×¨ ××¡×•×£ ×”×©×',
                'replace': '×”×—×œ×£',
                'regex': '×‘×™×˜×•×™ ×¨×’×•×œ×¨×™',
                'remove_special': '×”×¡×¨ ×ª×•×•×™× ××™×•×—×“×™×'
            };
            
            document.getElementById('cleaningRulesList').innerHTML = cleaningRules.map((rule, idx) => `
                <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl ${!rule.enabled ? 'opacity-50' : ''}">
                    <input type="checkbox" ${rule.enabled ? 'checked' : ''} 
                           onchange="toggleCleaningRule(${idx})" 
                           class="w-5 h-5 accent-indigo-600">
                    <span class="text-xs px-2 py-1 bg-indigo-100 text-indigo-700 rounded">${ruleTypeLabels[rule.type] || rule.type}</span>
                    ${rule.type === 'remove_special' ? 
                        `<span class="text-sm text-slate-600">×œ××¢×˜:</span><code class="text-sm bg-green-100 px-2 py-1 rounded">${rule.pattern || '××•×ª×™×•×ª ×•×¨×•×•×—×™×'}</code>` :
                        `<code class="text-sm bg-slate-200 px-2 py-1 rounded">"${rule.pattern}"</code>`
                    }
                    ${rule.type === 'replace' || rule.type === 'regex' ? `<span class="text-slate-400">â†’</span><code class="text-sm bg-green-100 px-2 py-1 rounded">"${rule.replacement || ''}"</code>` : ''}
                    <span class="flex-1 text-slate-600 text-sm">${rule.description || ''}</span>
                    <button onclick="deleteCleaningRule(${idx})" class="text-red-400 hover:text-red-600 text-lg">âœ•</button>
                </div>
            `).join('') || '<p class="text-slate-400 text-center py-4">××™×Ÿ ×›×œ×œ×™ × ×™×§×•×™ ××•×’×“×¨×™×</p>';
        }

        async function toggleCleaningRule(idx) {
            cleaningRules[idx].enabled = !cleaningRules[idx].enabled;
            await saveCleaningRules();
        }

        async function deleteCleaningRule(idx) {
            cleaningRules.splice(idx, 1);
            await saveCleaningRules();
            Toast.fire({ icon: 'success', title: '×”×›×œ×œ × ××—×§' });
        }

        async function addCleaningRule() {
            const type = document.getElementById('newRuleType').value;
            const pattern = document.getElementById('newRulePattern').value;
            const replacement = document.getElementById('newRuleReplacement').value;
            const description = document.getElementById('newRuleDesc').value;
            
            // ×¢×‘×•×¨ remove_special ×œ× ×—×•×‘×” pattern (×‘×¨×™×¨×ª ××—×“×œ: ××•×ª×™×•×ª ×•×¨×•×•×—×™×)
            if (!pattern && type !== 'remove_special') {
                return Toast.fire({ icon: 'error', title: '×”×–×Ÿ ×ª×• ××• ×˜×§×¡×˜' });
            }
            
            const newRule = {
                id: Date.now(),
                type,
                pattern: type === 'remove_special' ? (pattern || '') : pattern,
                replacement: (type === 'replace' || type === 'regex') ? replacement : undefined,
                description: description || (type === 'remove_special' ? '×”×¡×¨ ×ª×•×•×™× ××™×•×—×“×™× ×•××™××•×’\'×™×' : ''),
                enabled: true
            };
            
            cleaningRules.push(newRule);
            await saveCleaningRules();
            
            // × ×§×” ×©×“×•×ª
            document.getElementById('newRulePattern').value = '';
            document.getElementById('newRuleReplacement').value = '';
            document.getElementById('newRuleDesc').value = '';
            
            Toast.fire({ icon: 'success', title: '×”×›×œ×œ × ×•×¡×£' });
        }

        async function saveCleaningRules() {
            await api('/api/settings/cleaning-rules', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(cleaningRules)
            });
            renderCleaningRules();
        }

        function updateRuleInputs() {
            const type = document.getElementById('newRuleType').value;
            const replacementInput = document.getElementById('newRuleReplacement');
            const patternInput = document.getElementById('newRulePattern');
            
            if (type === 'replace' || type === 'regex') {
                replacementInput.classList.remove('hidden');
                patternInput.placeholder = type === 'regex' ? '×‘×™×˜×•×™ ×¨×’×•×œ×¨×™...' : '×˜×§×¡×˜ ×œ××¦×™××”...';
            } else if (type === 'remove_special') {
                replacementInput.classList.add('hidden');
                patternInput.placeholder = '×ª×•×•×™× ××•×ª×¨×™× ×œ××¢×˜ ××•×ª×™×•×ª (×œ××©×œ: \' " - ×¨×•×•×—)...';
            } else {
                replacementInput.classList.add('hidden');
                patternInput.placeholder = type === 'trim_start' ? '×ª×• ×œ×”×¡×¨×” ××”×”×ª×—×œ×”...' : '×ª×• ×œ×”×¡×¨×” ××”×¡×•×£...';
            }
        }

        // ==================== USER MENU ====================
        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.classList.toggle('hidden');
        }
        
        // ×¡×’×•×¨ ×ª×¤×¨×™×˜ ××©×ª××© ×‘×œ×—×™×¦×” ××—×•×¥ ×œ×•
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('userMenu');
            const button = e.target.closest('button');
            if (!e.target.closest('#userMenu') && !button?.onclick?.toString().includes('toggleUserMenu')) {
                menu?.classList.add('hidden');
            }
        });
        
        async function loadUserInfo() {
            try {
                const res = await fetch('/api/me');
                if (res.ok) {
                    const data = await res.json();
                    const email = data.user?.email || 'user';
                    document.getElementById('userEmail').textContent = email;
                    document.getElementById('userInitial').textContent = email.charAt(0).toUpperCase();
                    
                    // ×× ×™×© ×ª××•× ×” ××’×•×’×œ
                    if (data.user?.picture) {
                        document.getElementById('userAvatar').innerHTML = `<img src="${data.user.picture}" class="w-8 h-8 rounded-full">`;
                    }
                }
            } catch (e) {
                console.log('Could not load user info');
            }
        }
        
        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', async () => {
            // Check auth on load
            try {
                const res = await fetch('/api/groups');
                if (res.status === 401) {
                    window.location.href = '/login';
                    return;
                }
            } catch (e) {
                // Network error - might be ok
            }
            
            // ×˜×¢×Ÿ ××™×“×¢ ×¢×œ ×”××©×ª××©
            loadUserInfo();
            showView('dashboard');
        });
    </script>
</body>
</html>
