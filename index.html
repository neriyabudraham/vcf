<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VCF Manager Pro | ××¢×¨×›×ª × ×™×”×•×œ ×× ×©×™ ×§×©×¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Heebo', sans-serif; }
        body { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); min-height: 100vh; }
        
        .glass-card { 
            background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255,255,255,0.8);
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
        }
        
        .stat-card {
            background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.1); }
        
        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            transition: all 0.3s ease;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4); }
        
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        
        .file-card { transition: all 0.3s ease; }
        .file-card:hover { transform: scale(1.02); }
        .file-card.selected { ring: 3px solid #6366f1; background: #eef2ff; }
        
        .tab-btn { transition: all 0.2s; }
        .tab-btn.active { background: #6366f1; color: white; }
        
        .table-row:hover { background: #f8fafc; }
        
        .progress-ring { transition: stroke-dashoffset 0.5s ease; }
        
        .fade-in { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .pulse-dot { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="text-slate-800">
    <!-- Header -->
    <header class="glass-card sticky top-0 z-50 px-6 py-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center text-white font-black text-xl shadow-lg">V</div>
                <div>
                    <h1 class="text-xl font-black text-slate-800">VCF Manager <span class="text-indigo-600">Pro</span></h1>
                    <p class="text-xs text-slate-400">××¢×¨×›×ª × ×™×”×•×œ ×× ×©×™ ×§×©×¨ ××ª×§×“××ª</p>
                </div>
            </div>
            <nav class="flex items-center gap-2">
                <button onclick="showView('dashboard')" class="tab-btn px-4 py-2 rounded-xl font-semibold text-slate-600 hover:bg-slate-100" data-view="dashboard">×“×©×‘×•×¨×“</button>
                <button onclick="showView('groups')" class="tab-btn px-4 py-2 rounded-xl font-semibold text-slate-600 hover:bg-slate-100" data-view="groups">×¨×©×™××•×ª</button>
                <button onclick="showView('files')" class="tab-btn px-4 py-2 rounded-xl font-semibold text-slate-600 hover:bg-slate-100" data-view="files">×§×‘×¦×™×</button>
                <button onclick="document.getElementById('fileInput').click()" class="btn-primary px-6 py-2.5 rounded-xl font-bold shadow-lg">
                    <span class="flex items-center gap-2">ğŸ“ ×”×¢×œ××ª ×§×‘×¦×™×</span>
                </button>
                <input type="file" id="fileInput" multiple accept=".vcf,.csv" class="hidden" onchange="handleUpload(event)">
            </nav>
        </div>
    </header>

    <!-- Upload Overlay -->
    <div id="uploadOverlay" class="hidden fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="glass-card rounded-3xl p-8 w-full max-w-2xl max-h-[90vh] overflow-auto">
            <h3 class="text-2xl font-black text-slate-800 mb-6 flex items-center gap-3">
                <span class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center">ğŸ“¤</span>
                ××¢×œ×” ×§×‘×¦×™×...
            </h3>
            <div id="uploadFilesList" class="space-y-3 mb-6"></div>
            <div class="bg-slate-100 rounded-2xl p-4">
                <div class="flex justify-between text-sm font-semibold text-slate-600 mb-2">
                    <span id="uploadTotalText">0 / 0 ×§×‘×¦×™×</span>
                    <span id="uploadTotalPercent">0%</span>
                </div>
                <div class="h-3 bg-slate-200 rounded-full overflow-hidden">
                    <div id="globalProgress" class="h-full bg-indigo-500 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-6 space-y-6">
        
        <!-- Dashboard View -->
        <section id="dashboard-view" class="space-y-6 fade-in">
            <div class="flex justify-between items-center">
                <h2 class="text-3xl font-black text-slate-800">×“×©×‘×•×¨×“</h2>
                <button onclick="loadDashboard()" class="text-indigo-600 font-semibold hover:underline">ğŸ”„ ×¨×¢× ×Ÿ</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4" id="statsCards">
                <div class="stat-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-4xl">ğŸ“‹</span>
                        <span class="text-3xl font-black text-indigo-600" id="stat-groups">0</span>
                    </div>
                    <p class="text-slate-600 font-semibold">×¨×©×™××•×ª ×¤×¢×™×œ×•×ª</p>
                </div>
                <div class="stat-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-4xl">ğŸ‘¥</span>
                        <span class="text-3xl font-black text-green-600" id="stat-contacts">0</span>
                    </div>
                    <p class="text-slate-600 font-semibold">×× ×©×™ ×§×©×¨</p>
                </div>
                <div class="stat-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-4xl">ğŸ“</span>
                        <span class="text-3xl font-black text-amber-600" id="stat-files">0</span>
                    </div>
                    <p class="text-slate-600 font-semibold">×§×‘×¦×™× ×××ª×™× ×™×</p>
                </div>
                <div class="stat-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-4xl">âœï¸</span>
                        <span class="text-3xl font-black text-purple-600" id="stat-drafts">0</span>
                    </div>
                    <p class="text-slate-600 font-semibold">×˜×™×•×˜×•×ª</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass-card rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-slate-800 mb-4">×¨×©×™××•×ª ××—×¨×•× ×•×ª</h3>
                    <div id="recentGroups" class="space-y-3"></div>
                </div>
                <div class="glass-card rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-slate-800 mb-4">×§×‘×¦×™× ×××ª×™× ×™×</h3>
                    <div id="pendingFiles" class="space-y-3"></div>
                </div>
            </div>
        </section>

        <!-- Groups View -->
        <section id="groups-view" class="hidden space-y-6 fade-in">
            <div class="flex justify-between items-center">
                <h2 class="text-3xl font-black text-slate-800">×¨×©×™××•×ª ×× ×©×™ ×§×©×¨</h2>
            </div>
            <div id="groupsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <!-- Files View -->
        <section id="files-view" class="hidden space-y-6 fade-in">
            <div class="flex justify-between items-center">
                <h2 class="text-3xl font-black text-slate-800">×§×‘×¦×™× ×œ×”×¢×œ××”</h2>
                <button onclick="startProcessing()" id="processBtn" class="btn-primary px-6 py-3 rounded-xl font-bold shadow-lg hidden">
                    âš¡ ×¢×‘×“ ×§×‘×¦×™× × ×‘×—×¨×™× (<span id="selectedCount">0</span>)
                </button>
            </div>
            
            <div class="glass-card rounded-2xl p-6">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <input type="text" id="targetGroupName" placeholder="×©× ×”×¨×©×™××” ×”×—×“×©×”..." class="col-span-2 px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <input type="text" id="defaultName" placeholder="×©× ×‘×¨×™×¨×ª ××—×“×œ ×œ××™×© ×§×©×¨..." class="px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <input type="number" id="startSerial" value="1" placeholder="××¡×¤×¨ ×”×ª×—×œ×ª×™" class="px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
            </div>
            
            <div id="filesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </section>

        <!-- Analysis View -->
        <section id="analysis-view" class="hidden space-y-6 fade-in">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-3xl font-black text-slate-800" id="analysisTitle">× ×™×ª×•×— × ×ª×•× ×™×</h2>
                    <p class="text-slate-500" id="analysisSummary"></p>
                </div>
                <button onclick="finalizeGroup()" class="btn-success px-8 py-3 rounded-xl font-bold shadow-lg">
                    âœ… ×©××•×¨ ×•×¡×™×™×
                </button>
            </div>
            
            <!-- Stats Summary -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4" id="analysisStats"></div>
            
            <!-- Tabs -->
            <div class="glass-card rounded-2xl overflow-hidden">
                <div class="flex border-b border-slate-200">
                    <button onclick="showAnalysisTab('accepted')" class="analysis-tab flex-1 px-6 py-4 font-semibold text-slate-600 hover:bg-slate-50 border-b-2 border-transparent" data-tab="accepted">
                        âœ… ××•×©×¨×• (<span id="acceptedCount">0</span>)
                    </button>
                    <button onclick="showAnalysisTab('rejected')" class="analysis-tab flex-1 px-6 py-4 font-semibold text-slate-600 hover:bg-slate-50 border-b-2 border-transparent" data-tab="rejected">
                        âŒ × ×“×—×• (<span id="rejectedCount">0</span>)
                    </button>
                    <button onclick="showAnalysisTab('conflicts')" class="analysis-tab flex-1 px-6 py-4 font-semibold text-slate-600 hover:bg-slate-50 border-b-2 border-transparent" data-tab="conflicts">
                        âš ï¸ ×§×•× ×¤×œ×™×§×˜×™× (<span id="conflictsCount">0</span>)
                    </button>
                    <button onclick="showAnalysisTab('duplicates')" class="analysis-tab flex-1 px-6 py-4 font-semibold text-slate-600 hover:bg-slate-50 border-b-2 border-transparent" data-tab="duplicates">
                        ğŸ”„ ×›×¤×™×œ×•×™×•×ª (<span id="duplicatesCount">0</span>)
                    </button>
                </div>
                
                <div id="analysisContent" class="p-6 max-h-[60vh] overflow-auto"></div>
            </div>
        </section>

        <!-- Group Detail View -->
        <section id="group-view" class="hidden space-y-6 fade-in">
            <div class="flex justify-between items-center">
                <div>
                    <button onclick="showView('groups')" class="text-indigo-600 font-semibold mb-2 hover:underline">â† ×—×–×¨×” ×œ×¨×©×™××•×ª</button>
                    <h2 class="text-3xl font-black text-slate-800" id="groupTitle"></h2>
                    <p class="text-slate-500" id="groupInfo"></p>
                </div>
                <div class="flex gap-3">
                    <button onclick="addFilesToGroup()" class="btn-primary px-4 py-2 rounded-xl font-semibold">â• ×”×•×¡×£ ×§×‘×¦×™×</button>
                    <button onclick="saveVersion()" class="px-4 py-2 rounded-xl font-semibold bg-slate-100 hover:bg-slate-200">ğŸ’¾ ×©××•×¨ ×’×¨×¡×”</button>
                    <button onclick="exportGroup('csv')" class="px-4 py-2 rounded-xl font-semibold bg-slate-100 hover:bg-slate-200">ğŸ“Š CSV</button>
                    <button onclick="exportGroup('vcf')" class="px-4 py-2 rounded-xl font-semibold bg-slate-100 hover:bg-slate-200">ğŸ“‡ VCF</button>
                </div>
            </div>
            
            <!-- Versions -->
            <div class="glass-card rounded-2xl p-4">
                <div class="flex items-center gap-4 overflow-x-auto pb-2">
                    <span class="text-slate-500 font-semibold whitespace-nowrap">×’×¨×¡××•×ª:</span>
                    <div id="versionsList" class="flex gap-2"></div>
                </div>
            </div>
            
            <!-- Search & Contacts -->
            <div class="glass-card rounded-2xl p-6">
                <div class="flex gap-4 mb-6">
                    <input type="text" id="contactSearch" placeholder="ğŸ” ×—×™×¤×•×© ×œ×¤×™ ×©× ××• ×˜×œ×¤×•×Ÿ..." class="flex-1 px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none" oninput="searchContacts()">
                </div>
                <div id="contactsTable" class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-50 text-slate-600">
                            <tr>
                                <th class="px-4 py-3 text-right font-semibold rounded-tr-xl">×©×</th>
                                <th class="px-4 py-3 text-right font-semibold">×˜×œ×¤×•×Ÿ</th>
                                <th class="px-4 py-3 text-right font-semibold">××™××™×™×œ</th>
                                <th class="px-4 py-3 text-right font-semibold rounded-tl-xl">××§×•×¨</th>
                            </tr>
                        </thead>
                        <tbody id="contactsBody"></tbody>
                    </table>
                </div>
                <div id="pagination" class="flex justify-center gap-2 mt-4"></div>
            </div>
        </section>

    </main>

    <!-- Mapping Modal -->
    <div id="mappingModal" class="hidden fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="glass-card rounded-3xl p-8 w-full max-w-4xl max-h-[90vh] overflow-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black text-slate-800" id="mappingTitle">×”×’×“×¨×ª ××™×¤×•×™</h3>
                <button onclick="closeMapping()" class="text-3xl text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            <div id="mappingContent"></div>
            <div class="flex justify-end gap-3 mt-6 pt-6 border-t">
                <button onclick="closeMapping()" class="px-6 py-3 rounded-xl font-semibold bg-slate-100 hover:bg-slate-200">×‘×™×˜×•×œ</button>
                <button onclick="saveMapping()" class="btn-primary px-6 py-3 rounded-xl font-bold">×©××•×¨ ××™×¤×•×™</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== STATE ====================
        let state = {
            files: [],
            groups: [],
            selectedFiles: [],
            mappings: {},
            fileSamples: {},
            currentGroupId: null,
            analysisData: null,
            currentPage: 1
        };
        
        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2500, timerProgressBar: true });

        // API helper with auth handling
        async function api(url, options = {}) {
            const res = await fetch(url, options);
            if (res.status === 401) {
                window.location.href = '/login';
                throw new Error('Session expired');
            }
            return res.json();
        }

        // ==================== VIEWS ====================
        function showView(view) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById(view + '-view').classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.tab-btn[data-view="${view}"]`)?.classList.add('active');
            
            if (view === 'dashboard') loadDashboard();
            else if (view === 'groups') loadGroups();
            else if (view === 'files') loadFiles();
        }

        // ==================== DASHBOARD ====================
        async function loadDashboard() {
            try {
                const [stats, groups, files] = await Promise.all([
                    api('/api/dashboard-stats'),
                    api('/api/groups'),
                    api('/api/files')
                ]);
                
                if (!Array.isArray(groups)) throw new Error('Invalid groups data');
                if (!Array.isArray(files)) throw new Error('Invalid files data');
                
                document.getElementById('stat-groups').textContent = stats.groups?.ready || 0;
                document.getElementById('stat-contacts').textContent = Number(stats.contacts?.total || 0).toLocaleString();
                document.getElementById('stat-files').textContent = stats.files?.pending || 0;
                document.getElementById('stat-drafts').textContent = stats.groups?.draft || 0;
                
                // Recent groups
                document.getElementById('recentGroups').innerHTML = groups.slice(0, 5).map(g => `
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100" onclick="viewGroup(${g.id})">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${g.status === 'draft' ? 'ğŸ“' : 'ğŸ“‹'}</span>
                            <div>
                                <p class="font-semibold text-slate-800">${g.name}</p>
                                <p class="text-xs text-slate-500">${g.count || 0} ×× ×©×™ ×§×©×¨</p>
                            </div>
                        </div>
                        ${g.status === 'draft' ? '<span class="px-2 py-1 bg-amber-100 text-amber-700 text-xs rounded-lg font-semibold">×˜×™×•×˜×”</span>' : ''}
                    </div>
                `).join('') || '<p class="text-slate-400 text-center py-4">××™×Ÿ ×¨×©×™××•×ª ×¢×“×™×™×Ÿ</p>';
                
                // Pending files
                document.getElementById('pendingFiles').innerHTML = files.slice(0, 5).map(f => `
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">ğŸ“„</span>
                            <div>
                                <p class="font-semibold text-slate-800 truncate max-w-[200px]">${f.original_name}</p>
                                <p class="text-xs text-slate-500">${f.parsed_count || 0} × ×§×¨××• â€¢ ${f.valid_count || 0} ×ª×§×™× ×™×</p>
                            </div>
                        </div>
                    </div>
                `).join('') || '<p class="text-slate-400 text-center py-4">××™×Ÿ ×§×‘×¦×™× ×××ª×™× ×™×</p>';
                
            } catch (err) {
                console.error('Dashboard error:', err);
            }
        }

        // ==================== GROUPS ====================
        async function loadGroups() {
            try {
                const groups = await api('/api/groups');
                if (!Array.isArray(groups)) throw new Error('Invalid data');
                state.groups = groups;
                
                document.getElementById('groupsList').innerHTML = groups.map(g => `
                    <div class="glass-card rounded-2xl p-6 cursor-pointer file-card ${g.status === 'draft' ? 'border-2 border-dashed border-amber-400' : ''}" 
                         onclick="${g.status === 'draft' ? `resumeDraft(${g.id})` : `viewGroup(${g.id})`}">
                        <div class="flex justify-between items-start mb-4">
                            <span class="text-4xl">${g.status === 'draft' ? 'ğŸ“' : 'ğŸ“‹'}</span>
                            ${g.status === 'draft' ? '<span class="px-3 py-1 bg-amber-100 text-amber-700 text-sm rounded-lg font-semibold pulse-dot">×˜×™×•×˜×”</span>' : ''}
                        </div>
                        <h3 class="text-xl font-bold text-slate-800 mb-2">${g.name}</h3>
                        <p class="text-3xl font-black text-indigo-600 mb-1">${(g.count || 0).toLocaleString()}</p>
                        <p class="text-slate-500 text-sm">×× ×©×™ ×§×©×¨</p>
                        <div class="flex justify-between items-center mt-4 pt-4 border-t border-slate-100">
                            <span class="text-xs text-slate-400">${g.updated_at_formatted || g.created_at_formatted || ''}</span>
                            <button onclick="event.stopPropagation(); deleteGroup(${g.id})" class="text-red-400 hover:text-red-600 text-sm">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `).join('') || '<p class="text-slate-400 text-center py-8 col-span-3">××™×Ÿ ×¨×©×™××•×ª ×¢×“×™×™×Ÿ. ×”×¢×œ×” ×§×‘×¦×™× ×›×“×™ ×œ×”×ª×—×™×œ.</p>';
                
            } catch (err) {
                console.error('Groups error:', err);
            }
        }

        async function viewGroup(id) {
            try {
                state.currentGroupId = id;
                state.currentPage = 1;
                
                const [group, versions] = await Promise.all([
                    api(`/api/groups/${id}`),
                    api(`/api/groups/${id}/versions`)
                ]);
                
                document.getElementById('groupTitle').textContent = group.name;
                document.getElementById('groupInfo').textContent = `${group.contacts?.length || 0} ×× ×©×™ ×§×©×¨ â€¢ ×’×¨×¡×” ${group.version || 1}`;
                
                // Versions
                document.getElementById('versionsList').innerHTML = versions.map(v => `
                    <button onclick="restoreVersion(${v.id})" class="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm font-medium whitespace-nowrap">
                        v${v.version_number} - ${v.version_name || ''} (${v.contacts_count || 0})
                    </button>
                `).join('') || '<span class="text-slate-400 text-sm">××™×Ÿ ×’×¨×¡××•×ª ×§×•×“××•×ª</span>';
                
                loadContacts();
                showView('group');
            } catch (err) {
                console.error('View group error:', err);
                Toast.fire({ icon: 'error', title: '×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¨×©×™××”' });
            }
        }

        async function loadContacts() {
            const search = document.getElementById('contactSearch')?.value || '';
            try {
                const data = await api(`/api/groups/${state.currentGroupId}/contacts?search=${encodeURIComponent(search)}&page=${state.currentPage}&limit=50`);
                
                document.getElementById('contactsBody').innerHTML = data.contacts.map(c => `
                    <tr class="table-row border-b border-slate-100">
                        <td class="px-4 py-3 font-medium">${c.full_name}</td>
                        <td class="px-4 py-3 text-slate-600 font-mono">${c.phone}</td>
                        <td class="px-4 py-3 text-slate-500">${c.email || '-'}</td>
                        <td class="px-4 py-3 text-slate-400 text-sm">${c.source_file_name || '-'}</td>
                    </tr>
                `).join('') || '<tr><td colspan="4" class="text-center py-8 text-slate-400">×œ× × ××¦××• ×× ×©×™ ×§×©×¨</td></tr>';
                
                // Pagination
                const totalPages = Math.ceil(data.total / data.limit);
                let paginationHtml = '';
                for (let i = 1; i <= totalPages && i <= 10; i++) {
                    paginationHtml += `<button onclick="goToPage(${i})" class="px-3 py-1 rounded-lg ${i === state.currentPage ? 'bg-indigo-600 text-white' : 'bg-slate-100 hover:bg-slate-200'}">${i}</button>`;
                }
                document.getElementById('pagination').innerHTML = paginationHtml;
                
            } catch (err) {
                console.error('Load contacts error:', err);
            }
        }

        function goToPage(page) {
            state.currentPage = page;
            loadContacts();
        }

        function searchContacts() {
            state.currentPage = 1;
            loadContacts();
        }

        async function deleteGroup(id) {
            const result = await Swal.fire({ title: '×œ××—×•×§ ××ª ×”×¨×©×™××”?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444', confirmButtonText: '××—×§', cancelButtonText: '×‘×™×˜×•×œ' });
            if (result.isConfirmed) {
                await api(`/api/groups/${id}`, { method: 'DELETE' });
                loadGroups();
                Toast.fire({ icon: 'success', title: '×”×¨×©×™××” × ××—×§×”' });
            }
        }

        async function saveVersion() {
            const { value: name } = await Swal.fire({ title: '×©××™×¨×ª ×’×¨×¡×”', input: 'text', inputPlaceholder: '×©× ×”×’×¨×¡×”...', showCancelButton: true });
            if (name) {
                await api(`/api/groups/${state.currentGroupId}/save-version`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ versionName: name })
                });
                Toast.fire({ icon: 'success', title: '×”×’×¨×¡×” × ×©××¨×”' });
                viewGroup(state.currentGroupId);
            }
        }

        async function restoreVersion(versionId) {
            const result = await Swal.fire({ title: '×œ×©×—×–×¨ ×’×¨×¡×” ×–×•?', text: '×”×¤×¢×•×œ×” ×ª×—×œ×™×£ ××ª ×× ×©×™ ×”×§×©×¨ ×”× ×•×›×—×™×™×', icon: 'question', showCancelButton: true });
            if (result.isConfirmed) {
                await api(`/api/groups/${state.currentGroupId}/restore-version/${versionId}`, { method: 'POST' });
                Toast.fire({ icon: 'success', title: '×”×’×¨×¡×” ×©×•×—×–×¨×”' });
                viewGroup(state.currentGroupId);
            }
        }

        function exportGroup(type) {
            window.location.href = `/api/export/${type}/${state.currentGroupId}`;
        }

        // ==================== FILES ====================
        async function loadFiles() {
            try {
                const files = await api('/api/files');
                if (!Array.isArray(files)) throw new Error('Invalid data');
                state.files = files;
                
                document.getElementById('filesList').innerHTML = files.map(f => {
                    const isSelected = state.selectedFiles.includes(f.id);
                    return `
                    <div class="glass-card rounded-2xl p-5 file-card cursor-pointer ${isSelected ? 'ring-2 ring-indigo-500 bg-indigo-50' : ''}" onclick="toggleFile(${f.id})">
                        <div class="flex justify-between items-start mb-3">
                            <span class="text-3xl">ğŸ“„</span>
                            <input type="checkbox" ${isSelected ? 'checked' : ''} class="w-5 h-5 accent-indigo-600" onclick="event.stopPropagation(); toggleFile(${f.id})">
                        </div>
                        <h4 class="font-bold text-slate-800 truncate mb-2" title="${f.original_name}">${f.original_name}</h4>
                        <div class="grid grid-cols-3 gap-2 text-center mb-3">
                            <div class="bg-slate-100 rounded-lg p-2">
                                <p class="text-lg font-bold text-slate-700">${(f.parsed_count || 0).toLocaleString()}</p>
                                <p class="text-xs text-slate-500">× ×§×¨××•</p>
                            </div>
                            <div class="bg-green-50 rounded-lg p-2">
                                <p class="text-lg font-bold text-green-600">${(f.valid_count || 0).toLocaleString()}</p>
                                <p class="text-xs text-slate-500">×ª×§×™× ×™×</p>
                            </div>
                            <div class="bg-red-50 rounded-lg p-2">
                                <p class="text-lg font-bold text-red-500">${(f.rejected_count || 0).toLocaleString()}</p>
                                <p class="text-xs text-slate-500">× ×“×—×•</p>
                            </div>
                        </div>
                        <div class="flex justify-between items-center pt-3 border-t border-slate-100">
                            <button onclick="event.stopPropagation(); openMapping(${f.id})" class="text-indigo-600 font-semibold text-sm hover:underline">âš™ï¸ ××™×¤×•×™</button>
                            <button onclick="event.stopPropagation(); deleteFile(${f.id})" class="text-red-400 hover:text-red-600 text-sm">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `}).join('') || '<p class="text-slate-400 text-center py-8 col-span-3">××™×Ÿ ×§×‘×¦×™× ×××ª×™× ×™×. ×”×¢×œ×” ×§×‘×¦×™× ×—×“×©×™×.</p>';
                
                updateProcessButton();
            } catch (err) {
                console.error('Files error:', err);
            }
        }

        function toggleFile(id) {
            const idx = state.selectedFiles.indexOf(id);
            if (idx > -1) state.selectedFiles.splice(idx, 1);
            else state.selectedFiles.push(id);
            loadFiles();
        }

        function updateProcessButton() {
            const btn = document.getElementById('processBtn');
            const count = state.selectedFiles.length;
            document.getElementById('selectedCount').textContent = count;
            btn.classList.toggle('hidden', count === 0);
        }

        async function deleteFile(id) {
            await api(`/api/files/${id}`, { method: 'DELETE' });
            state.selectedFiles = state.selectedFiles.filter(fid => fid !== id);
            loadFiles();
            Toast.fire({ icon: 'success', title: '×”×§×•×‘×¥ × ××—×§' });
        }

        // ==================== UPLOAD ====================
        async function handleUpload(e) {
            const files = e.target.files;
            if (!files.length) return;
            
            document.getElementById('uploadOverlay').classList.remove('hidden');
            const filesList = document.getElementById('uploadFilesList');
            const globalProgress = document.getElementById('globalProgress');
            const totalText = document.getElementById('uploadTotalText');
            const totalPercent = document.getElementById('uploadTotalPercent');
            
            filesList.innerHTML = Array.from(files).map((f, i) => `
                <div id="upload-${i}" class="bg-slate-50 rounded-xl p-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold text-slate-700 truncate max-w-[300px]">${f.name}</span>
                        <span id="status-${i}" class="text-sm font-medium text-slate-400">×××ª×™×Ÿ...</span>
                    </div>
                    <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                        <div id="progress-${i}" class="h-full bg-indigo-500 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-slate-400 mt-1">
                        <span>${formatSize(f.size)}</span>
                        <span id="percent-${i}">0%</span>
                    </div>
                </div>
            `).join('');
            
            let completed = 0;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                document.getElementById(`status-${i}`).textContent = '××¢×œ×”...';
                document.getElementById(`status-${i}`).className = 'text-sm font-medium text-indigo-600';
                
                try {
                    const result = await uploadFile(file, (percent) => {
                        document.getElementById(`progress-${i}`).style.width = percent + '%';
                        document.getElementById(`percent-${i}`).textContent = percent + '%';
                        if (percent === 100) {
                            document.getElementById(`status-${i}`).textContent = 'â³ ××¢×‘×“...';
                            document.getElementById(`status-${i}`).className = 'text-sm font-medium text-amber-600';
                            document.getElementById(`progress-${i}`).classList.remove('bg-indigo-500');
                            document.getElementById(`progress-${i}`).classList.add('bg-amber-400');
                        }
                    });
                    
                    // Success
                    document.getElementById(`status-${i}`).textContent = `âœ… ${result.stats?.valid?.toLocaleString() || 0} ×ª×§×™× ×™×`;
                    document.getElementById(`status-${i}`).className = 'text-sm font-medium text-green-600';
                    document.getElementById(`progress-${i}`).classList.remove('bg-amber-400');
                    document.getElementById(`progress-${i}`).classList.add('bg-green-500');
                    
                    // Setup auto mapping
                    const headers = Array.isArray(result.headers) ? result.headers : JSON.parse(result.headers || '[]');
                    state.fileSamples[result.id] = result.sample;
                    const phoneField = headers.find(h => /phone|tel|×˜×œ×¤×•×Ÿ/i.test(h)) || headers[0];
                    const nameField = headers.find(h => /name|×©×/i.test(h)) || headers[0];
                    state.mappings[result.id] = { phoneField, nameFields: [nameField] };
                    if (headers.length <= 3) state.selectedFiles.push(result.id);
                    
                } catch (err) {
                    document.getElementById(`status-${i}`).textContent = 'âŒ ×©×’×™××”';
                    document.getElementById(`status-${i}`).className = 'text-sm font-medium text-red-600';
                    document.getElementById(`progress-${i}`).classList.add('bg-red-500');
                }
                
                completed++;
                totalText.textContent = `${completed} / ${files.length} ×§×‘×¦×™×`;
                totalPercent.textContent = Math.round((completed / files.length) * 100) + '%';
                globalProgress.style.width = (completed / files.length * 100) + '%';
            }
            
            globalProgress.classList.add('bg-green-500');
            setTimeout(() => {
                document.getElementById('uploadOverlay').classList.add('hidden');
                globalProgress.classList.remove('bg-green-500');
                globalProgress.style.width = '0%';
                loadFiles();
                showView('files');
            }, 1500);
            
            e.target.value = '';
        }

        function uploadFile(file, onProgress) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                const fd = new FormData();
                fd.append('file', file);
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) onProgress(Math.round(e.loaded / e.total * 100));
                });
                
                xhr.addEventListener('load', () => {
                    if (xhr.status === 401) {
                        window.location.href = '/login';
                        reject(new Error('Session expired'));
                    } else if (xhr.status >= 200 && xhr.status < 300) {
                        resolve(JSON.parse(xhr.responseText));
                    } else {
                        reject(new Error('Upload failed'));
                    }
                });
                
                xhr.addEventListener('error', () => reject(new Error('Network error')));
                xhr.open('POST', '/api/upload');
                xhr.send(fd);
            });
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024, sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // ==================== MAPPING ====================
        function openMapping(id) {
            const file = state.files.find(f => f.id === id);
            if (!file) return;
            
            const headers = Array.isArray(file.headers) ? file.headers : JSON.parse(file.headers || '[]');
            const mapping = state.mappings[id] || { phoneField: headers[0], nameFields: [headers[0]] };
            const sample = state.fileSamples[id] || [];
            
            document.getElementById('mappingTitle').textContent = file.original_name;
            document.getElementById('mappingContent').innerHTML = `
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block font-semibold text-slate-700 mb-2">×©×“×” ×˜×œ×¤×•×Ÿ</label>
                        <select id="mappingPhone" class="w-full px-4 py-3 rounded-xl border border-slate-200">
                            ${headers.map(h => `<option value="${h}" ${mapping.phoneField === h ? 'selected' : ''}>${h}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block font-semibold text-slate-700 mb-2">×©×“×•×ª ×©×</label>
                        <div class="flex flex-wrap gap-2">
                            ${headers.map(h => `
                                <label class="flex items-center gap-2 px-3 py-2 bg-slate-100 rounded-lg cursor-pointer hover:bg-slate-200">
                                    <input type="checkbox" class="mapping-name-field" value="${h}" ${mapping.nameFields?.includes(h) ? 'checked' : ''}>
                                    ${h}
                                </label>
                            `).join('')}
                        </div>
                    </div>
                </div>
                <div class="bg-slate-50 rounded-xl p-4">
                    <h4 class="font-semibold text-slate-700 mb-3">×“×•×’××ª × ×ª×•× ×™×</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead><tr>${headers.map(h => `<th class="px-3 py-2 text-right bg-slate-100 font-semibold">${h}</th>`).join('')}</tr></thead>
                            <tbody>${sample.slice(0, 5).map(row => `<tr>${headers.map(h => `<td class="px-3 py-2 border-t border-slate-200">${row[h] || ''}</td>`).join('')}</tr>`).join('')}</tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('mappingModal').classList.remove('hidden');
            document.getElementById('mappingModal').dataset.fileId = id;
        }

        function saveMapping() {
            const id = parseInt(document.getElementById('mappingModal').dataset.fileId);
            const phoneField = document.getElementById('mappingPhone').value;
            const nameFields = Array.from(document.querySelectorAll('.mapping-name-field:checked')).map(el => el.value);
            
            state.mappings[id] = { phoneField, nameFields: nameFields.length ? nameFields : [phoneField] };
            if (!state.selectedFiles.includes(id)) state.selectedFiles.push(id);
            
            closeMapping();
            loadFiles();
            Toast.fire({ icon: 'success', title: '×”××™×¤×•×™ × ×©××¨' });
        }

        function closeMapping() {
            document.getElementById('mappingModal').classList.add('hidden');
        }

        // ==================== PROCESSING ====================
        async function startProcessing() {
            if (!state.selectedFiles.length) return;
            
            const targetGroupName = document.getElementById('targetGroupName').value || '×¨×©×™××” ×—×“×©×”';
            const defaultName = document.getElementById('defaultName').value;
            const startSerial = document.getElementById('startSerial').value;
            
            Swal.fire({ title: '××¢×‘×“ ×§×‘×¦×™×...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            
            try {
                const processingData = state.selectedFiles.map(id => ({
                    fileId: id,
                    mapping: state.mappings[id] || { phoneField: 'Phone', nameFields: ['Name'] }
                }));
                
                const result = await api('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ processingData, targetGroupName, defaultName, startSerial })
                });
                
                Swal.close();
                state.analysisData = result;
                showAnalysis(result);
                
            } catch (err) {
                Swal.fire({ icon: 'error', title: '×©×’×™××”', text: err.message });
            }
        }

        async function resumeDraft(groupId) {
            Swal.fire({ title: '×˜×•×¢×Ÿ ×˜×™×•×˜×”...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            
            try {
                const result = await api('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ groupId })
                });
                
                Swal.close();
                state.analysisData = result;
                showAnalysis(result);
            } catch (err) {
                Swal.fire({ icon: 'error', title: '×©×’×™××”', text: err.message });
            }
        }

        function showAnalysis(data) {
            document.getElementById('analysisTitle').textContent = data.targetGroupName;
            
            const stats = data.stats || {};
            document.getElementById('analysisSummary').textContent = `${stats.totalParsed?.toLocaleString() || 0} × ×§×¨××• ×-${stats.byFile?.length || 0} ×§×‘×¦×™×`;
            
            // Stats cards
            document.getElementById('analysisStats').innerHTML = `
                <div class="bg-slate-100 rounded-xl p-4 text-center">
                    <p class="text-2xl font-black text-slate-700">${(stats.totalParsed || 0).toLocaleString()}</p>
                    <p class="text-sm text-slate-500">× ×§×¨××•</p>
                </div>
                <div class="bg-green-100 rounded-xl p-4 text-center">
                    <p class="text-2xl font-black text-green-600">${(data.allData?.length || 0).toLocaleString()}</p>
                    <p class="text-sm text-slate-500">××•×©×¨×•</p>
                </div>
                <div class="bg-red-100 rounded-xl p-4 text-center">
                    <p class="text-2xl font-black text-red-600">${(data.rejectedContacts?.length || 0).toLocaleString()}</p>
                    <p class="text-sm text-slate-500">× ×“×—×•</p>
                </div>
                <div class="bg-amber-100 rounded-xl p-4 text-center">
                    <p class="text-2xl font-black text-amber-600">${(data.conflicts?.length || 0).toLocaleString()}</p>
                    <p class="text-sm text-slate-500">×§×•× ×¤×œ×™×§×˜×™×</p>
                </div>
                <div class="bg-blue-100 rounded-xl p-4 text-center">
                    <p class="text-2xl font-black text-blue-600">${(data.autoResolved?.length || 0).toLocaleString()}</p>
                    <p class="text-sm text-slate-500">×›×¤×™×œ×•×™×•×ª</p>
                </div>
            `;
            
            document.getElementById('acceptedCount').textContent = data.allData?.length || 0;
            document.getElementById('rejectedCount').textContent = data.rejectedContacts?.length || 0;
            document.getElementById('conflictsCount').textContent = data.conflicts?.length || 0;
            document.getElementById('duplicatesCount').textContent = data.autoResolved?.length || 0;
            
            showAnalysisTab('accepted');
            showView('analysis');
        }

        function showAnalysisTab(tab) {
            document.querySelectorAll('.analysis-tab').forEach(t => {
                t.classList.remove('border-indigo-500', 'text-indigo-600');
                t.classList.add('border-transparent');
            });
            document.querySelector(`.analysis-tab[data-tab="${tab}"]`).classList.add('border-indigo-500', 'text-indigo-600');
            
            const content = document.getElementById('analysisContent');
            const data = state.analysisData;
            
            if (tab === 'accepted') {
                content.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-50"><tr>
                                <th class="px-4 py-3 text-right font-semibold">×©×</th>
                                <th class="px-4 py-3 text-right font-semibold">×˜×œ×¤×•×Ÿ</th>
                                <th class="px-4 py-3 text-right font-semibold">××§×•×¨</th>
                            </tr></thead>
                            <tbody>${(data.allData || []).slice(0, 100).map(c => `
                                <tr class="border-b border-slate-100">
                                    <td class="px-4 py-2">${c.name}</td>
                                    <td class="px-4 py-2 font-mono text-slate-600">${c.phone}</td>
                                    <td class="px-4 py-2 text-slate-400 text-sm">${c.sourceFile || ''}</td>
                                </tr>
                            `).join('')}</tbody>
                        </table>
                        ${data.allData?.length > 100 ? `<p class="text-center text-slate-400 mt-4">××¦×™×’ 100 ××ª×•×š ${data.allData.length}</p>` : ''}
                    </div>
                `;
            } else if (tab === 'rejected') {
                const reasons = {};
                (data.rejectedContacts || []).forEach(c => { reasons[c.reason] = (reasons[c.reason] || 0) + 1; });
                
                content.innerHTML = `
                    <div class="grid grid-cols-4 gap-3 mb-6">
                        ${Object.entries(reasons).map(([reason, count]) => `
                            <div class="bg-red-50 rounded-xl p-3 text-center">
                                <p class="text-xl font-bold text-red-600">${count.toLocaleString()}</p>
                                <p class="text-xs text-slate-500">${getReasonText(reason)}</p>
                            </div>
                        `).join('')}
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-50"><tr>
                                <th class="px-4 py-3 text-right font-semibold">×©×</th>
                                <th class="px-4 py-3 text-right font-semibold">×˜×œ×¤×•×Ÿ ××§×•×¨×™</th>
                                <th class="px-4 py-3 text-right font-semibold">×¡×™×‘×ª ×“×—×™×™×”</th>
                                <th class="px-4 py-3 text-right font-semibold">××§×•×¨</th>
                            </tr></thead>
                            <tbody>${(data.rejectedContacts || []).slice(0, 100).map(c => `
                                <tr class="border-b border-slate-100">
                                    <td class="px-4 py-2">${c.name}</td>
                                    <td class="px-4 py-2 font-mono text-slate-600">${c.phone || '(×¨×™×§)'}</td>
                                    <td class="px-4 py-2"><span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs">${getReasonText(c.reason)}</span></td>
                                    <td class="px-4 py-2 text-slate-400 text-sm">${c.sourceFile || ''}</td>
                                </tr>
                            `).join('')}</tbody>
                        </table>
                        ${data.rejectedContacts?.length > 100 ? `<p class="text-center text-slate-400 mt-4">××¦×™×’ 100 ××ª×•×š ${data.rejectedContacts.length}</p>` : ''}
                    </div>
                `;
            } else if (tab === 'conflicts') {
                content.innerHTML = (data.conflicts || []).length ? `
                    <div class="space-y-4">
                        ${(data.conflicts || []).map((c, i) => `
                            <div class="bg-amber-50 rounded-xl p-4">
                                <p class="font-mono text-lg font-bold text-slate-700 mb-3">${c.phone}</p>
                                <div class="flex flex-wrap gap-2">
                                    ${c.names.map(name => `
                                        <button onclick="resolveConflict('${c.phone}', '${name.replace(/'/g, "\\'")}', this)" 
                                                class="px-4 py-2 bg-white rounded-lg border-2 border-slate-200 font-medium hover:border-indigo-500 hover:bg-indigo-50 transition-all">
                                            ${name}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : '<p class="text-center text-slate-400 py-8">××™×Ÿ ×§×•× ×¤×œ×™×§×˜×™× ğŸ‰</p>';
            } else if (tab === 'duplicates') {
                content.innerHTML = (data.autoResolved || []).length ? `
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-50"><tr>
                                <th class="px-4 py-3 text-right font-semibold">×˜×œ×¤×•×Ÿ</th>
                                <th class="px-4 py-3 text-right font-semibold">×©× ×©× ×‘×—×¨</th>
                                <th class="px-4 py-3 text-right font-semibold">××•×¤×¢×™×</th>
                            </tr></thead>
                            <tbody>${(data.autoResolved || []).map(c => `
                                <tr class="border-b border-slate-100">
                                    <td class="px-4 py-2 font-mono">${c.phone}</td>
                                    <td class="px-4 py-2">${c.name}</td>
                                    <td class="px-4 py-2 text-slate-500">${c.count || 2} ×¤×¢××™×</td>
                                </tr>
                            `).join('')}</tbody>
                        </table>
                    </div>
                ` : '<p class="text-center text-slate-400 py-8">×œ× × ××¦××• ×›×¤×™×œ×•×™×•×ª</p>';
            }
        }

        function getReasonText(reason) {
            const reasons = {
                'empty_phone': '×˜×œ×¤×•×Ÿ ×¨×™×§',
                'too_short': '×§×¦×¨ ××“×™',
                'too_long': '××¨×•×š ××“×™',
                'invalid_phone': '×œ× ×ª×§×™×Ÿ'
            };
            return reasons[reason] || reason;
        }

        async function resolveConflict(phone, name, btn) {
            document.querySelectorAll(`button[onclick*="${phone}"]`).forEach(b => {
                b.classList.remove('border-indigo-500', 'bg-indigo-100');
            });
            btn.classList.add('border-indigo-500', 'bg-indigo-100');
            
            await api('/api/resolve', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phone, name })
            });
            
            Toast.fire({ icon: 'success', title: '×”×‘×—×™×¨×” × ×©××¨×”' });
        }

        async function finalizeGroup() {
            const data = state.analysisData;
            if (!data) return;
            
            Swal.fire({ title: '×©×•××¨ ×¨×©×™××”...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            
            try {
                const result = await api('/api/finalize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        groupId: data.groupId,
                        groupName: data.targetGroupName,
                        contacts: data.allData,
                        fileIds: data.fileIds,
                        stats: data.stats
                    })
                });
                
                Swal.fire({ 
                    icon: 'success', 
                    title: '×”×¨×©×™××” × ×©××¨×”!', 
                    text: `${result.contactsCount?.toLocaleString() || 0} ×× ×©×™ ×§×©×¨ × ×©××¨×•`,
                    confirmButtonText: '×¦×¤×” ×‘×¨×©×™××”'
                }).then(() => {
                    state.selectedFiles = [];
                    state.analysisData = null;
                    viewGroup(data.groupId);
                });
                
            } catch (err) {
                Swal.fire({ icon: 'error', title: '×©×’×™××”', text: err.message });
            }
        }

        // ==================== ADD TO GROUP ====================
        async function addFilesToGroup() {
            // TODO: implement add files to existing group
            Toast.fire({ icon: 'info', title: '×¤×™×¦\'×¨ ×‘×¤×™×ª×•×—' });
        }

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', async () => {
            // Check auth on load
            try {
                const res = await fetch('/api/groups');
                if (res.status === 401) {
                    window.location.href = '/login';
                    return;
                }
            } catch (e) {
                // Network error - might be ok
            }
            showView('dashboard');
        });
    </script>
</body>
</html>
