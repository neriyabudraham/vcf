<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¢×¨×™×›×ª ×¨×©×™××ª ×× ×©×™ ×§×©×¨ | VCF Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Heebo', sans-serif; }
        body { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); min-height: 100vh; }
        .glass-card { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.8); box-shadow: 0 8px 32px rgba(0,0,0,0.08); }
        .btn-primary { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .tab-active { border-color: #6366f1; color: #6366f1; background: #eef2ff; }
    </style>
</head>
<body class="text-slate-800 p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="glass-card rounded-3xl p-6 mb-6">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <div>
                    <h1 id="groupName" class="text-2xl md:text-3xl font-black text-slate-800">×˜×•×¢×Ÿ...</h1>
                    <p id="groupInfo" class="text-slate-500"></p>
                </div>
                <div class="flex gap-3 flex-wrap">
                    <button onclick="showSettings()" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-xl font-semibold hover:bg-slate-200">âš™ï¸ ×”×’×“×¨×•×ª</button>
                    <button onclick="finalizeGroup()" class="btn-success px-6 py-3 rounded-xl font-bold shadow-lg">âœ… ×©××•×¨ ×•×¡×™×™×</button>
                    <button onclick="downloadVcf()" class="btn-primary px-6 py-3 rounded-xl font-bold shadow-lg">ğŸ“¥ ×”×•×¨×“ VCF</button>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6" id="statsContainer"></div>

        <!-- Tabs -->
        <div class="glass-card rounded-2xl overflow-hidden">
            <div class="flex border-b border-slate-200">
                <button onclick="showTab('accepted')" class="tab-btn flex-1 px-6 py-4 font-semibold text-slate-600 hover:bg-slate-50 border-b-2 border-transparent" data-tab="accepted">
                    âœ… ××•×©×¨×• (<span id="acceptedCount">0</span>)
                </button>
                <button onclick="showTab('rejected')" class="tab-btn flex-1 px-6 py-4 font-semibold text-slate-600 hover:bg-slate-50 border-b-2 border-transparent" data-tab="rejected">
                    âŒ × ×“×—×• (<span id="rejectedCount">0</span>)
                </button>
                <button onclick="showTab('conflicts')" class="tab-btn flex-1 px-6 py-4 font-semibold text-slate-600 hover:bg-slate-50 border-b-2 border-transparent" data-tab="conflicts">
                    âš ï¸ ×§×•× ×¤×œ×™×§×˜×™× (<span id="conflictsCount">0</span>)
                </button>
                <button onclick="showTab('duplicates')" class="tab-btn flex-1 px-6 py-4 font-semibold text-slate-600 hover:bg-slate-50 border-b-2 border-transparent" data-tab="duplicates">
                    ğŸ”„ ×›×¤×™×œ×•×™×•×ª (<span id="duplicatesCount">0</span>)
                </button>
            </div>
            
            <div id="tabContent" class="p-6 max-h-[60vh] overflow-auto"></div>
        </div>

        <!-- Pagination -->
        <div class="flex justify-center items-center gap-4 mt-4" id="pagination"></div>

        <!-- Footer -->
        <div class="text-center mt-6 text-slate-400 text-sm">
            Powered by VCF Manager Pro
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="glass-card rounded-3xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">âš™ï¸ ×”×’×“×¨×•×ª ××¢×¨×›×ª</h2>
                <button onclick="closeSettings()" class="text-3xl text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            
            <!-- ×›×œ×œ×™ ×‘×—×™×¨×ª ×©××•×ª ××•×˜×•××˜×™×ª -->
            <div class="mb-8">
                <h3 class="text-xl font-bold text-slate-700 mb-4">ğŸ¯ ×›×œ×œ×™ ×‘×—×™×¨×ª ×©××•×ª ××•×˜×•××˜×™×ª</h3>
                <p class="text-slate-500 mb-4">×”×’×“×¨ ×›×™×¦×“ ×”××¢×¨×›×ª ×ª×‘×—×¨ ××•×˜×•××˜×™×ª ××ª ×”×©× ×”×˜×•×‘ ×‘×™×•×ª×¨ ×›×©×™×© ×›×¤×™×œ×•×™×•×ª</p>
                
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4" id="nameRulesForm">
                    <label class="flex items-center gap-3 p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                        <input type="checkbox" id="rule-preferLonger" checked class="w-5 h-5 accent-indigo-600">
                        <span>×”×¢×“×£ ×©× ××¨×•×š ×™×•×ª×¨</span>
                    </label>
                    <label class="flex items-center gap-3 p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                        <input type="checkbox" id="rule-preferHebrew" checked class="w-5 h-5 accent-indigo-600">
                        <span>×”×¢×“×£ ×¢×‘×¨×™×ª</span>
                    </label>
                    <label class="flex items-center gap-3 p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                        <input type="checkbox" id="rule-avoidSpecialChars" checked class="w-5 h-5 accent-indigo-600">
                        <span>×”×™×× ×¢ ××¡×™×× ×™× ××™×•×—×“×™×</span>
                    </label>
                    <label class="flex items-center gap-3 p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100">
                        <input type="checkbox" id="rule-preferNoNumbers" checked class="w-5 h-5 accent-indigo-600">
                        <span>×”×¢×“×£ ×©××•×ª ×‘×œ×™ ××¡×¤×¨×™×</span>
                    </label>
                    <div class="flex items-center gap-3 p-4 bg-slate-50 rounded-xl">
                        <span>××•×¨×š ××™× ×™××œ×™:</span>
                        <input type="number" id="rule-minLength" value="2" min="0" class="w-20 px-3 py-2 rounded-lg border border-slate-200">
                        <span class="text-xs text-slate-400">(××•×ª×™×•×ª ×‘×œ×‘×“)</span>
                    </div>
                    <div class="flex items-center gap-3 p-4 bg-slate-50 rounded-xl">
                        <span>××•×¨×š ××§×¡×™××œ×™:</span>
                        <input type="number" id="rule-maxLength" value="20" class="w-20 px-3 py-2 rounded-lg border border-slate-200">
                    </div>
                </div>
                
                <p class="text-sm text-slate-500 mt-2">ğŸ’¡ ××•×¨×š ××™× ×™××œ×™ ×¡×•×¤×¨ ×¨×§ ××•×ª×™×•×ª (×¢×‘×¨×™×ª/×× ×’×œ×™×ª), ×œ× × ×§×•×“×•×ª, ×’×¨×©×™×™× ××• ××™××•×’'×™×</p>
            </div>
            
            <!-- ×©××•×ª ×œ× ×ª×§×™× ×™× (Blacklist) -->
            <div class="mb-8">
                <h3 class="text-xl font-bold text-slate-700 mb-4">ğŸš« ×©××•×ª ×œ× ×ª×§×™× ×™× (Blacklist)</h3>
                <p class="text-slate-500 mb-4">×©××•×ª ××œ×• ×™×•×—×œ×¤×• ××•×˜×•××˜×™×ª ×‘×©× ×‘×¨×™×¨×ª ××—×“×œ</p>
                
                <div class="flex gap-3 mb-4">
                    <input type="text" id="newInvalidName" placeholder="×”×–×Ÿ ×©× ×œ× ×ª×§×™×Ÿ..." class="flex-1 px-4 py-3 rounded-xl border border-slate-200">
                    <select id="newInvalidPattern" class="px-4 py-3 rounded-xl border border-slate-200">
                        <option value="exact">×”×ª×××” ××“×•×™×§×ª</option>
                        <option value="contains">××›×™×œ</option>
                        <option value="regex">×‘×™×˜×•×™ ×¨×’×•×œ×¨×™</option>
                    </select>
                    <button onclick="addInvalidName()" class="px-6 py-3 bg-red-100 text-red-700 rounded-xl font-bold hover:bg-red-200">â• ×”×•×¡×£</button>
                </div>
                
                <div id="invalidNamesList" class="grid grid-cols-2 md:grid-cols-4 gap-2 max-h-48 overflow-auto"></div>
            </div>
            
            <!-- ×›×œ×œ×™ × ×™×§×•×™ ×©××•×ª -->
            <div class="mb-8">
                <h3 class="text-xl font-bold text-slate-700 mb-4">ğŸ§¹ ×›×œ×œ×™ × ×™×§×•×™ ×©××•×ª</h3>
                <p class="text-slate-500 mb-4">×›×œ×œ×™× ××•×˜×•××˜×™×™× ×œ× ×™×§×•×™ ×•×¡×™×“×•×¨ ×©××•×ª ×‘×¢×ª ×”×™×™×‘×•×</p>
                
                <div id="cleaningRulesList" class="space-y-2 mb-4"></div>
                
                <div class="border-t border-slate-200 pt-4 mt-4">
                    <h4 class="font-semibold text-slate-600 mb-3">â• ×”×•×¡×£ ×›×œ×œ ×—×“×©</h4>
                    <div class="flex flex-wrap gap-3">
                        <select id="newRuleType" class="px-4 py-3 rounded-xl border border-slate-200" onchange="updateRuleInputs()">
                            <option value="trim_start">×”×¡×¨ ××ª×—×™×œ×ª ×”×©×</option>
                            <option value="trim_end">×”×¡×¨ ××¡×•×£ ×”×©×</option>
                            <option value="replace">×”×—×œ×£ ×˜×§×¡×˜</option>
                            <option value="regex">×‘×™×˜×•×™ ×¨×’×•×œ×¨×™</option>
                        </select>
                        <input type="text" id="newRulePattern" placeholder="×ª×•/×˜×§×¡×˜ ×œ×”×¡×¨×”..." class="px-4 py-3 rounded-xl border border-slate-200 flex-1">
                        <input type="text" id="newRuleReplacement" placeholder="×œ×”×—×œ×™×£ ×‘..." class="px-4 py-3 rounded-xl border border-slate-200 hidden">
                        <input type="text" id="newRuleDesc" placeholder="×ª×™××•×¨ ×”×›×œ×œ..." class="px-4 py-3 rounded-xl border border-slate-200 w-48">
                        <button onclick="addCleaningRule()" class="px-6 py-3 bg-indigo-100 text-indigo-700 rounded-xl font-bold hover:bg-indigo-200">â• ×”×•×¡×£</button>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
                <button onclick="closeSettings()" class="px-6 py-3 bg-slate-100 text-slate-700 rounded-xl font-semibold hover:bg-slate-200">×‘×™×˜×•×œ</button>
                <button onclick="saveSettings()" class="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700">ğŸ’¾ ×©××•×¨ ×•×”×—×œ</button>
            </div>
        </div>
    </div>

    <script>
        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2500, timerProgressBar: true });
        
        const token = window.location.pathname.split('/').pop();
        let state = {
            data: null,
            currentTab: 'accepted',
            page: 1,
            perPage: 500,
            settings: {
                cleaningRules: [],
                nameRules: {},
                invalidNames: []
            }
        };
        
        // ×˜×¢×™× ×ª ×”× ×ª×•× ×™×
        async function loadData() {
            try {
                Swal.fire({ title: '×˜×•×¢×Ÿ × ×ª×•× ×™×...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                
                const res = await fetch(`/api/public/full-data/${token}`);
                if (!res.ok) {
                    Swal.close();
                    document.body.innerHTML = '<div class="min-h-screen flex items-center justify-center text-2xl text-slate-500">×”×§×™×©×•×¨ ×œ× × ××¦× ××• ×©××™×Ÿ ×”×¨×©××” ×œ×ª×¦×•×’×” ××œ××”</div>';
                    return;
                }
                
                state.data = await res.json();
                
                // ×˜×¢×Ÿ ×”×’×“×¨×•×ª
                const settingsRes = await fetch(`/api/public/settings/${token}`);
                if (settingsRes.ok) {
                    state.settings = await settingsRes.json();
                }
                
                Swal.close();
                renderUI();
            } catch (err) {
                Swal.fire({ icon: 'error', title: '×©×’×™××”', text: err.message });
            }
        }
        
        function renderUI() {
            document.getElementById('groupName').textContent = state.data.targetGroupName;
            document.getElementById('groupInfo').textContent = `${state.data.allData?.length || 0} ×× ×©×™ ×§×©×¨`;
            
            // Stats
            const conflictCount = state.data.conflicts?.length || 0;
            const approvedCount = state.data.allData?.length || 0;
            const approvedWithoutConflict = approvedCount - conflictCount;
            
            document.getElementById('statsContainer').innerHTML = `
                <div class="glass-card rounded-xl p-4 text-center">
                    <p class="text-2xl font-black text-slate-700">${(state.data.stats?.totalParsed || approvedCount).toLocaleString()}</p>
                    <p class="text-sm text-slate-500">× ×§×¨××•</p>
                </div>
                <div class="glass-card rounded-xl p-4 text-center cursor-help" title="×›×œ ×× ×©×™ ×”×§×©×¨ ×”×™×™×—×•×“×™×™×">
                    <p class="text-2xl font-black text-green-600">${approvedCount.toLocaleString()}</p>
                    <p class="text-sm text-slate-500">×¡×”"×› ×× ×©×™ ×§×©×¨</p>
                    <p class="text-xs text-green-500 mt-1">${approvedWithoutConflict.toLocaleString()} ×œ×œ× ×§×•× ×¤×œ×™×§×˜</p>
                </div>
                <div class="glass-card rounded-xl p-4 text-center">
                    <p class="text-2xl font-black text-red-600">${(state.data.rejectedContacts?.length || 0).toLocaleString()}</p>
                    <p class="text-sm text-slate-500">× ×“×—×•</p>
                </div>
                <div class="glass-card rounded-xl p-4 text-center cursor-help" title="×›×œ×•×œ×™× ×‘×¡×”&quot;×›">
                    <p class="text-2xl font-black text-amber-600">${conflictCount.toLocaleString()}</p>
                    <p class="text-sm text-slate-500">×§×•× ×¤×œ×™×§×˜×™×</p>
                </div>
                <div class="glass-card rounded-xl p-4 text-center">
                    <p class="text-2xl font-black text-blue-600">${(state.data.autoResolved?.length || 0).toLocaleString()}</p>
                    <p class="text-sm text-slate-500">×›×¤×™×œ×•×™×•×ª</p>
                </div>
            `;
            
            // Tab counts
            document.getElementById('acceptedCount').textContent = (state.data.allData?.length || 0).toLocaleString();
            document.getElementById('rejectedCount').textContent = (state.data.rejectedContacts?.length || 0).toLocaleString();
            document.getElementById('conflictsCount').textContent = (state.data.conflicts?.length || 0).toLocaleString();
            document.getElementById('duplicatesCount').textContent = (state.data.autoResolved?.length || 0).toLocaleString();
            
            showTab('accepted');
        }
        
        function showTab(tab) {
            state.currentTab = tab;
            state.page = 1;
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active');
                if (btn.dataset.tab === tab) btn.classList.add('tab-active');
            });
            
            renderTabContent();
        }
        
        function renderTabContent() {
            const content = document.getElementById('tabContent');
            const pagination = document.getElementById('pagination');
            
            if (state.currentTab === 'accepted') {
                const items = state.data.allData || [];
                const totalPages = Math.ceil(items.length / state.perPage);
                const start = (state.page - 1) * state.perPage;
                const pageItems = items.slice(start, start + state.perPage);
                
                content.innerHTML = `
                    <p class="text-sm text-slate-500 mb-4">××¦×™×’ ${start + 1}-${Math.min(start + state.perPage, items.length)} ××ª×•×š ${items.length.toLocaleString()} ×× ×©×™ ×§×©×¨</p>
                    <table class="w-full text-sm">
                        <thead class="bg-slate-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-right">#</th>
                                <th class="px-4 py-2 text-right">×©×</th>
                                <th class="px-4 py-2 text-right">×˜×œ×¤×•×Ÿ</th>
                                <th class="px-4 py-2 text-right">××§×•×¨</th>
                                <th class="px-4 py-2 w-12"></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${pageItems.map((c, i) => `
                                <tr class="border-b border-slate-100">
                                    <td class="px-4 py-1 text-slate-400">${start + i + 1}</td>
                                    <td class="px-4 py-1">
                                        <input type="text" value="${(c.name || '').replace(/"/g, '&quot;')}"
                                               class="w-full px-2 py-1 rounded border border-transparent hover:border-slate-300 focus:border-indigo-500 outline-none font-medium bg-transparent"
                                               onchange="updateName(${start + i}, this.value)">
                                    </td>
                                    <td class="px-4 py-1 text-slate-600">${c.phone}</td>
                                    <td class="px-4 py-1 text-slate-400 text-xs truncate max-w-[150px]">${c.sourceFile || ''}</td>
                                    <td class="px-4 py-1">
                                        <button onclick="clearName(${start + i})" class="text-red-400 hover:text-red-600">ğŸ—‘ï¸</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                pagination.innerHTML = totalPages > 1 ? `
                    <button onclick="changePage(${state.page - 1})" ${state.page === 1 ? 'disabled' : ''} 
                            class="px-4 py-2 bg-slate-100 rounded-lg disabled:opacity-50">â—€ ×”×§×•×“×</button>
                    <span>×¢××•×“ ${state.page} / ${totalPages}</span>
                    <button onclick="changePage(${state.page + 1})" ${state.page === totalPages ? 'disabled' : ''} 
                            class="px-4 py-2 bg-slate-100 rounded-lg disabled:opacity-50">×”×‘× â–¶</button>
                ` : '';
                
            } else if (state.currentTab === 'rejected') {
                const items = state.data.rejectedContacts || [];
                content.innerHTML = `
                    <p class="text-sm text-slate-500 mb-4">${items.length.toLocaleString()} ×× ×©×™ ×§×©×¨ × ×“×—×•</p>
                    <table class="w-full text-sm">
                        <thead class="bg-slate-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-right">×©×</th>
                                <th class="px-4 py-2 text-right">×˜×œ×¤×•×Ÿ</th>
                                <th class="px-4 py-2 text-right">×¡×™×‘×”</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.slice(0, 100).map(c => `
                                <tr class="border-b border-slate-100">
                                    <td class="px-4 py-2">${c.name || '(×œ×œ× ×©×)'}</td>
                                    <td class="px-4 py-2 text-slate-600">${c.phone || ''}</td>
                                    <td class="px-4 py-2 text-red-500 text-xs">${getReasonText(c.reason)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                pagination.innerHTML = '';
                
            } else if (state.currentTab === 'conflicts') {
                const items = state.data.conflicts || [];
                content.innerHTML = items.length ? `
                    <p class="text-sm text-slate-500 mb-4">${items.length.toLocaleString()} ×§×•× ×¤×œ×™×§×˜×™× - ×‘×—×¨ ××ª ×”×©× ×”× ×›×•×Ÿ</p>
                    <div class="space-y-4">
                        ${items.map((c, idx) => `
                            <div class="bg-slate-50 rounded-xl p-4">
                                <p class="text-xs text-slate-400 mb-2">ğŸ“ ${c.phone}</p>
                                <div class="flex flex-wrap gap-2">
                                    ${c.names.map((name, i) => `
                                        <button onclick="resolveConflict('${c.phone}', '${name.replace(/'/g, "\\'")}')" 
                                                class="px-4 py-2 rounded-lg font-medium transition ${c.autoSelected === name ? 'bg-indigo-600 text-white' : 'bg-white border hover:border-indigo-400'}">
                                            ${name}
                                            <span class="text-xs opacity-70">(${Math.round(c.scores?.[i] || 0)})</span>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : '<p class="text-slate-400 text-center py-8">××™×Ÿ ×§×•× ×¤×œ×™×§×˜×™×</p>';
                pagination.innerHTML = '';
                
            } else if (state.currentTab === 'duplicates') {
                const items = state.data.autoResolved || [];
                content.innerHTML = items.length ? `
                    <p class="text-sm text-slate-500 mb-4">${items.length.toLocaleString()} ××§×¨×™× ×©×œ ×©× ×“×•××” - × ×‘×—×¨ ×”×˜×•×‘ ×‘×™×•×ª×¨ ××•×˜×•××˜×™×ª</p>
                    <table class="w-full text-sm">
                        <thead class="bg-slate-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-right">×˜×œ×¤×•×Ÿ</th>
                                <th class="px-4 py-2 text-right">×©× ×©× ×‘×—×¨</th>
                                <th class="px-4 py-2 text-right">×›×¤×™×œ×•×™×•×ª</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.slice(0, 200).map(c => `
                                <tr class="border-b border-slate-100">
                                    <td class="px-4 py-2 text-slate-600">${c.phone}</td>
                                    <td class="px-4 py-2 font-medium text-green-600">${c.name}</td>
                                    <td class="px-4 py-2 text-slate-400">${c.count || 2}x</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p class="text-slate-400 text-center py-8">××™×Ÿ ×›×¤×™×œ×•×™×•×ª</p>';
                pagination.innerHTML = '';
            }
        }
        
        function getReasonText(reason) {
            const reasons = {
                'empty_phone': '×˜×œ×¤×•×Ÿ ×¨×™×§',
                'too_short': '×˜×œ×¤×•×Ÿ ×§×¦×¨ ××“×™',
                'too_long': '×˜×œ×¤×•×Ÿ ××¨×•×š ××“×™'
            };
            return reasons[reason] || reason;
        }
        
        function changePage(page) {
            state.page = page;
            renderTabContent();
        }
        
        async function updateName(index, newName) {
            if (!state.data?.allData?.[index]) return;
            
            const contact = state.data.allData[index];
            const oldName = contact.name;
            
            if (!newName || !newName.trim()) {
                // ××—×™×§×ª ×©×
                await clearName(index);
                return;
            }
            
            contact.name = newName.trim();
            scheduleSave();
            Toast.fire({ icon: 'success', title: '×”×©× ×¢×•×“×›×Ÿ' });
        }
        
        async function clearName(index) {
            if (!state.data?.allData?.[index]) return;
            
            const contact = state.data.allData[index];
            const oldName = contact.name;
            const baseName = oldName?.replace(/\s?\(\d+\)$/g, '').trim();
            
            // ×©× ×“×™×¤×•×œ×˜×™×‘×™
            contact.name = `××™×© ×§×©×¨ ${contact.phone.slice(-4)}`;
            
            // ×”×•×¡×£ ×œ×¨×©×™××” ×©×—×•×¨×”
            if (baseName && !baseName.startsWith('××™×© ×§×©×¨')) {
                await fetch(`/api/public/invalid-names/${token}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: baseName, patternType: 'exact' })
                });
                
                // ×¢×“×›×Ÿ ×’× ××—×¨×™× ×¢× ××•×ª×• ×©×
                let count = 1;
                state.data.allData.forEach((c, i) => {
                    if (i !== index) {
                        const cBase = c.name?.replace(/\s?\(\d+\)$/g, '').trim();
                        if (cBase === baseName) {
                            c.name = `××™×© ×§×©×¨ ${c.phone.slice(-4)}`;
                            count++;
                        }
                    }
                });
                
                Toast.fire({ icon: 'success', title: `×¢×•×“×›× ×• ${count} ×× ×©×™ ×§×©×¨, "${baseName}" × ×•×¡×£ ×œ×¨×©×™××” ×”×©×—×•×¨×”` });
            }
            
            scheduleSave();
            renderTabContent();
        }
        
        async function resolveConflict(phone, name) {
            const conflict = state.data.conflicts?.find(c => c.phone === phone);
            if (conflict) {
                conflict.autoSelected = name;
                
                // ×¢×“×›×Ÿ ×’× ×‘-allData
                const contact = state.data.allData?.find(c => c.phone === phone);
                if (contact) contact.name = name;
            }
            
            scheduleSave();
            renderTabContent();
            Toast.fire({ icon: 'success', title: `× ×‘×—×¨: ${name}` });
        }
        
        // ×©××™×¨×” ××•×˜×•××˜×™×ª
        let saveTimeout = null;
        function scheduleSave() {
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveDraft, 1000);
        }
        
        async function saveDraft() {
            try {
                await fetch(`/api/public/save-draft/${token}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        allData: state.data.allData,
                        conflicts: state.data.conflicts,
                        autoResolved: state.data.autoResolved,
                        rejectedContacts: state.data.rejectedContacts,
                        stats: state.data.stats
                    })
                });
                console.log('Draft saved');
            } catch (err) {
                console.error('Save error:', err);
            }
        }
        
        // ==================== ×”×’×“×¨×•×ª ====================
        function showSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('settingsModal').classList.add('flex');
            
            // ×˜×¢×Ÿ ×›×œ×œ×™ ×‘×—×™×¨×ª ×©××•×ª
            const rules = state.settings.nameRules || {};
            document.getElementById('rule-preferLonger').checked = rules.preferLonger !== false;
            document.getElementById('rule-preferHebrew').checked = rules.preferHebrew !== false;
            document.getElementById('rule-avoidSpecialChars').checked = rules.avoidSpecialChars !== false;
            document.getElementById('rule-preferNoNumbers').checked = rules.preferNoNumbers !== false;
            document.getElementById('rule-minLength').value = rules.minLength || 2;
            document.getElementById('rule-maxLength').value = rules.maxLength || 20;
            
            // ×¨×™× ×“×•×¨ ×›×œ×œ×™ × ×™×§×•×™
            renderCleaningRules();
            
            // ×¨×™× ×“×•×¨ ×©××•×ª ××¡×•×¨×™×
            renderInvalidNames();
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
            document.getElementById('settingsModal').classList.remove('flex');
        }
        
        // ×›×œ×œ×™ × ×™×§×•×™
        const ruleTypeLabels = {
            'trim_start': '×”×¡×¨ ××ª×—×™×œ×ª ×”×©×',
            'trim_end': '×”×¡×¨ ××¡×•×£ ×”×©×',
            'replace': '×”×—×œ×£',
            'regex': '×‘×™×˜×•×™ ×¨×’×•×œ×¨×™'
        };
        
        function renderCleaningRules() {
            const rules = state.settings.cleaningRules || [];
            document.getElementById('cleaningRulesList').innerHTML = rules.map((rule, idx) => `
                <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl ${!rule.enabled ? 'opacity-50' : ''}">
                    <input type="checkbox" ${rule.enabled ? 'checked' : ''} 
                           onchange="toggleCleaningRule(${idx})" 
                           class="w-5 h-5 accent-indigo-600">
                    <span class="text-xs px-2 py-1 bg-indigo-100 text-indigo-700 rounded">${ruleTypeLabels[rule.type] || rule.type}</span>
                    <code class="text-sm bg-slate-200 px-2 py-1 rounded">"${rule.pattern}"</code>
                    ${rule.type === 'replace' || rule.type === 'regex' ? `<span class="text-slate-400">â†’</span><code class="text-sm bg-green-100 px-2 py-1 rounded">"${rule.replacement || ''}"</code>` : ''}
                    <span class="flex-1 text-slate-600 text-sm">${rule.description || ''}</span>
                    <button onclick="deleteCleaningRule(${idx})" class="text-red-400 hover:text-red-600 text-lg">âœ•</button>
                </div>
            `).join('') || '<p class="text-slate-400 text-center py-4">××™×Ÿ ×›×œ×œ×™ × ×™×§×•×™ ××•×’×“×¨×™×</p>';
        }
        
        function toggleCleaningRule(idx) {
            if (state.settings.cleaningRules[idx]) {
                state.settings.cleaningRules[idx].enabled = !state.settings.cleaningRules[idx].enabled;
                renderCleaningRules();
            }
        }
        
        function deleteCleaningRule(idx) {
            state.settings.cleaningRules.splice(idx, 1);
            renderCleaningRules();
            Toast.fire({ icon: 'success', title: '×”×›×œ×œ × ××—×§' });
        }
        
        function addCleaningRule() {
            const type = document.getElementById('newRuleType').value;
            const pattern = document.getElementById('newRulePattern').value;
            const replacement = document.getElementById('newRuleReplacement').value;
            const description = document.getElementById('newRuleDesc').value;
            
            if (!pattern) return Toast.fire({ icon: 'error', title: '×”×–×Ÿ ×ª×• ××• ×˜×§×¡×˜' });
            
            const newRule = {
                id: Date.now(),
                type,
                pattern,
                replacement: (type === 'replace' || type === 'regex') ? replacement : undefined,
                description,
                enabled: true
            };
            
            state.settings.cleaningRules = state.settings.cleaningRules || [];
            state.settings.cleaningRules.push(newRule);
            renderCleaningRules();
            
            // × ×§×” ×©×“×•×ª
            document.getElementById('newRulePattern').value = '';
            document.getElementById('newRuleReplacement').value = '';
            document.getElementById('newRuleDesc').value = '';
            
            Toast.fire({ icon: 'success', title: '×”×›×œ×œ × ×•×¡×£' });
        }
        
        function updateRuleInputs() {
            const type = document.getElementById('newRuleType').value;
            const replacementInput = document.getElementById('newRuleReplacement');
            const patternInput = document.getElementById('newRulePattern');
            
            if (type === 'replace' || type === 'regex') {
                replacementInput.classList.remove('hidden');
                patternInput.placeholder = type === 'regex' ? '×‘×™×˜×•×™ ×¨×’×•×œ×¨×™...' : '×˜×§×¡×˜ ×œ××¦×™××”...';
            } else {
                replacementInput.classList.add('hidden');
                patternInput.placeholder = type === 'trim_start' ? '×ª×• ×œ×”×¡×¨×” ××”×”×ª×—×œ×”...' : '×ª×• ×œ×”×¡×¨×” ××”×¡×•×£...';
            }
        }
        
        // ×©××•×ª ××¡×•×¨×™×
        function renderInvalidNames() {
            const names = state.settings.invalidNames || [];
            const patternLabels = { 'exact': '××“×•×™×§', 'contains': '××›×™×œ', 'regex': '×¨×’×•×œ×¨×™' };
            
            document.getElementById('invalidNamesList').innerHTML = names.map(n => `
                <div class="flex items-center justify-between bg-red-50 border border-red-200 rounded-xl px-4 py-2">
                    <span class="font-medium text-red-700">${n.name}</span>
                    <span class="text-xs text-red-400 mx-2">(${patternLabels[n.pattern_type] || n.pattern_type})</span>
                </div>
            `).join('') || '<p class="text-slate-400 text-center col-span-4 py-4">××™×Ÿ ×©××•×ª ××¡×•×¨×™×</p>';
        }
        
        async function addInvalidName() {
            const input = document.getElementById('newInvalidName');
            const patternSelect = document.getElementById('newInvalidPattern');
            const name = input.value.trim();
            const patternType = patternSelect.value;
            
            if (!name) return Toast.fire({ icon: 'error', title: '×”×–×Ÿ ×©×' });
            
            try {
                await fetch(`/api/public/invalid-names/${token}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, patternType })
                });
                
                state.settings.invalidNames = state.settings.invalidNames || [];
                state.settings.invalidNames.push({ name, pattern_type: patternType });
                input.value = '';
                renderInvalidNames();
                Toast.fire({ icon: 'success', title: '×”×©× × ×•×¡×£ ×œ×¨×©×™××” ×”×©×—×•×¨×”' });
            } catch (err) {
                Toast.fire({ icon: 'error', title: '×©×’×™××” ×‘×”×•×¡×¤×”' });
            }
        }
        
        async function saveSettings() {
            try {
                Swal.fire({ title: '×©×•××¨ ×”×’×“×¨×•×ª...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                
                const nameRules = {
                    preferLonger: document.getElementById('rule-preferLonger').checked,
                    preferHebrew: document.getElementById('rule-preferHebrew').checked,
                    avoidSpecialChars: document.getElementById('rule-avoidSpecialChars').checked,
                    preferNoNumbers: document.getElementById('rule-preferNoNumbers').checked,
                    minLength: parseInt(document.getElementById('rule-minLength').value) || 2,
                    maxLength: parseInt(document.getElementById('rule-maxLength').value) || 20,
                    allowedChars: ["'", '"', "-", " "]
                };
                
                await fetch(`/api/public/settings/${token}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nameRules,
                        cleaningRules: state.settings.cleaningRules
                    })
                });
                
                state.settings.nameRules = nameRules;
                
                Swal.close();
                closeSettings();
                Toast.fire({ icon: 'success', title: '×”×”×’×“×¨×•×ª × ×©××¨×•' });
            } catch (err) {
                Swal.fire({ icon: 'error', title: '×©×’×™××”', text: err.message });
            }
        }
        
        // ×¡×™×•×
        async function finalizeGroup() {
            const result = await Swal.fire({
                title: '×œ×¡×™×™× ×•×œ×©××•×¨?',
                text: `${state.data.allData?.length || 0} ×× ×©×™ ×§×©×¨ ×™×™×©××¨×•`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'âœ… ×©××•×¨ ×•×¡×™×™×',
                cancelButtonText: '×‘×™×˜×•×œ'
            });
            
            if (!result.isConfirmed) return;
            
            Swal.fire({ title: '×©×•××¨...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            
            try {
                const res = await fetch(`/api/public/finalize/${token}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contacts: state.data.allData,
                        stats: state.data.stats,
                        analysisData: {
                            conflicts: state.data.conflicts,
                            autoResolved: state.data.autoResolved,
                            rejectedContacts: state.data.rejectedContacts
                        }
                    })
                });
                
                const data = await res.json();
                
                Swal.fire({
                    icon: 'success',
                    title: '×”×¨×©×™××” × ×©××¨×”!',
                    text: `${data.contactsCount?.toLocaleString() || 0} ×× ×©×™ ×§×©×¨ × ×©××¨×• ×‘×”×¦×œ×—×”`,
                    confirmButtonText: '××¢×•×œ×”!'
                });
            } catch (err) {
                Swal.fire({ icon: 'error', title: '×©×’×™××”', text: err.message });
            }
        }
        
        function downloadVcf() {
            window.location.href = `/api/public/export/${token}`;
        }
        
        // ×”×ª×—×œ
        loadData();
    </script>
</body>
</html>
